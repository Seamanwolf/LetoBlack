# Руководство по миграции базы данных

Этот документ содержит инструкции по миграции базы данных со старой структуры на новую.

## Предварительные требования

- Python 3.6 или выше
- Библиотеки Python:
  - pymysql
  - dotenv
  - werkzeug
- Доступ к старой и новой базе данных MySQL

## Шаги миграции

### 1. Подготовка окружения

1. Создайте файл `config.env` в корневом каталоге проекта со следующими параметрами:

```
# Параметры подключения к старой базе данных
OLD_DB_HOST=192.168.2.225
OLD_DB_PORT=3306
OLD_DB_USER=test_user
OLD_DB_PASSWORD=password
OLD_DB_NAME=Brokers

# Параметры подключения к новой базе данных
NEW_DB_HOST=127.0.0.1
NEW_DB_PORT=3306
NEW_DB_USER=root
NEW_DB_PASSWORD=password
NEW_DB_NAME=Brokers_New
```

2. Установите необходимые зависимости:

```bash
pip install pymysql python-dotenv werkzeug
```

### 2. Создание новой структуры базы данных

1. Создайте новую базу данных:

```sql
CREATE DATABASE Brokers_New
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;
```

2. Запустите скрипт для создания структуры базы данных:

```bash
mysql -u root -p Brokers_New < new_database_schema.sql
```

### 3. Запуск миграции данных

1. Запустите скрипт миграции:

```bash
python migration_script.py
```

2. Проверьте файл `migration.log` на наличие ошибок или предупреждений.

3. Файл `user_id_mapping.txt` будет создан с сопоставлением ID пользователей между старой и новой базами данных. Сохраните этот файл для справки.

## Структура новой базы данных

Новая база данных разделена на следующие таблицы:

1. **Roles** - роли пользователей в системе
2. **Departments** - отделы компании
3. **User** - информация о пользователях
4. **UserActivity** - статусы активности пользователей
5. **CallCenterSettings** - настройки для операторов колл-центра
6. **Notifications** - уведомления для пользователей
7. **Scores** - статистика работы пользователей

Также создано представление **UserFullView**, которое объединяет данные из всех таблиц пользователей для удобного доступа.

## Возможные проблемы и их решения

### Ошибка подключения к базе данных

Проверьте правильность параметров подключения в файле `config.env` и убедитесь, что сервер базы данных запущен и доступен.

### Ошибки миграции данных

Если скрипт миграции завершается с ошибкой, проверьте журнал `migration.log` для получения подробностей об ошибке.

### Отсутствуют данные после миграции

Убедитесь, что все шаги миграции выполнены успешно и что в файле журнала нет сообщений об ошибках.

### Проблемы с правами доступа

Убедитесь, что пользователь базы данных имеет необходимые права для создания и изменения таблиц.

## Проверка успешности миграции

После завершения миграции выполните следующие проверки:

1. Проверьте количество пользователей в новой базе данных:

```sql
SELECT COUNT(*) FROM User;
```

2. Проверьте настройки колл-центра:

```sql
SELECT * FROM CallCenterSettings;
```

3. Проверьте данные в представлении UserFullView:

```sql
SELECT * FROM UserFullView LIMIT 10;
```

## Послемиграционные задачи

1. Обновите конфигурацию приложения для использования новой базы данных
2. Проверьте работу приложения с новой базой данных
3. При необходимости создайте резервную копию старой базы данных перед тем, как перестать её использовать 