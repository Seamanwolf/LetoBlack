<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Список кандидатов - HR</title>
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  
  <!-- FontAwesome (иконки) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Дополнительные стили -->
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      font-size: 0.85rem;
    }
    
    /* Стили для боковой панели и верхней панели */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 60px;
      background: #2c3e50;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      z-index: 1000;
      box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar a {
      color: #fff;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      font-size: 0.75rem;
      transition: all 0.3s;
    }
    
    .sidebar a i {
      font-size: 1.2rem;
      margin-bottom: 3px;
    }
    
    .sidebar a:hover {
      background-color: #3498db;
    }
    
    .sidebar a.active {
      background-color: #3498db;
    }
    
    .topbar {
      margin-left: 60px;
      padding: 15px 30px;
      background: white;
      height: 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 900;
    }
    
    .topbar .title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .topbar .profile-icon {
      display: flex;
      align-items: center;
      position: relative;
      cursor: pointer;
    }
    
    .topbar .profile-icon i {
      font-size: 1.2rem;
      margin-right: 10px;
      color: #3498db;
    }
    
    .topbar .profile-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 40px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 10px;
      min-width: 180px;
      z-index: 1000;
    }
    
    .topbar .profile-icon:hover .profile-menu,
    .topbar .profile-icon:focus .profile-menu {
      display: block;
    }
    
    .topbar .profile-menu a {
      display: block;
      padding: 8px 15px;
      color: #333;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .topbar .profile-menu a:hover {
      background-color: #f8f9fa;
      color: #3498db;
    }
    
    .topbar .profile-info {
      padding: 8px 15px;
      border-bottom: 1px solid #eee;
      margin-bottom: 8px;
    }
    
    .btn-transfer {
      background-color: #27ae60;
      border-color: #27ae60;
      color: white;
    }
    
    .btn-transfer:hover {
      background-color: #219955;
      border-color: #219955;
      color: white;
    }
    
    /* Карточки статистики */
    .stat-card {
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
      background: white;
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card .stat-title {
      font-size: 1rem;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .stat-card .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .stat-card .stat-icon {
      float: right;
      font-size: 2.5rem;
      opacity: 0.2;
      color: #3498db;
    }
    
    /* Главный контент */
    .main-content {
      margin-left: 60px;
      padding-top: 80px;
      padding-bottom: 30px;
    }
    
    /* Строка поиска */
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-box input {
      border-radius: 50px;
      padding-left: 45px;
      border: 1px solid #ddd;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .search-box i {
      position: absolute;
      left: 15px;
      top: 12px;
      color: #7f8c8d;
    }
    
    /* Фильтры */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .filter-btn {
      border: none;
      background-color: white;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 0.9rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
    }
    
    .filter-btn:hover, .filter-btn.active {
      background-color: #3498db;
      color: white;
    }
    
    /* Секция кандидатов */
    .candidate-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .candidate-header {
      background: #3498db;
      color: white;
      padding: 15px 20px;
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .candidate-header .badge {
      background-color: white;
      color: #3498db;
      font-size: 0.9rem;
      padding: 5px 10px;
    }
    
    .candidate-table-container {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table th {
      font-weight: 600;
      color: #7f8c8d;
      border-top: none;
      background-color: #f8f9fa;
      padding: 8px 10px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .table td {
      padding: 6px 10px;
      vertical-align: middle;
    }
    
    .candidate-row {
      position: relative;
      transition: background-color 0.3s;
    }
    
    .candidate-row:hover {
      background-color: #f8f9fa;
    }
    
    .edit-icon {
      cursor: pointer;
      font-size: 1rem;
      color: #3498db;
    }
    
    /* Анимация для новых кандидатов */
    @keyframes pulsate {
      0%   { background-color: rgba(255, 193, 7, 0.2); }
      50%  { background-color: rgba(255, 235, 59, 0.3); }
      100% { background-color: rgba(255, 193, 7, 0.2); }
    }
    .pulsate { 
      animation: pulsate 1.5s infinite; 
    }
    
    /* Модальные окна */
    .modal-header {
      background-color: #3498db;
      color: white;
      border-bottom: none;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    
    .modal-header .btn-close {
      color: white;
      filter: brightness(0) invert(1);
    }
    
    .modal-content {
      border: none;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .modal-footer {
      background-color: #f8f9fa;
      border-top: none;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
      padding: 15px 25px;
    }
    
    .modal-footer button {
      font-size: 0.8rem;
      padding: 8px 16px;
    }
    
    /* История изменений */
    .history-toggle {
      background-color: #0d6efd;
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-block;
      margin-top: 10px;
    }
    
    .history-section {
      margin-top: 10px;
      font-size: 0.75rem;
      display: none;
    }
    
    /* Toast уведомления */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1055;
    }
    
    .toast-slide {
      opacity: 0;
      transform: translateY(100%);
      transition: all 0.5s ease-in-out;
    }
    
    .toast-slide.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Кнопки */
    .btn-primary {
      background-color: #3498db;
      border-color: #3498db;
      box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
      transition: all 0.2s;
    }
    
    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
    }
    
    .btn-secondary {
      background-color: #95a5a6;
      border-color: #95a5a6;
      box-shadow: 0 2px 5px rgba(149, 165, 166, 0.3);
      transition: all 0.2s;
    }
    
    .btn-secondary:hover {
      background-color: #7f8c8d;
      border-color: #7f8c8d;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(149, 165, 166, 0.4);
    }
    
    .btn-danger {
      background-color: #e74c3c;
      border-color: #e74c3c;
      box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
      transition: all 0.2s;
    }
    
    .btn-danger:hover {
      background-color: #c0392b;
      border-color: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.4);
    }
    
    /* Инпуты в таблице */
    .table .form-control {
      padding: 2px 5px;
      height: auto;
      font-size: 0.85rem;
    }
    
    /* Анимация для модальных окон */
    .modal.fade .modal-dialog {
      transition: transform 0.3s ease-out, opacity 0.3s;
      transform: scale(0.95);
      opacity: 0;
    }
    
    .modal.show .modal-dialog {
      transform: scale(1);
      opacity: 1;
    }
  </style>
</head>
<body>

<!-- Боковая панель -->
<div class="sidebar">
  <a href="{{ url_for('hr.candidates_list') }}" class="active">
    <i class="fas fa-user-plus"></i>
    <span>Кандидаты</span>
  </a>
  <a href="{{ url_for('hr.transferred_candidates') }}">
    <i class="fas fa-user-check"></i>
    <span>Переданные</span>
  </a>
  <a href="{{ url_for('hr.archive_candidates') }}">
    <i class="fas fa-archive"></i>
    <span>Архив</span>
  </a>
  <a href="{{ url_for('hr.candidates_statistics') }}">
    <i class="fas fa-chart-bar"></i>
    <span>Статистика</span>
  </a>
  <a href="{{ url_for('userlist.logout') }}">
    <i class="fas fa-sign-out-alt"></i>
    <span>Выход</span>
  </a>
</div>

<!-- Верхняя панель -->
<div class="topbar">
  <div class="title">Кандидаты</div>
  <div class="d-flex align-items-center gap-3">
    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addCandidateModal">
      <i class="fas fa-user-plus me-1"></i> Добавить кандидата
    </button>
    <div class="profile-icon">
      <i class="fas fa-user-circle"></i>
      <span>{{ current_user.full_name or 'Пользователь' }}</span>
      <div class="profile-menu">
        <div class="profile-info">
          <p class="mb-0 fw-bold">{{ current_user.full_name }}</p>
          <small class="text-muted">{{ current_user.role or 'HR' }}</small>
        </div>
        <a href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
          <i class="fas fa-user me-2"></i> Мой профиль
        </a>
        <a href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
          <i class="fas fa-cog me-2"></i> Настройки
        </a>
        <a href="{{ url_for('userlist.logout') }}">
          <i class="fas fa-sign-out-alt me-2"></i> Выход
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Основной контент -->
<div class="main-content container-fluid">
  <div class="container">
    <!-- Строка для статистики -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
          <div class="stat-title">Всего кандидатов</div>
          <div class="stat-value">{{ candidates|length }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-building"></i></div>
          <div class="stat-title">Отделов</div>
          <div class="stat-value">{{ candidates|map(attribute='department')|unique|list|length }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
          <div class="stat-title">Выходят в ближайшие 7 дней</div>
          <div class="stat-value">{{ candidates|selectattr('exit_date_7', 'defined')|selectattr('exit_date_7', 'ne', None)|list|length }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
          <div class="stat-title">Новые кандидаты</div>
          <div class="stat-value">{{ candidates|selectattr('is_new', 'defined')|selectattr('is_new', 'eq', True)|list|length }}</div>
        </div>
      </div>
    </div>
    
    <!-- Поиск и фильтры -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" class="form-control" placeholder="Поиск кандидатов по имени, должности...">
        </div>
      </div>
      <div class="col-md-6">
        <div class="filters">
          <button class="filter-btn active" data-filter="all">Все</button>
          <button class="filter-btn" data-filter="Ожидание">Ожидание</button>
          <button class="filter-btn" data-filter="Вышел">Вышел</button>
          <button class="filter-btn" data-filter="Не вышел">Не вышел</button>
        </div>
      </div>
    </div>
    
    <!-- Таблица кандидатов -->
    <div class="candidate-section">
      <div class="candidate-header">
        <span>Кандидаты</span>
        <span class="badge">{{ candidates|length }} человек</span>
      </div>
      <div class="candidate-table-container">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ФИО</th>
              <th>Отдел</th>
              <th>РОП</th>
              <th>Город</th>
              <th>Личная почта</th>
              <th>Выход (1 день)</th>
              <th>Выход (7 дней)</th>
              <th>Должность</th>
              <th>Реферал</th>
              <th>ФИ менеджера</th>
              <th>Статус</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for candidate in candidates %}
            <tr class="candidate-row {% if candidate.is_new %}pulsate{% endif %}" data-id="{{ candidate.id }}">
              <td class="c-fullname">{{ candidate.full_name }}</td>
              <td class="c-department">{{ candidate.department }}</td>
              <td class="c-rop">{{ candidate.rop or '' }}</td>
              <td class="c-city">{{ candidate.city or '' }}</td>
              <td class="c-email">{{ candidate.personal_email or '' }}</td>
              <td class="c-1t_day">
                {% if candidate.exit_date_1 %}
                  {{ candidate.exit_date_1|format_date }}
                {% else %}
                  --
                {% endif %}
              </td>
              <td class="c-7n_day">
                {% if candidate.exit_date_7 %}
                  {{ candidate.exit_date_7|format_date }}
                {% else %}
                  --
                {% endif %}
              </td>
              <td class="c-post">{{ candidate.position or '' }}</td>
              <td class="c-referral">{{ candidate.referral or '' }}</td>
              <td class="c-manager">{{ candidate.manager_full_name or '' }}</td>
              <td class="c-status">{{ candidate.status or '--' }}</td>
              <td class="text-center">
                <div class="d-flex gap-1 justify-content-center">
                  <button class="btn btn-sm btn-outline-primary edit-icon" title="Редактировать">
                    <i class="fas fa-pencil-alt"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-warning archive-icon" title="В архив">
                    <i class="fas fa-archive"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Toast-уведомления -->
<div class="toast-container">
  <!-- Тост добавления кандидата (зелёный) -->
  <div id="addCandidateToast" class="toast toast-slide bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Новый кандидат добавлен. Пожалуйста, заполните данные!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <!-- Тост архивирования (красный) -->
  <div id="archiveToast" class="toast toast-slide bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Кандидат перемещён в архив!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <!-- Тост сохранения изменений (зелёный) -->
  <div id="changesSavedToast" class="toast toast-slide bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Изменения сохранены!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <!-- Тост передачи в IT (зелёный) -->
  <div id="itRequestToast" class="toast toast-slide bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Кандидат передан в IT!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <!-- Тост ошибки отсутствия свободных номеров (красный) -->
  <div id="freeNumberErrorToast" class="toast toast-slide bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Нет свободных номеров для выдачи для выбранного отдела!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- Модальные окна -->
<!-- Модальное окно добавления кандидата -->
<div class="modal fade" id="addCandidateModal" tabindex="-1" aria-labelledby="addCandidateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCandidateModalLabel">Добавить кандидата</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addCandidateForm" method="POST" action="{{ url_for('hr.add_candidate') }}">
          <div class="mb-3">
            <label for="fullName" class="form-label">ФИО</label>
            <input type="text" class="form-control" id="fullName" name="full_name" required>
          </div>
          <div class="mb-3">
            <label for="department" class="form-label">Отдел</label>
            <select class="form-select" id="department" name="department" required>
              <option value="" selected disabled>Выберите отдел</option>
              {% for department in departments %}
              <option value="{{ department }}">{{ department }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="position" class="form-label">Должность</label>
            <input type="text" class="form-control" id="position" name="position">
          </div>
          <input type="hidden" id="manager_name" name="manager_full_name" value="{{ current_user.full_name }}">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" form="addCandidateForm" class="btn btn-primary">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно: Редактирование кандидата -->
<div class="modal fade" id="editCandidateModal" tabindex="-1" aria-labelledby="editCandidateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editCandidateForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="editCandidateModalLabel">Редактировать кандидата</h5>
          <button type="button" class="btn-close btn-small" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Скрытое поле для ID кандидата -->
          <input type="hidden" name="candidate_id" id="editCandidateId">
          
          <div class="row row-cols-2">
            <!-- Левая колонка -->
            <div class="col">
              <div class="mb-2">
                <label for="edit_full_name" class="form-label">ФИО *</label>
                <input type="text" class="form-control" id="edit_full_name" name="full_name" required>
              </div>
              <div class="mb-2">
                <label for="edit_department" class="form-label">Отдел *</label>
                <input type="text" class="form-control" id="edit_department" name="department" required>
              </div>
              <div class="mb-2">
                <label for="edit_position" class="form-label">Должность *</label>
                <input type="text" class="form-control" id="edit_position" name="position" required>
              </div>
              <div class="mb-2">
                <label for="edit_city" class="form-label">Город</label>
                <input type="text" class="form-control" id="edit_city" name="city">
              </div>
              <div class="mb-2">
                <label for="edit_personal_email" class="form-label">Личная почта</label>
                <input type="email" class="form-control" id="edit_personal_email" name="personal_email">
              </div>
            </div>
            <!-- Правая колонка -->
            <div class="col">
              <div class="mb-2">
                <label for="edit_birth_date" class="form-label">Дата рождения *</label>
                <input type="date" class="form-control" id="edit_birth_date" name="birth_date" required>
              </div>
              <div class="mb-2">
                <label for="edit_exit_date_1" class="form-label">Выход (1 день)</label>
                <input type="date" class="form-control" id="edit_exit_date_1" name="exit_date_1">
              </div>
              <div class="mb-2">
                <label for="edit_exit_date_7" class="form-label">Выход (7 дней)</label>
                <input type="date" class="form-control" id="edit_exit_date_7" name="exit_date_7">
              </div>
              <div class="mb-2">
                <label for="edit_referral" class="form-label">Реферал</label>
                <input type="text" class="form-control" id="edit_referral" name="referral">
              </div>
              <div class="mb-2">
                <label for="edit_manager_full_name" class="form-label">ФИ менеджера</label>
                <input type="text" class="form-control" id="edit_manager_full_name" name="manager_full_name" readonly>
              </div>
              <div class="mb-2">
                <label for="edit_status" class="form-label">Статус</label>
                <select class="form-select" id="edit_status" name="status">
                  <option value="">--</option>
                  <option value="Вышел">Вышел</option>
                  <option value="Не вышел">Не вышел</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Вход в ПК</label>
                <input type="text" class="form-control" id="edit_login_pc" name="login_pc" readonly>
              </div>
              <div class="mb-2">
                <label class="form-label">Пароль</label>
                <input type="text" class="form-control" id="edit_password" name="password" readonly>
              </div>
              <div class="mb-2">
                <label class="form-label">Корпоративный номер</label>
                <input type="text" class="form-control" id="edit_corporate_number" name="corporate_number" readonly>
              </div>
            </div>
          </div>
          <!-- Кнопка "История изменений" (синяя) -->
          <div class="history-toggle">История изменений ↓</div>
          <div class="history-section" id="historySection">
            <input type="text" id="historyFilter" placeholder="Фильтровать по полю" class="form-control mb-2" style="font-size:0.75rem;">
            <!-- Здесь JS будет добавлять div.history-entry -->
          </div>
        </div>
        <div class="modal-footer">
          <!-- Кнопка "Передать в IT" (зелёная) -->
          <button type="button" class="btn btn-transfer btn-small" id="transferOrRestoreBtn">Передать в IT</button>
          <button type="button" class="btn btn-secondary btn-small" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary btn-small">Сохранить изменения</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Скрипты Bootstrap и jQuery -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Наш JavaScript -->
<script>
  // Функция для показа Toast
  function showToast(titleOrId, message, type) {
    // Если передано только id тоста (старый вариант)
    if (arguments.length === 1) {
      var toastEl = document.getElementById(arguments[0]);
      if(!toastEl) return;
      var toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
      toast.show();
      return;
    }
    
    // Новый вариант с динамическим созданием тоста
    var toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) return;
    
    var bgClass = 'bg-info';
    if (type === 'success') bgClass = 'bg-success';
    if (type === 'error') bgClass = 'bg-danger';
    if (type === 'warning') bgClass = 'bg-warning';
    
    var toastHtml = `
      <div class="toast toast-slide ${bgClass} text-white" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    var newToast = toastContainer.lastElementChild;
    var toast = new bootstrap.Toast(newToast, { autohide: true, delay: 3000 });
    toast.show();
    
    // Удаляем toast после того, как он скрыт
    newToast.addEventListener('hidden.bs.toast', function() {
      newToast.remove();
    });
  }
  
  // Форматирование даты для input[type="date"]
  function formatDateForInput(dateString) {
    if (!dateString) return "";
    var d = new Date(dateString);
    if (isNaN(d)) return "";
    var y = d.getFullYear();
    var m = String(d.getMonth()+1).padStart(2,'0');
    var day = String(d.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }
  
  // Форматирование timestamp для истории
  function formatTimestamp(ts) {
    var d = new Date(ts);
    if(isNaN(d)) return ts;
    var day   = String(d.getDate()).padStart(2,'0');
    var month = String(d.getMonth()+1).padStart(2,'0');
    var year  = d.getFullYear();
    var hh    = String(d.getHours()).padStart(2,'0');
    var mm    = String(d.getMinutes()).padStart(2,'0');
    return `${day}.${month}.${year} ${hh}:${mm}`;
  }
  
  // Рендер истории изменений с учетом события передачи в IT
  function renderHistory(history) {
    var historySection = $('#historySection');
    historySection.empty();
    if(!history || history.length === 0) {
      historySection.append('<div class="history-entry">Нет изменений</div>');
      return;
    }
    var fieldMap = {
      "full_name":        "ФИО",
      "department":       "Отдел",
      "position":         "Должность",
      "city":             "Город",
      "personal_email":   "Личная почта",
      "birth_date":       "Дата рождения",
      "exit_date_1":      "Выход (1 день)",
      "exit_date_7":      "Выход (7 дней)",
      "referral":         "Реферал",
      "manager_full_name": "ФИ менеджера",
      "status":           "Статус",
      "login_pc":         "Вход в ПК",
      "password":         "Пароль",
      "corporate_number": "Корпоративный номер",
      "creation":         "Создание"
    };
    history.forEach(function(entry){
      var dt = formatTimestamp(entry.timestamp);
      var text = "";
      if(entry.field_changed === "creation") {
        text = `${dt}. Пользователь "${entry.user}" создал кандидата.`;
      } else if(entry.field_changed === "transfer_it") {
        text = `${dt}. Пользователь "${entry.user}" передал заявку в IT, присвоен номер: ${entry.new_value}`;
      } else {
        var fieldName = fieldMap[entry.field_changed] || entry.field_changed;
        text = `${dt}. Пользователь "${entry.user}" изменил поле "${fieldName}" с "${entry.old_value}" на "${entry.new_value}"`;
      }
      historySection.append(`<div class="history-entry">${text}</div>`);
    });
  }
  
  // Обновление строки кандидата в таблице
  function updateCandidateRow(candidateId) {
    $.ajax({
      url: '/hr/candidate/' + candidateId,
      type: 'GET',
      dataType:'json',
      success: function(data) {
        var row = $('tr.candidate-row[data-id="'+candidateId+'"]');
        row.removeClass('pulsate');
        row.find('.c-fullname').text(data.full_name || '');
        row.find('.c-department').text(data.department || '');
        row.find('.c-rop').text(data.rop || '');
        row.find('.c-city').text(data.city || '');
        row.find('.c-email').text(data.personal_email || '');
        row.find('.c-1t_day').text(data.exit_date_1 ? data.exit_date_1 : '--');
        row.find('.c-7n_day').text(data.exit_date_7 ? data.exit_date_7 : '--');
        row.find('.c-post').text(data.position || '');
        row.find('.c-referral').text(data.referral || '');
        row.find('.c-manager').text(data.manager_full_name || '');
        row.find('.c-status').text(data.status || '--');
      },
      error: function(err){
        console.error("Не удалось обновить строку кандидата:", err);
      }
    });
  }
  
  // Клик по кнопке архивирования кандидата
  $(document).on('click','.archive-icon', function(e){
    e.stopPropagation();
    var row = $(this).closest('tr');
    var candidateId = row.data('id');
    
    // Показываем модальное окно вместо confirm
    var archiveModal = new bootstrap.Modal(document.getElementById('archiveConfirmModal'));
    archiveModal.show();
    
    // Обработчик для кнопки подтверждения в модальном окне
    $('#confirmArchiveBtn').off('click').on('click', function() {
      $.post('/hr/candidate/archive/'+candidateId, function(response){
        archiveModal.hide();
        showToast('Успешно', 'Кандидат успешно перемещен в архив', 'success');
        row.fadeOut(500, function() {
          $(this).remove();
        });
      }).fail(function(err){
        archiveModal.hide();
        showToast('Ошибка', 'Ошибка при архивировании: ' + (err.responseJSON ? err.responseJSON.error : 'Неизвестная ошибка'), 'error');
      });
    });
  });
  
  // Клик по кнопке редактирования кандидата
  $(document).on('click','.edit-icon', function(e){
    e.stopPropagation();
    var row = $(this).closest('tr');
    var candidateId = row.data('id');
    row.removeClass('pulsate');
    $.post('/hr/candidate/set_edit_opened/'+candidateId, {edit_opened:1});
    
    $.ajax({
      url: '/hr/candidate/'+candidateId,
      type: 'GET',
      dataType: 'json',
      success: function(data){
        $('#editCandidateId').val(data.id);
        $('#edit_full_name').val(data.full_name || '');
        $('#edit_department').val(data.department || '');
        $('#edit_position').val(data.position || '');
        $('#edit_city').val(data.city || '');
        $('#edit_personal_email').val(data.personal_email || '');
        $('#edit_birth_date').val(formatDateForInput(data.birth_date) || '');
        $('#edit_exit_date_1').val(formatDateForInput(data.exit_date_1) || '');
        $('#edit_exit_date_7').val(formatDateForInput(data.exit_date_7) || '');
        $('#edit_referral').val(data.referral || '');
        $('#edit_manager_full_name').val(data.manager_full_name || '');
        $('#edit_status').val(data.status || '');
        $('#edit_login_pc').val(data.login_pc || '');
        $('#edit_password').val(data.password || '');
        $('#edit_corporate_number').val(data.corporate_number || '');
        
        $('#editCandidateForm').attr('action','/hr/candidates/edit/'+candidateId);
        
        $.get('/hr/candidate/history/'+candidateId, function(history){
          renderHistory(history);
        }).fail(function(err){
          console.error("Ошибка при загрузке истории:", err);
        });
        
        var editModal = new bootstrap.Modal(document.getElementById('editCandidateModal'));
        editModal.show();
      },
      error: function(err){
        console.error("Ошибка загрузки данных кандидата:", err);
        showToast('Ошибка', 'Ошибка загрузки данных кандидата', 'error');
      }
    });
  });
  
  // Клик на кнопку "История изменений ↓" (синяя кнопка)
  $('.history-toggle').on('click', function(){
    $('#historySection').slideToggle(200);
  });
  
  // Сохранение изменений кандидата
  $('#editCandidateForm').on('submit', function(e){
    e.preventDefault();
    var candidateId = $('#editCandidateId').val();
    var status = $('#edit_status').val();
    var fn   = $('#edit_full_name').val().trim();
    var dept = $('#edit_department').val().trim();
    var bd   = $('#edit_birth_date').val().trim();
    if(!fn || !dept || !bd) {
      showToast('Внимание', 'Введите обязательные поля: ФИО, Отдел, Дата рождения', 'warning');
      return false;
    }
    
    if(status === "Не вышел") {
      var archiveUrl = '/hr/candidate/archive/'+candidateId;
      $.post(archiveUrl, function(){
        showToast('archiveToast');
        $('tr.candidate-row[data-id="'+candidateId+'"]').remove();
        var editModal = bootstrap.Modal.getInstance(document.getElementById('editCandidateModal'));
        editModal.hide();
      }).fail(function(err){
        console.error("Ошибка архивирования:", err);
        showToast('Ошибка', 'Ошибка архивирования кандидата', 'error');
      });
      return;
    }
    
    var formData = $(this).serialize();
    $.post('/hr/candidates/edit/'+candidateId, formData, function(resp){
      showToast('changesSavedToast');
      updateCandidateRow(candidateId);
      var editModal = bootstrap.Modal.getInstance(document.getElementById('editCandidateModal'));
      editModal.hide();
    }).fail(function(err){
      console.error("Ошибка сохранения:", err);
      showToast('Ошибка', 'Ошибка при сохранении', 'error');
    });
  });
  
  // Кнопка "Передать в IT" (зелёная)
  $('#transferOrRestoreBtn').on('click', function(){
    var candidateId = $('#editCandidateId').val();
    $.post('/hr/candidate/transfer_it_new/'+candidateId, function(resp){
      showToast('itRequestToast');
      updateCandidateRow(candidateId);
    }).fail(function(err){
      if(err.responseJSON && err.responseJSON.error && err.responseJSON.error.indexOf("Нет свободных номеров") !== -1) {
        showToast('freeNumberErrorToast');
      } else {
        console.error("Ошибка передачи в IT:", err);
        showToast('Ошибка', 'Ошибка передачи в IT', 'error');
      }
    });
  });
  
  // Фильтр истории изменений
  $('#historyFilter').on('input', function(){
    var val = $(this).val().toLowerCase();
    $('#historySection .history-entry').each(function(){
      var txt = $(this).text().toLowerCase();
      $(this).toggle(txt.includes(val));
    });
  });
  
  // Если нужно показать тост "Добавлен" при загрузке
  $(document).ready(function(){
    {% if flash_added_candidate %}
      showToast('addCandidateToast');
    {% endif %}
  });

  // Обработка кнопки добавления кандидата
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('#addCandidateForm').addEventListener('submit', function(e) {
      var form = this;
      var fullName = form.querySelector('[name="full_name"]').value.trim();
      var department = form.querySelector('[name="department"]').value;
      
      if (!fullName || !department) {
        e.preventDefault();
        showToast('Внимание', 'Пожалуйста, заполните все обязательные поля', 'warning');
        return false;
      }
      
      // Форма валидна, будет отправлена стандартным способом
      return true;
    });
    
    // Обработчик для кнопки изменения пароля
    document.getElementById('savePasswordBtn').addEventListener('click', function() {
      const newPassword = document.getElementById('newPassword').value.trim();
      
      if (!newPassword) {
        showToast('Внимание', 'Пожалуйста, введите новый пароль', 'warning');
        return;
      }
      
      if (newPassword.length < 6) {
        showToast('Внимание', 'Пароль должен содержать не менее 6 символов', 'warning');
        return;
      }
      
      // Отправляем запрос на изменение пароля
      fetch('/user/change_password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ password: newPassword })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('Успешно', 'Пароль успешно изменен', 'success');
          document.getElementById('newPassword').value = '';
          
          // Закрываем модальное окно
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
            if (modal) modal.hide();
          }, 1500);
        } else {
          showToast('Ошибка', data.error || 'Не удалось изменить пароль', 'error');
        }
      })
      .catch(error => {
        console.error('Ошибка:', error);
        showToast('Ошибка', 'Ошибка при изменении пароля', 'error');
      });
    });
  });
</script>

<!-- Модальное окно профиля пользователя -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Мой профиль</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <i class="fas fa-user-circle fa-4x text-primary"></i>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">ФИО</label>
            <input type="text" class="form-control" value="{{ current_user.full_name }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Роль</label>
            <input type="text" class="form-control" value="{{ current_user.role or 'HR' }}" readonly>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Логин</label>
            <input type="text" class="form-control" value="{{ current_user.username }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" value="{{ current_user.email or '' }}" readonly>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Сменить пароль</label>
          <div class="input-group">
            <input type="password" id="newPassword" class="form-control" placeholder="Новый пароль">
            <button class="btn btn-outline-secondary" type="button" id="savePasswordBtn">Сохранить</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно настроек -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Настройки</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-center text-muted">Функционал настроек находится в разработке</p>
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i> 
          <span>Эта функция будет доступна в ближайшем обновлении.</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно подтверждения архивирования -->
<div class="modal fade" id="archiveConfirmModal" tabindex="-1" aria-labelledby="archiveConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="archiveConfirmModalLabel">Подтверждение архивирования</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Вы уверены, что хотите архивировать этого кандидата?</p>
        <p class="small text-muted">Это действие переместит кандидата в архив и освободит его номер телефона.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-danger" id="confirmArchiveBtn">Архивировать</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
