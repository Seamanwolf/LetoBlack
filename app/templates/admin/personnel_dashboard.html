{% extends "base.html" %}

{% block title %}Дашборд персонала{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personnel_clean.css') }}">
<style>
/* Дополнительные стили для дашборда */
.dashboard-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-light);
}

.chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 1rem;
}

.chart-container {
    position: relative;
    height: 300px;
}

.dashboard-tables {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
}

.table-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-light);
}

.table-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 1rem;
}

.dashboard-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.dashboard-table th {
    background: var(--light-color);
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: var(--dark-color);
    border-bottom: 1px solid var(--border-color);
}

.dashboard-table td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
}

.dashboard-table tr:hover {
    background: rgba(52, 152, 219, 0.05);
}

.period-filters {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
}

.period-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    background: white;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.9rem;
}

.period-btn:hover {
    background: var(--light-color);
}

.period-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Навигационное меню -->
    <div class="personnel-nav">
        <a href="{{ url_for('admin_routes_unique.personnel') }}">
            <i class="fas fa-users"></i>
            Активные
        </a>
        <a href="{{ url_for('admin_routes_unique.fired_employees') }}">
            <i class="fas fa-user-times"></i>
            Уволенные
        </a>
        <a href="{{ url_for('admin_routes_unique.personnel_dashboard') }}" class="active">
            <i class="fas fa-chart-line"></i>
            Дашборд
        </a>
        <a href="{{ url_for('admin_routes_unique.phone_numbers') }}">
            <i class="fas fa-phone"></i>
            Номера
        </a>
    </div>

    <!-- Статистические карточки -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Всего сотрудников</div>
                <div class="stat-card-value">{{ total_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Активные</div>
                <div class="stat-card-value">{{ active_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Отделов</div>
                <div class="stat-card-value">{{ departments_count }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-user-minus"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Уволенные</div>
                <div class="stat-card-value">{{ fired_employees }}</div>
            </div>
        </div>
    </div>

    <!-- Фильтры периодов -->
    <div class="period-filters">
        <button class="period-btn active" data-period="week">Неделя</button>
        <button class="period-btn" data-period="month">Месяц</button>
        <button class="period-btn" data-period="year">Год</button>
    </div>

    <!-- Графики -->
    <div class="dashboard-charts">
        <div class="chart-card">
            <div class="chart-title">Динамика численности персонала</div>
            <div class="chart-container">
                <canvas id="staffDynamicsChart" 
                    data-dates="{{ dates|tojson }}"
                    data-staff-counts="{{ staff_counts|tojson }}">
                </canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">Распределение по отделам</div>
            <div class="chart-container">
                <canvas id="departmentDistributionChart"
                    data-department-names="{{ department_names|tojson }}"
                    data-department-counts="{{ department_counts|tojson }}">
                </canvas>
            </div>
        </div>
    </div>

    <!-- Таблицы -->
    <div class="dashboard-tables">
        <div class="table-card">
            <div class="table-title">Последние наймы</div>
            <div class="table-responsive">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>ФИО</th>
                            <th>Отдел</th>
                            <th>Должность</th>
                            <th>Дата найма</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hire in recent_hires %}
                        <tr>
                            <td><strong>{{ hire.full_name }}</strong></td>
                            <td>{{ hire.department }}</td>
                            <td>{{ hire.position }}</td>
                            <td>
                                <span class="text-success">
                                    <i class="fas fa-calendar-plus"></i>
                                    {{ hire.hire_date }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="table-card">
            <div class="table-title">Последние увольнения</div>
            <div class="table-responsive">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>ФИО</th>
                            <th>Отдел</th>
                            <th>Должность</th>
                            <th>Дата увольнения</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fire in recent_fires %}
                        <tr>
                            <td><strong>{{ fire.full_name }}</strong></td>
                            <td>{{ fire.department }}</td>
                            <td>{{ fire.position }}</td>
                            <td>
                                <span class="text-danger">
                                    <i class="fas fa-calendar-times"></i>
                                    {{ fire.fire_date }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Дополнительная аналитика -->
    <div class="dashboard-charts">
        <div class="chart-card">
            <div class="chart-title">Текучесть кадров по месяцам</div>
            <div class="chart-container">
                <canvas id="turnoverChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">Топ отделов по численности</div>
            <div class="chart-container">
                <canvas id="topDepartmentsChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    'use strict';

    // Получение данных
    const staffDynamicsCtx = document.getElementById('staffDynamicsChart');
    const departmentDistributionCtx = document.getElementById('departmentDistributionChart');
    const turnoverCtx = document.getElementById('turnoverChart');
    const topDepartmentsCtx = document.getElementById('topDepartmentsChart');

    // Данные для графиков
    let staffData = {
        dates: JSON.parse(staffDynamicsCtx.dataset.dates || '[]'),
        counts: JSON.parse(staffDynamicsCtx.dataset.staffCounts || '[]')
    };

    let departmentData = {
        names: JSON.parse(departmentDistributionCtx.dataset.departmentNames || '[]'),
        counts: JSON.parse(departmentDistributionCtx.dataset.departmentCounts || '[]')
    };

    // Цветовая палитра
    const colors = {
        primary: '#3498db',
        success: '#27ae60',
        warning: '#f39c12',
        danger: '#e74c3c',
        info: '#17a2b8',
        secondary: '#6c757d'
    };

    // График динамики численности персонала
    const staffDynamicsChart = new Chart(staffDynamicsCtx, {
        type: 'line',
        data: {
            labels: staffData.dates,
            datasets: [{
                label: 'Численность персонала',
                data: staffData.counts,
                borderColor: colors.primary,
                backgroundColor: colors.primary + '20',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: colors.primary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#f1f1f1'
                    }
                },
                x: {
                    grid: {
                        color: '#f1f1f1'
                    }
                }
            }
        }
    });

    // График распределения по отделам
    const departmentDistributionChart = new Chart(departmentDistributionCtx, {
        type: 'doughnut',
        data: {
            labels: departmentData.names,
            datasets: [{
                data: departmentData.counts,
                backgroundColor: [
                    colors.primary,
                    colors.success,
                    colors.warning,
                    colors.danger,
                    colors.info,
                    colors.secondary,
                    '#9b59b6',
                    '#e67e22',
                    '#1abc9c',
                    '#34495e'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });

    // График текучести кадров (примерные данные)
    const turnoverChart = new Chart(turnoverCtx, {
        type: 'bar',
        data: {
            labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн'],
            datasets: [{
                label: 'Наймы',
                data: [5, 8, 3, 6, 4, 7],
                backgroundColor: colors.success + '80',
                borderColor: colors.success,
                borderWidth: 1
            }, {
                label: 'Увольнения',
                data: [2, 3, 1, 4, 2, 3],
                backgroundColor: colors.danger + '80',
                borderColor: colors.danger,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#f1f1f1'
                    }
                },
                x: {
                    grid: {
                        color: '#f1f1f1'
                    }
                }
            }
        }
    });

    // График топ отделов
    const topDepartmentsChart = new Chart(topDepartmentsCtx, {
        type: 'bar',
        data: {
            labels: departmentData.names.slice(0, 5),
            datasets: [{
                label: 'Количество сотрудников',
                data: departmentData.counts.slice(0, 5),
                backgroundColor: [
                    colors.primary + '80',
                    colors.success + '80',
                    colors.warning + '80',
                    colors.info + '80',
                    colors.secondary + '80'
                ],
                borderColor: [
                    colors.primary,
                    colors.success,
                    colors.warning,
                    colors.info,
                    colors.secondary
                ],
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    grid: {
                        color: '#f1f1f1'
                    }
                },
                x: {
                    beginAtZero: true,
                    grid: {
                        color: '#f1f1f1'
                    }
                }
            }
        }
    });

    // Фильтры периодов
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const period = this.dataset.period;
            // Здесь должна быть логика загрузки данных с сервера
            // и обновления графиков
            fetch(`/admin/api/dashboard_data?period=${period}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновление данных графиков
                    staffDynamicsChart.data.labels = data.dates;
                    staffDynamicsChart.data.datasets[0].data = data.staff_counts;
                    staffDynamicsChart.update();
                    
                    // Обновляем распределение по отделам
                    departmentDistributionChart.data.labels = data.department_names;
                    departmentDistributionChart.data.datasets[0].data = data.department_counts;
                    departmentDistributionChart.update();

                    // Обновляем топ отделов (топ-5)
                    topDepartmentsChart.data.labels = data.department_names.slice(0, 5);
                    topDepartmentsChart.data.datasets[0].data = data.department_counts.slice(0, 5);
                    topDepartmentsChart.update();
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки данных:', error);
            });
        });
    });

    // Автообновление данных каждые 5 минут
    setInterval(() => {
        const activePeriod = document.querySelector('.period-btn.active').dataset.period;
        fetch(`/admin/api/dashboard_data?period=${activePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновление данных графиков
                staffDynamicsChart.data.labels = data.dates;
                staffDynamicsChart.data.datasets[0].data = data.staff_counts;
                staffDynamicsChart.update();
                
                // Обновляем распределение по отделам
                departmentDistributionChart.data.labels = data.department_names;
                departmentDistributionChart.data.datasets[0].data = data.department_counts;
                departmentDistributionChart.update();

                // Обновляем топ отделов (топ-5)
                topDepartmentsChart.data.labels = data.department_names.slice(0, 5);
                topDepartmentsChart.data.datasets[0].data = data.department_counts.slice(0, 5);
                topDepartmentsChart.update();
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки данных:', error);
        });
    }, 300000); // 5 минут

})();
</script>
{% endblock %}
