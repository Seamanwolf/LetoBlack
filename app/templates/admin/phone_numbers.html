{% extends "base.html" %}

{% block title %}Корпоративные номера{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personnel_clean.css') }}">
<style>
/* Дополнительные стили для страницы номеров */
.number-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.number-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.number-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.number-switch-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.number-switch-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

.number-switch input:checked + .number-switch-slider {
    background-color: var(--primary-color);
}

.number-switch input:checked + .number-switch-slider:before {
    transform: translateX(26px);
}

.add-number-btn-floating {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: var(--shadow-medium);
    transition: var(--transition);
    z-index: 100;
}

.add-number-btn-floating:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}

.number-status {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.status-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.whatsapp {
    background: #25d366;
    color: white;
}

.status-badge.telegram {
    background: #0088cc;
    color: white;
}

.status-badge.blocked {
    background: var(--danger-color);
    color: white;
}

.status-badge.prohibited {
    background: var(--warning-color);
    color: white;
}

.number-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.number-table th {
    background: var(--light-color);
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: var(--dark-color);
    border-bottom: 1px solid var(--border-color);
}

.number-table td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
}

.number-table tr:hover {
    background: rgba(52, 152, 219, 0.05);
}

.free-numbers-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.free-numbers-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/></svg>');
    opacity: 0.3;
}

.free-numbers-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.free-numbers-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
}

.free-numbers-info p {
    margin: 0;
    opacity: 0.9;
}

.quick-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
}

.quick-action-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1rem;
    box-shadow: var(--shadow-light);
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    flex: 1;
    max-width: 200px;
}

.quick-action-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.quick-action-icon {
    font-size: 2rem;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.quick-action-title {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.quick-action-desc {
    font-size: 0.85rem;
    color: var(--muted-color);
}

.bulk-actions {
    background: white;
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-light);
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.bulk-actions select {
    min-width: 150px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Навигационное меню -->
    <div class="personnel-nav">
        <a href="{{ url_for('admin_routes_unique.personnel') }}">
            <i class="fas fa-users"></i>
            Активные
        </a>
        <a href="{{ url_for('admin_routes_unique.fired_employees') }}">
            <i class="fas fa-user-times"></i>
            Уволенные
        </a>
        <a href="{{ url_for('admin_routes_unique.personnel_dashboard') }}">
            <i class="fas fa-chart-line"></i>
            Дашборд
        </a>
        <a href="{{ url_for('admin_routes_unique.phone_numbers') }}" class="active">
            <i class="fas fa-phone"></i>
            Номера
        </a>
    </div>

    <!-- Статистические карточки -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-phone"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Всего номеров</div>
                <div class="stat-card-value">{{ numbers|length }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-phone-slash"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Свободные</div>
                <div class="stat-card-value">{{ free_numbers_count }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-whatsapp"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">WhatsApp</div>
                <div class="stat-card-value">{{ whatsapp_count }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fab fa-telegram"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Telegram</div>
                <div class="stat-card-value">{{ telegram_count }}</div>
            </div>
        </div>
    </div>

    <!-- Секция свободных номеров -->
    {% if free_numbers %}
    <div class="free-numbers-section">
        <div class="free-numbers-content">
            <div class="free-numbers-info">
                <h3><i class="fas fa-phone-slash"></i> Свободные номера</h3>
                <p>{{ free_numbers|length }} номеров доступны для назначения</p>
            </div>
            <button class="btn btn-light" onclick="openModal('freeNumbersModal')">
                <i class="fas fa-list"></i>
                Просмотреть все
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Быстрые действия -->
    <div class="quick-actions">
        <div class="quick-action-card" onclick="openModal('addNumberModal')">
            <div class="quick-action-icon">
                <i class="fas fa-plus"></i>
            </div>
            <div class="quick-action-title">Добавить номер</div>
            <div class="quick-action-desc">Новый корпоративный номер</div>
        </div>
        <div class="quick-action-card" onclick="openModal('bulkImportModal')">
            <div class="quick-action-icon">
                <i class="fas fa-file-upload"></i>
            </div>
            <div class="quick-action-title">Импорт</div>
            <div class="quick-action-desc">Загрузить из файла</div>
        </div>
        <div class="quick-action-card" onclick="exportNumbers()">
            <div class="quick-action-icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="quick-action-title">Экспорт</div>
            <div class="quick-action-desc">Скачать список</div>
        </div>
        <div class="quick-action-card" onclick="openModal('settingsModal')">
            <div class="quick-action-icon">
                <i class="fas fa-cog"></i>
            </div>
            <div class="quick-action-title">Настройки</div>
            <div class="quick-action-desc">Параметры номеров</div>
        </div>
    </div>

    <!-- Поиск и фильтры -->
    <div class="search-filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Поиск номеров...">
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">
                <i class="fas fa-phone"></i>
                Все
            </button>
            <button class="btn btn-secondary" onclick="openModal('filtersModal')">
                <i class="fas fa-filter"></i> Фильтры
            </button>
            <button class="btn btn-primary" id="toggleAllBtn">
                <i class="fas fa-expand-arrows-alt"></i>
                Развернуть все
            </button>
        </div>
    </div>

    <!-- Массовые действия -->
    <div class="bulk-actions">
        <label>Массовые действия:</label>
        <select class="form-control" id="bulkAction">
            <option value="">Выберите действие</option>
            <option value="enable_whatsapp">Включить WhatsApp</option>
            <option value="disable_whatsapp">Отключить WhatsApp</option>
            <option value="enable_telegram">Включить Telegram</option>
            <option value="disable_telegram">Отключить Telegram</option>
            <option value="block">Заблокировать</option>
            <option value="unblock">Разблокировать</option>
            <option value="move">Переместить в отдел</option>
            <option value="delete">Удалить</option>
        </select>
        <select class="form-control" id="targetDepartment" style="display: none;">
            <option value="">Выберите отдел</option>
            <option value="free">Свободные номера</option>
            {% for dept in departments %}
            <option value="{{ dept.id }}">{{ dept.name }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-primary" onclick="applyBulkAction()">
            <i class="fas fa-check"></i>
            Применить
        </button>
        <span class="text-muted" id="selectedCount">Выбрано: 0</span>
    </div>

    <!-- Отделы с номерами -->
    <div class="departments-container">
        {% for department in departments %}
        {% if department.phone_numbers %}
        <div class="department-card" data-department="{{ department.name }}" 
             draggable="true" data-department-id="{{ department.id }}">
            <div class="department-header">
                <div class="department-name">
            <div class="drag-handle">
                <i class="fas fa-grip-vertical"></i>
            </div>
                    {{ department.name }}
                </div>
                <div class="department-controls">
                    <div class="department-badge">{{ department.phone_numbers|length }}</div>
                    <i class="fas fa-chevron-up department-toggle" data-department="{{ department.id }}"></i>
                </div>
            </div>
            <div class="department-content" id="dept-{{ department.id }}">
                <table class="number-table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" class="select-all-dept" data-department="{{ department.id }}">
                            </th>
                            <th>ID</th>
                            <th>Номер</th>
                            <th>Назначен</th>
                            <th>Статус</th>
                            <th>Настройки</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for number in department.phone_numbers %}
                        <tr class="number-row" data-number-id="{{ number.id }}">
                            <td>
                                <input type="checkbox" class="number-checkbox" value="{{ number.id }}">
                            </td>
                            <td>{{ number.id }}</td>
                            <td>
                                <strong>{{ number.phone_number }}</strong>
                            </td>
                            <td>{{ number.assigned_to or '—' }}</td>
                            <td>
                                <div class="number-status">
                                    {% if number.whatsapp %}
                                        <span class="status-badge whatsapp">WA</span>
                                    {% endif %}
                                    {% if number.telegram %}
                                        <span class="status-badge telegram">TG</span>
                                    {% endif %}
                                    {% if number.blocked %}
                                        <span class="status-badge blocked">Заблокирован</span>
                                    {% endif %}
                                    {% if number.prohibit_issuance %}
                                        <span class="status-badge prohibited">Запрещена выдача</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="number-controls">
                                    <label class="number-switch" title="WhatsApp">
                                        <input type="checkbox" class="whatsapp-toggle" data-number-id="{{ number.id }}" {% if number.whatsapp %}checked{% endif %}>
                                        <span class="number-switch-slider"></span>
                                    </label>
                                    <label class="number-switch" title="Telegram">
                                        <input type="checkbox" class="telegram-toggle" data-number-id="{{ number.id }}" {% if number.telegram %}checked{% endif %}>
                                        <span class="number-switch-slider"></span>
                                    </label>
                                    <label class="number-switch" title="Блокировка">
                                        <input type="checkbox" class="block-toggle" data-number-id="{{ number.id }}" {% if number.blocked %}checked{% endif %}>
                                        <span class="number-switch-slider"></span>
                                    </label>
                                </div>
                            </td>
                            <td>
                                <div class="action-icons">
                                    <i class="fas fa-edit action-icon edit" title="Редактировать" data-number-id="{{ number.id }}"></i>
                                    <i class="fas fa-exchange-alt action-icon move" title="Переместить" data-number-id="{{ number.id }}"></i>
                                    <i class="fas fa-trash-alt action-icon delete" title="Удалить" data-number-id="{{ number.id }}"></i>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Плавающая кнопка добавления -->
    <button class="add-number-btn-floating" onclick="openModal('addNumberModal')" title="Добавить номер">
        <i class="fas fa-plus"></i>
    </button>
</div>

<!-- Модальные окна -->
<!-- Добавление номера -->
<div class="modal" id="addNumberModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Добавить номер</h3>
            <button class="modal-close" onclick="closeModal('addNumberModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="addNumberForm">
                <div class="form-group">
                    <label class="form-label">Номер телефона</label>
                    <div class="input-group">
                        <span>+7</span>
                        <input type="tel" class="form-control" name="phone_number" placeholder="9001234567" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Отдел</label>
                    <select class="form-control" name="department_id">
                        <option value="">Свободный номер</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Назначить сотруднику</label>
                    <input type="text" class="form-control" name="assigned_to" placeholder="ФИО сотрудника">
                </div>
                <div class="form-group">
                    <div class="d-flex gap-2">
                        <label>
                            <input type="checkbox" name="whatsapp"> WhatsApp
                        </label>
                        <label>
                            <input type="checkbox" name="telegram"> Telegram
                        </label>
                        <label>
                            <input type="checkbox" name="blocked"> Заблокирован
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addNumberModal')">Отмена</button>
            <button class="btn btn-primary" onclick="saveNumber()">Сохранить</button>
        </div>
    </div>
</div>

<!-- Просмотр свободных номеров -->
<div class="modal" id="freeNumbersModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">Свободные номера</h3>
            <button class="modal-close" onclick="closeModal('freeNumbersModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="search-box mb-3">
                <i class="fas fa-search"></i>
                <input type="text" id="searchFreeNumbers" placeholder="Поиск среди свободных номеров...">
            </div>
            <div id="freeNumbersList">
                {% for number in free_numbers %}
                <div class="free-number-item d-flex justify-content-between align-items-center p-2 border-bottom">
                    <span><strong>{{ number.phone_number }}</strong></span>
                    <div>
                        <button class="btn btn-sm btn-primary" onclick="assignNumber('{{ number.id }}')">
                            <i class="fas fa-user-plus"></i> Назначить
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для фильтров -->
<div class="modal" id="filtersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Фильтры</h3>
            <button class="modal-close" onclick="closeModal('filtersModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Фильтр по статусу</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="status_filter" value="whatsapp" id="filter_whatsapp"> WhatsApp
                    </label>
                    <label>
                        <input type="checkbox" name="status_filter" value="telegram" id="filter_telegram"> Telegram
                    </label>
                    <label>
                        <input type="checkbox" name="status_filter" value="blocked" id="filter_blocked"> Заблокированные
                    </label>
                    <label>
                        <input type="checkbox" name="status_filter" value="free" id="filter_free"> Свободные
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Фильтр по отделам</label>
                <div class="checkbox-group" id="departmentFilters">
                    {% for department in departments %}
                    <label>
                        <input type="checkbox" name="department_filter" value="{{ department.id }}"> {{ department.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Назначение номера</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="assignment_filter" value="assigned" id="filter_assigned"> Назначенные
                    </label>
                    <label>
                        <input type="checkbox" name="assignment_filter" value="unassigned" id="filter_unassigned"> Не назначенные
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>
            <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Поиск номеров
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.number-row');
    
    rows.forEach(row => {
        const number = row.cells[2].textContent.toLowerCase();
        const assigned = row.cells[3].textContent.toLowerCase();
        
        if (number.includes(searchTerm) || assigned.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Скрыть пустые отделы
    updateDepartmentVisibility();
});

// Фильтрация
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.dataset.filter) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            const rows = document.querySelectorAll('.number-row');
            
            rows.forEach(row => {
                const statusCell = row.cells[4];
                
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'whatsapp' && statusCell.querySelector('.whatsapp')) {
                    row.style.display = '';
                } else if (filter === 'telegram' && statusCell.querySelector('.telegram')) {
                    row.style.display = '';
                } else if (filter === 'blocked' && statusCell.querySelector('.blocked')) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            updateDepartmentVisibility();
        }
    });
});

// Сворачивание/разворачивание отделов
document.querySelectorAll('.department-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
        const departmentId = this.dataset.department;
        const content = document.getElementById('dept-' + departmentId);
        
        if (content.style.display === 'none') {
            content.style.display = '';
            this.classList.remove('fa-chevron-down');
            this.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            this.classList.remove('fa-chevron-up');
            this.classList.add('fa-chevron-down');
        }
    });
});

// Развернуть/свернуть все
document.getElementById('toggleAllBtn').addEventListener('click', function() {
    const allExpanded = document.querySelectorAll('.department-toggle.fa-chevron-up').length > 0;
    
    document.querySelectorAll('.department-toggle').forEach(toggle => {
        const departmentId = toggle.dataset.department;
        const content = document.getElementById('dept-' + departmentId);
        
        if (allExpanded) {
            content.style.display = 'none';
            toggle.classList.remove('fa-chevron-up');
            toggle.classList.add('fa-chevron-down');
        } else {
            content.style.display = '';
            toggle.classList.remove('fa-chevron-down');
            toggle.classList.add('fa-chevron-up');
        }
    });
    
    this.innerHTML = allExpanded ? 
        '<i class="fas fa-expand-arrows-alt"></i> Развернуть все' : 
        '<i class="fas fa-compress-arrows-alt"></i> Свернуть все';
});

// Переключатели номеров
document.querySelectorAll('.whatsapp-toggle, .telegram-toggle, .block-toggle').forEach(toggle => {
    toggle.addEventListener('change', function() {
        const numberId = this.dataset.numberId;
        const type = this.classList.contains('whatsapp-toggle') ? 'whatsapp' :
                    this.classList.contains('telegram-toggle') ? 'telegram' : 'blocked';
        
        updateNumberStatus(numberId, type, this.checked);
    });
});

// Чекбоксы для массовых действий
document.querySelectorAll('.number-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
});

document.querySelectorAll('.select-all-dept').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const departmentId = this.dataset.department;
        const deptCheckboxes = document.querySelectorAll(`#dept-${departmentId} .number-checkbox`);
        
        deptCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
        
        updateSelectedCount();
    });
});

// Массовые действия
document.getElementById('bulkAction').addEventListener('change', function() {
    const targetDepartment = document.getElementById('targetDepartment');
    if (this.value === 'move') {
        targetDepartment.style.display = '';
    } else {
        targetDepartment.style.display = 'none';
    }
});

// Модальные окна
function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Функции API
function updateNumberStatus(numberId, type, value) {
    const data = {
        number_id: numberId,
        [type]: value
    };
    
    fetch('/api/update_number_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Ошибка: ' + data.message);
        }
    });
}

function saveNumber() {
    const form = document.getElementById('addNumberForm');
    const formData = new FormData(form);
    
    fetch('/api/add_number', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    });
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.number-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = `Выбрано: ${selected}`;
}

function applyBulkAction() {
    const action = document.getElementById('bulkAction').value;
    const selectedNumbers = Array.from(document.querySelectorAll('.number-checkbox:checked')).map(cb => cb.value);
    
    if (!action || selectedNumbers.length === 0) {
        alert('Выберите действие и номера');
        return;
    }
    
    const data = {
        action: action,
        number_ids: selectedNumbers
    };
    
    if (action === 'move') {
        const targetDept = document.getElementById('targetDepartment').value;
        if (!targetDept) {
            alert('Выберите отдел назначения');
            return;
        }
        data.target_department = targetDept;
    }
    
    fetch('/api/bulk_action_numbers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    });
}

function updateDepartmentVisibility() {
    document.querySelectorAll('.department-card').forEach(dept => {
        const visibleRows = dept.querySelectorAll('.number-row:not([style*="display: none"])');
        if (visibleRows.length === 0) {
            dept.style.display = 'none';
        } else {
            dept.style.display = '';
        }
    });
}

function exportNumbers() {
    window.location.href = '/api/export_numbers';
}

function assignNumber(numberId) {
    // Здесь можно открыть модальное окно для назначения номера
    console.log('Назначить номер:', numberId);
}

// Drag and Drop функционал для отделов
let draggedElement = null;
let draggedOverElement = null;

document.querySelectorAll('.department-card').forEach(card => {
    card.addEventListener('dragstart', function(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    });
    
    card.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        draggedElement = null;
        
        // Убираем все классы drag-over
        document.querySelectorAll('.department-card').forEach(c => {
            c.classList.remove('drag-over', 'drag-over-bottom');
        });
    });
    
    card.addEventListener('dragover', function(e) {
        if (draggedElement && draggedElement !== this) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Определяем позицию курсора относительно элемента
            const rect = this.getBoundingClientRect();
            const midPoint = rect.top + rect.height / 2;
            
            // Убираем все классы drag-over
            document.querySelectorAll('.department-card').forEach(c => {
                c.classList.remove('drag-over', 'drag-over-bottom');
            });
            
            this.classList.add('drag-over');
            if (e.clientY > midPoint) {
                this.classList.add('drag-over-bottom');
            }
            
            draggedOverElement = this;
        }
    });
    
    card.addEventListener('drop', function(e) {
        if (draggedElement && draggedElement !== this) {
            e.preventDefault();
            
            const draggedId = draggedElement.dataset.departmentId;
            const targetId = this.dataset.departmentId;
            
            // Определяем позицию (до или после)
            const rect = this.getBoundingClientRect();
            const midPoint = rect.top + rect.height / 2;
            const position = e.clientY > midPoint ? 'after' : 'before';
            
            // Отправляем запрос на сервер
            fetch('/api/update_department_positions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dragged_id: draggedId,
                    target_id: targetId,
                    position: position
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка при перемещении: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при перемещении отдела');
            });
        }
        
        // Убираем все классы drag-over
        document.querySelectorAll('.department-card').forEach(c => {
            c.classList.remove('drag-over', 'drag-over-bottom');
        });
    });
});

// Функции для продвинутых фильтров
function applyFilters() {
    const statusFilters = Array.from(document.querySelectorAll('input[name="status_filter"]:checked')).map(cb => cb.value);
    const departmentFilters = Array.from(document.querySelectorAll('input[name="department_filter"]:checked')).map(cb => cb.value);
    const assignmentFilters = Array.from(document.querySelectorAll('input[name="assignment_filter"]:checked')).map(cb => cb.value);
    
    const rows = document.querySelectorAll('.number-row');
    
    rows.forEach(row => {
        let shouldShow = true;
        
        // Фильтр по статусу
        if (statusFilters.length > 0) {
            const statusCell = row.cells[4];
            
            const matchesStatus = statusFilters.some(filter => {
                if (filter === 'whatsapp' && statusCell.querySelector('.whatsapp')) return true;
                if (filter === 'telegram' && statusCell.querySelector('.telegram')) return true;
                if (filter === 'blocked' && statusCell.querySelector('.blocked')) return true;
                if (filter === 'free' && !statusCell.querySelector('.whatsapp') && !statusCell.querySelector('.telegram') && !statusCell.querySelector('.blocked')) return true;
                return false;
            });
            
            if (!matchesStatus) shouldShow = false;
        }
        
        // Фильтр по отделам
        if (departmentFilters.length > 0) {
            const departmentCard = row.closest('.department-card');
            const departmentId = departmentCard ? departmentCard.dataset.departmentId : null;
            
            if (!departmentId || !departmentFilters.includes(departmentId)) {
                shouldShow = false;
            }
        }
        
        // Фильтр по назначению
        if (assignmentFilters.length > 0) {
            const assignedCell = row.cells[3];
            const isAssigned = assignedCell.textContent.trim() !== '—';
            
            const matchesAssignment = assignmentFilters.some(filter => {
                if (filter === 'assigned' && isAssigned) return true;
                if (filter === 'unassigned' && !isAssigned) return true;
                return false;
            });
            
            if (!matchesAssignment) shouldShow = false;
        }
        
        row.style.display = shouldShow ? '' : 'none';
    });
    
    // Скрыть пустые отделы
    updateDepartmentVisibility();
    
    closeModal('filtersModal');
}

function resetFilters() {
    document.querySelectorAll('#filtersModal input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    const rows = document.querySelectorAll('.number-row');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    // Показать все отделы
    document.querySelectorAll('.department-card').forEach(dept => {
        dept.style.display = '';
    });
    
    closeModal('filtersModal');
}
</script>
{% endblock %}
