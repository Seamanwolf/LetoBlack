{% extends "admin/settings/base.html" %}

{% block settings_content %}
<style>
    .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
    }
    
    .toast {
        background-color: white;
        border-left: 4px solid;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        min-width: 300px;
        max-width: 400px;
        margin-bottom: 10px;
        border-radius: 4px;
        padding: 10px 15px;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    
    .toast.show {
        opacity: 1;
    }
    
    .toast.success {
        border-left-color: #28a745;
    }
    
    .toast.error {
        border-left-color: #dc3545;
    }
    
    .toast.warning {
        border-left-color: #ffc107;
    }
    
    .toast.info {
        border-left-color: #17a2b8;
    }
    
    .toast-body {
        padding: 0;
    }
    
    .toast-action {
        margin-top: 10px;
        text-align: right;
    }
    
    .toast-action button {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
    
    .btn-icon {
        width: 28px;
        height: 28px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        margin: 0 2px;
    }
    
    .btn-icon i {
        font-size: 14px;
    }
    
    .actions-column {
        width: 120px;
    }
    
    .user-role-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .module-description {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .form-switch {
        padding-left: 2.5em;
    }
    
    .form-switch .form-check-input {
        width: 2em;
        height: 1em;
        margin-left: -2.5em;
    }
    
    .modal-backdrop {
        opacity: 0.5 !important;
    }
    
    .modal {
        background-color: rgba(0, 0, 0, 0.5);
    }
</style>

<!-- Контейнер для toast-уведомлений -->
<div class="toast-container"></div>

<!-- Управление ролями -->
<div class="tab-pane fade show active" id="roles">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title">Управление ролями пользователей</h5>
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRoleModal">
            <i class="fas fa-plus"></i> Добавить роль
        </button>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            showToast('Системные роли (Администратор, Руководитель, Оператор) нельзя изменить или удалить. Вы можете создавать собственные роли и настраивать права доступа.', 'info');
        });
    </script>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        showToast('{{ message }}', '{{ category }}');
                    });
                </script>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Панель статуса инициализации -->
    {% if not tables_initialized %}
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5><i class="fas fa-exclamation-triangle"></i> Требуется инициализация</h5>
                    <p>Для работы с ролями необходимо инициализировать таблицы. После инициализации будут созданы базовые роли и разрешения.</p>
                </div>
                
                <a href="{{ url_for('admin.initialize_roles_tables') }}" class="btn btn-success">
                    <i class="fas fa-database"></i> Инициализировать таблицы ролей
                </a>
            </div>
        </div>
    </div>
    {% else %}
    
    <div class="row">
        <!-- Список ролей -->
        <div class="col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Список ролей</h5>
                </div>
                <div class="card-body">
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Имя</th>
                    <th>Отображаемое имя</th>
                    <th>Тип</th>
                    <th>Описание</th>
                                    <th class="actions-column">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for role in roles %}
                <tr>
                    <td>{{ role.id }}</td>
                    <td>{{ role.name }}</td>
                    <td>{{ role.display_name }}</td>
                    <td>
                        {% if role.is_system %}
                            <span class="badge bg-primary">Системная</span>
                        {% elif role.type == 'backoffice' %}
                            <span class="badge bg-info">Бэк-офис</span>
                        {% else %}
                            <span class="badge bg-secondary">Обычная</span>
                        {% endif %}
                    </td>
                    <td>{{ role.description }}</td>
                    <td>
                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary btn-icon edit-role" 
                                    data-role-id="{{ role.id }}"
                                    data-role-name="{{ role.name }}"
                                    data-role-display="{{ role.display_name }}"
                                    data-role-type="{{ role.type }}"
                                    data-role-desc="{{ role.description }}"
                                                    data-role-system="{{ role.is_system }}"
                                                    title="Редактировать роль">
                                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            {% if not role.is_system %}
                                            <button type="button" class="btn btn-sm btn-outline-danger btn-icon delete-role" 
                                    data-role-id="{{ role.id }}" 
                                                    data-role-name="{{ role.display_name }}"
                                                    title="Удалить роль">
                                                <i class="fas fa-trash-alt"></i>
                            </button>
                            {% endif %}
                                            <button type="button" class="btn btn-sm btn-outline-info btn-icon edit-permissions" 
                                    data-role-id="{{ role.id }}"
                                                    data-role-name="{{ role.display_name }}"
                                                    title="Управление разрешениями">
                                                <i class="fas fa-key"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
                    </div>
                </div>
            </div>
    </div>
    </div>
    
    {% endif %}
</div>

<!-- Модальное окно для добавления роли -->
<div class="modal fade" id="addRoleModal" tabindex="-1" aria-labelledby="addRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRoleModalLabel">Добавление новой роли</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addRoleForm" action="{{ url_for('roles.add_role') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="roleName" class="form-label">Системное имя</label>
                        <input type="text" class="form-control" id="roleName" name="name" required
                               pattern="[a-z0-9_]+" title="Только латинские буквы, цифры и подчеркивания">
                        <div class="form-text">Используется в системе. Только латинские буквы, цифры и подчеркивания.</div>
                    </div>
                    <div class="mb-3">
                        <label for="roleDisplayName" class="form-label">Отображаемое имя</label>
                        <input type="text" class="form-control" id="roleDisplayName" name="display_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="roleType" class="form-label">Тип роли</label>
                        <select class="form-select" id="roleType" name="role_type">
                            <option value="backoffice">Бэк-офис</option>
                            <option value="custom">Обычная</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="roleDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="roleDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования роли -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-labelledby="editRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRoleModalLabel">Редактирование роли</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editRoleForm" action="{{ url_for('roles.update_role') }}" method="post">
                <input type="hidden" id="editRoleId" name="role_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editRoleName" class="form-label">Системное имя</label>
                        <input type="text" class="form-control" id="editRoleName" name="name" readonly>
                        <div class="form-text">Системное имя нельзя изменить.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editRoleDisplayName" class="form-label">Отображаемое имя</label>
                        <input type="text" class="form-control" id="editRoleDisplayName" name="display_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRoleType" class="form-label">Тип роли</label>
                        <select class="form-select" id="editRoleType" name="role_type">
                            <option value="backoffice">Бэк-офис</option>
                            <option value="custom">Обычная</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editRoleDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="editRoleDescription" name="description" rows="3"></textarea>
                    </div>
                    <div id="systemRoleWarning" class="text-warning d-none">
                        <i class="fas fa-exclamation-triangle"></i> Системную роль нельзя изменить. Вы можете только отредактировать описание.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования разрешений -->
<div class="modal fade" id="editPermissionsModal" tabindex="-1" aria-labelledby="editPermissionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPermissionsModalLabel">Настройка разрешений роли: <span id="permissionRoleName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editPermissionsForm" action="{{ url_for('roles.update_role_permissions') }}" method="post">
                <input type="hidden" id="permissionRoleId" name="role_id">
                <div class="modal-body">
                    <p class="mb-3">Укажите, к каким модулям системы роль будет иметь доступ и какие действия сможет выполнять:</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Модуль</th>
                                    <th class="text-center">Просмотр</th>
                                    <th class="text-center">Создание</th>
                                    <th class="text-center">Редактирование</th>
                                    <th class="text-center">Удаление</th>
                                </tr>
                            </thead>
                            <tbody id="permissionsTableBody">
                                <!-- Здесь будут модули и их разрешения -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить разрешения</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteRoleModal" tabindex="-1" aria-labelledby="deleteRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRoleModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы действительно хотите удалить роль "<span id="deleteRoleName"></span>"?</p>
                <p class="text-danger small">Это действие нельзя отменить. Убедитесь, что роль не назначена пользователям.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
                <form id="deleteRoleForm" action="{{ url_for('roles.delete_role') }}" method="post">
                    <input type="hidden" id="deleteRoleId" name="role_id">
                    <button type="submit" class="btn btn-danger btn-sm">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для отображения пользователей роли -->
<div class="modal fade" id="roleUsersModal" tabindex="-1" aria-labelledby="roleUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleUsersModalLabel">Пользователи роли: <span id="roleUsersRoleName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Email</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="roleUsersTableBody">
                            <!-- Здесь будет список пользователей -->
                        </tbody>
                    </table>
                </div>
                
                <div class="user-role-actions">
                    <button type="button" class="btn btn-warning" id="changeRoleForAll">
                        <i class="fas fa-exchange-alt"></i> Сменить роль для всех
                    </button>
                    <button type="button" class="btn btn-danger" id="removeRoleFromAll">
                        <i class="fas fa-user-minus"></i> Удалить роль у всех
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для смены роли -->
<div class="modal fade" id="changeRoleModal" tabindex="-1" aria-labelledby="changeRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeRoleModalLabel">Смена роли</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="changeRoleForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newRoleSelect" class="form-label">Выберите новую роль</label>
                        <select class="form-select" id="newRoleSelect" name="new_role_id" required>
                            <!-- Здесь будут доступные роли -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сменить роль</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для отображения пользователей с ролью при попытке удаления -->
<div class="modal fade" id="roleUsersDeleteModal" tabindex="-1" aria-labelledby="roleUsersDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleUsersDeleteModalLabel">Невозможно удалить роль</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-warning">
                    <i class="fas fa-exclamation-triangle"></i> Роль "<span id="deleteRoleUsersName"></span>" назначена пользователям и не может быть удалена.
                </p>
                
                <p>Выберите действие:</p>
                
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-info btn-sm" id="viewRoleUsers">
                        <i class="fas fa-users"></i> Посмотреть список
                    </button>
                    <button type="button" class="btn btn-warning btn-sm" id="changeRoleForAllUsers">
                        <i class="fas fa-exchange-alt"></i> Сменить роль для всех
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" id="removeRoleFromAllUsers">
                        <i class="fas fa-user-minus"></i> Удалить роль у всех
                    </button>
                </div>
                
                <div id="roleUsersList" class="d-none">
                    <h6 class="mt-4">Пользователи с этой ролью:</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Имя</th>
                                    <th>Email</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="roleUsersDeleteTableBody">
                                <!-- Здесь будет список пользователей -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Проверка, что jQuery и Bootstrap загружены
    if (typeof jQuery === 'undefined') {
        console.error('jQuery не загружен!');
        return;
    }
    
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap не загружен!');
        return;
    }
    
    console.log('Инициализация обработчиков событий для страницы ролей');
    
    // Автоматическое создание системного имени из отображаемого имени
        $('#roleDisplayName').on('input', function() {
            var displayName = $(this).val().toLowerCase();
            var systemName = displayName
                .replace(/[^a-z0-9\s_]/g, '')
                .replace(/\s+/g, '_');
            $('#roleName').val(systemName);
        });
        
    // Обработчик для редактирования роли
    $('.edit-role').on('click', function() {
        console.log('Клик по кнопке редактирования роли');
            var roleId = $(this).data('role-id');
            var roleName = $(this).data('role-name');
            var roleDisplay = $(this).data('role-display');
            var roleType = $(this).data('role-type');
            var roleDesc = $(this).data('role-desc');
        var isSystem = $(this).data('role-system') === 'True' || $(this).data('role-system') === true;
            
            $('#editRoleId').val(roleId);
            $('#editRoleName').val(roleName);
            $('#editRoleDisplayName').val(roleDisplay);
            $('#editRoleType').val(roleType);
            $('#editRoleDescription').val(roleDesc);
            
        // Для системных ролей отключаем возможность редактирования некоторых полей
            if (isSystem) {
                $('#editRoleDisplayName').prop('readonly', true);
                $('#editRoleType').prop('disabled', true);
            $('#systemRoleWarning').removeClass('d-none');
            } else {
                $('#editRoleDisplayName').prop('readonly', false);
                $('#editRoleType').prop('disabled', false);
            $('#systemRoleWarning').addClass('d-none');
            }
            
        var editModal = new bootstrap.Modal(document.getElementById('editRoleModal'));
        editModal.show();
        });
        
    // Обработчик для удаления роли
    $('.delete-role').on('click', function() {
        console.log('Клик по кнопке удаления роли');
            var roleId = $(this).data('role-id');
            var roleName = $(this).data('role-name');
            
        // Показываем модальное окно подтверждения
            $('#deleteRoleId').val(roleId);
            $('#deleteRoleName').text(roleName);
            
        var deleteModal = new bootstrap.Modal(document.getElementById('deleteRoleModal'));
        deleteModal.show();
    });
    
    // Обработчик формы удаления роли
    $('#deleteRoleForm').on('submit', function(e) {
        e.preventDefault();
        var roleId = $('#deleteRoleId').val();
        var roleName = $('#deleteRoleName').text();
        
        // Пытаемся удалить роль
        $.ajax({
            url: '{{ url_for("roles.delete_role") }}',
            type: 'POST',
            data: { role_id: roleId },
            success: function(response) {
                if (response.success) {
                    showToast('Роль успешно удалена', 'success');
                    // Удаляем строку из таблицы
                    $(`button[data-role-id="${roleId}"]`).closest('tr').fadeOut(300, function() {
                        $(this).remove();
                    });
                } else {
                    if (response.error === 'role_has_users') {
                        // Показываем toast-уведомление с кнопкой
                        showToastWithAction('Невозможно удалить роль, так как она используется', 'error', 'Посмотреть список', function() {
                            // Получаем ID роли из скрытого поля
                            const roleId = $('#permissionRoleId').val();
                            
                            // Открываем модальное окно с пользователями
                            $('#roleUsersList').removeClass('d-none');
                            loadRoleUsersForDelete(roleId);
                            
                            var roleUsersDeleteModal = new bootstrap.Modal(document.getElementById('roleUsersDeleteModal'));
                            roleUsersDeleteModal.show();
                        });
                        
                        // Показываем модальное окно с пользователями
                        $('#deleteRoleUsersName').text(roleName);
                        $('#permissionRoleId').val(roleId);
                        
                        // Закрываем модальное окно подтверждения
                        $('#deleteRoleModal').modal('hide');
                        
                        // Открываем модальное окно с пользователями
                        var roleUsersDeleteModal = new bootstrap.Modal(document.getElementById('roleUsersDeleteModal'));
                        roleUsersDeleteModal.show();
                    } else {
                        showToast(response.message || 'Произошла ошибка при удалении роли', 'error');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Ошибка при удалении роли:', error);
                showToast('Произошла ошибка при удалении роли: ' + error, 'error');
            }
        });
    });
    
    // Обработчик для редактирования разрешений роли
    $('.edit-permissions').on('click', function() {
        console.log('Клик по кнопке редактирования разрешений');
            var roleId = $(this).data('role-id');
            var roleName = $(this).data('role-name');
            
            $('#permissionRoleId').val(roleId);
            $('#permissionRoleName').text(roleName);
            
        // Загружаем данные разрешений для роли
        $.getJSON('/admin/settings/roles/get_role_permissions/' + roleId, function(roleData) {
            // Загружаем список всех модулей
            $.getJSON('/admin/settings/roles/get_modules', function(modulesData) {
                const tbody = $('#permissionsTableBody');
                tbody.empty();
                
                // Создаем карту разрешений для быстрого доступа
                const permissionsMap = {};
                roleData.permissions.forEach(function(permission) {
                    permissionsMap[permission.module_id] = permission;
                });
                
                // Добавляем строки для каждого модуля
                modulesData.modules.forEach(function(module) {
                    const permission = permissionsMap[module.id] || {
                        can_view: false,
                        can_create: false,
                        can_edit: false,
                        can_delete: false
                    };
                    
                    const row = `
                        <tr>
                            <td>
                                ${module.display_name || module.name}
                                <div class="module-description">${module.description || 'Нет описания'}</div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch justify-content-center">
                                    <input class="form-check-input" type="checkbox" name="permissions[${module.id}][view]" 
                                           id="perm_${module.id}_view" ${permission.can_view ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch justify-content-center">
                                    <input class="form-check-input" type="checkbox" name="permissions[${module.id}][create]" 
                                           id="perm_${module.id}_create" ${permission.can_create ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch justify-content-center">
                                    <input class="form-check-input" type="checkbox" name="permissions[${module.id}][edit]" 
                                           id="perm_${module.id}_edit" ${permission.can_edit ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch justify-content-center">
                                    <input class="form-check-input" type="checkbox" name="permissions[${module.id}][delete]" 
                                           id="perm_${module.id}_delete" ${permission.can_delete ? 'checked' : ''}>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    tbody.append(row);
                });
                
                // Отображаем модальное окно
                var permissionsModal = new bootstrap.Modal(document.getElementById('editPermissionsModal'));
                permissionsModal.show();
            });
        });
    });
    
    // Загрузка пользователей роли для удаления
    function loadRoleUsersForDelete(roleId) {
        $.getJSON('/admin/settings/roles/get_role_users/' + roleId, function(data) {
            const tbody = $('#roleUsersDeleteTableBody');
            tbody.empty();
            
            data.users.forEach(function(user) {
                tbody.append(`
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-icon remove-user-role-delete" 
                                    data-user-id="${user.id}" title="Удалить роль">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        });
    }
    
    // Загрузка пользователей роли
    function loadRoleUsers(roleId) {
        $.getJSON('/admin/settings/roles/get_role_users/' + roleId, function(data) {
            const tbody = $('#roleUsersTableBody');
            tbody.empty();
            
            data.users.forEach(function(user) {
                tbody.append(`
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-icon remove-user-role" 
                                    data-user-id="${user.id}" title="Удалить роль">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // Загружаем список доступных ролей для смены
            loadAvailableRoles(roleId);
        });
    }
    
    // Загрузка доступных ролей
    function loadAvailableRoles(currentRoleId) {
        $.getJSON('/admin/settings/roles/get_available_roles', function(data) {
            const select = $('#newRoleSelect');
            select.empty();
            
            data.roles.forEach(function(role) {
                if (role.id != currentRoleId) {
                    select.append(`<option value="${role.id}">${role.display_name}</option>`);
                }
            });
        });
    }
    
    // Показать список пользователей при попытке удаления роли
    $('#viewRoleUsers').on('click', function() {
        $('#roleUsersList').removeClass('d-none');
        loadRoleUsersForDelete($('#permissionRoleId').val());
    });
    
    // Смена роли для всех пользователей при попытке удаления
    $('#changeRoleForAllUsers').on('click', function() {
        const roleId = $('#permissionRoleId').val();
        
        // Загружаем список доступных ролей
        $.getJSON('/admin/settings/roles/get_available_roles', function(data) {
            const select = $('#newRoleSelect');
            select.empty();
            
            data.roles.forEach(function(role) {
                if (role.id != roleId) {
                    select.append(`<option value="${role.id}">${role.display_name}</option>`);
                }
            });
            
            // Закрываем текущее модальное окно
            $('#roleUsersDeleteModal').modal('hide');
            
            // Открываем модальное окно смены роли
            var changeRoleModal = new bootstrap.Modal(document.getElementById('changeRoleModal'));
            changeRoleModal.show();
        });
    });
    
    // Удаление роли у всех пользователей при попытке удаления
    $('#removeRoleFromAllUsers').on('click', function() {
        showConfirmModal(
            'Подтверждение удаления',
            'Вы действительно хотите удалить роль у всех пользователей?',
            function() {
                const roleId = $('#permissionRoleId').val();
                
                $.ajax({
                    url: '/admin/settings/roles/remove_role_from_all_users',
                    type: 'POST',
                    data: { role_id: roleId },
                    success: function(response) {
                        if (response.success) {
                            showToast('Роль успешно удалена у всех пользователей', 'success');
                            $('#roleUsersDeleteModal').modal('hide');
                            
                            // Удаляем роль после успешного удаления у всех пользователей
                            $.ajax({
                                url: '/admin/settings/roles/delete_role',
                                type: 'POST',
                                data: { role_id: roleId },
                                success: function(deleteResponse) {
                                    if (deleteResponse.success) {
                                        showToast('Роль успешно удалена', 'success');
                                        location.reload();
                                    } else {
                                        showToast(deleteResponse.message || 'Произошла ошибка при удалении роли', 'error');
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Ошибка при удалении роли:', error);
                                    showToast('Произошла ошибка при удалении роли: ' + error, 'error');
                                }
                            });
                        } else {
                            showToast(response.message || 'Произошла ошибка', 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Ошибка при удалении роли у всех пользователей:', error);
                        showToast('Произошла ошибка при удалении роли: ' + error, 'error');
                    }
                });
            }
        );
    });
    
    // Удаление роли у пользователя
    $(document).on('click', '.remove-user-role', function() {
        const userId = $(this).data('user-id');
        const roleId = $('#permissionRoleId').val();
        
        $.ajax({
            url: '/admin/settings/roles/remove_role_from_user',
            type: 'POST',
            data: { user_id: userId, role_id: roleId },
            success: function(response) {
                if (response.success) {
                    showToast('Роль успешно удалена у пользователя', 'success');
                    $(`button[data-user-id="${userId}"]`).closest('tr').fadeOut(300, function() {
                        $(this).remove();
                    });
                } else {
                    showToast(response.message || 'Произошла ошибка', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Ошибка при удалении роли у пользователя:', error);
                showToast('Произошла ошибка при удалении роли: ' + error, 'error');
            }
        });
    });
    
    // Удаление роли у пользователя при попытке удаления роли
    $(document).on('click', '.remove-user-role-delete', function() {
        const userId = $(this).data('user-id');
        const roleId = $('#permissionRoleId').val();
        
        $.ajax({
            url: '/admin/settings/roles/remove_role_from_user',
            type: 'POST',
            data: { user_id: userId, role_id: roleId },
            success: function(response) {
                if (response.success) {
                    showToast('Роль успешно удалена у пользователя', 'success');
                    $(`button[data-user-id="${userId}"]`).closest('tr').fadeOut(300, function() {
                        $(this).remove();
                    });
                    
                    // Проверяем, остались ли пользователи с этой ролью
                    if ($('#roleUsersDeleteTableBody tr:visible').length === 0) {
                        showToast('Роль успешно удалена у всех пользователей', 'success');
                        $('#roleUsersDeleteModal').modal('hide');
                        
                        // Удаляем строку из таблицы
                        $(`button[data-role-id="${roleId}"]`).closest('tr').fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                } else {
                    showToast(response.message || 'Произошла ошибка', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Ошибка при удалении роли у пользователя:', error);
                showToast('Произошла ошибка при удалении роли: ' + error, 'error');
            }
        });
    });
    
    // Смена роли для всех пользователей
    $('#changeRoleForAll').on('click', function() {
        var changeRoleModal = new bootstrap.Modal(document.getElementById('changeRoleModal'));
        changeRoleModal.show();
    });
    
    // Обработка формы смены роли
    $('#changeRoleForm').on('submit', function(e) {
        e.preventDefault();
        const roleId = $('#permissionRoleId').val();
        const newRoleId = $('#newRoleSelect').val();
        
        $.ajax({
            url: '/admin/settings/roles/change_role_for_all_users',
            type: 'POST',
            data: { role_id: roleId, new_role_id: newRoleId },
            success: function(response) {
                if (response.success) {
                    showToast('Роль успешно изменена для всех пользователей', 'success');
                    $('#changeRoleModal').modal('hide');
                    $('#roleUsersModal').modal('hide');
                    
                    // Удаляем роль после успешного перемещения всех пользователей
                    $.ajax({
                        url: '/admin/settings/roles/delete_role',
                        type: 'POST',
                        data: { role_id: roleId },
                        success: function(deleteResponse) {
                            if (deleteResponse.success) {
                                showToast('Роль успешно удалена', 'success');
                                location.reload();
                            } else {
                                showToast(deleteResponse.message || 'Произошла ошибка при удалении роли', 'error');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Ошибка при удалении роли:', error);
                            showToast('Произошла ошибка при удалении роли: ' + error, 'error');
                        }
                    });
                } else {
                    showToast(response.message || 'Произошла ошибка', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Ошибка при смене роли:', error);
                showToast('Произошла ошибка при смене роли: ' + error, 'error');
            }
        });
    });
    
    // Удаление роли у всех пользователей
    $('#removeRoleFromAll').on('click', function() {
        showConfirmModal(
            'Подтверждение удаления',
            'Вы действительно хотите удалить роль у всех пользователей?',
            function() {
                const roleId = $('#permissionRoleId').val();
                
                $.ajax({
                    url: '/admin/settings/roles/remove_role_from_all_users',
                    type: 'POST',
                    data: { role_id: roleId },
                    success: function(response) {
                        if (response.success) {
                            showToast('Роль успешно удалена у всех пользователей', 'success');
                            $('#roleUsersModal').modal('hide');
                            
                            // Удаляем роль после успешного удаления у всех пользователей
                            $.ajax({
                                url: '/admin/settings/roles/delete_role',
                                type: 'POST',
                                data: { role_id: roleId },
                                success: function(deleteResponse) {
                                    if (deleteResponse.success) {
                                        showToast('Роль успешно удалена', 'success');
                                        location.reload();
                                    } else {
                                        showToast(deleteResponse.message || 'Произошла ошибка при удалении роли', 'error');
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('Ошибка при удалении роли:', error);
                                    showToast('Произошла ошибка при удалении роли: ' + error, 'error');
                                }
                            });
                        } else {
                            showToast(response.message || 'Произошла ошибка', 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Ошибка при удалении роли у всех пользователей:', error);
                        showToast('Произошла ошибка при удалении роли: ' + error, 'error');
                    }
                });
            }
        );
    });
    
    // Валидация системного имени
    $('#roleName').on('input', function() {
        this.value = this.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
    });
    
    // Инициализация тултипов
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Исправление проблемы с серым экраном при закрытии модальных окон
    $('.modal').on('hidden.bs.modal', function() {
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open').css('padding-right', '');
    });
});

// Функция для показа toast-уведомлений
function showToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-body">
            ${message}
        </div>
    `;
    toastContainer.appendChild(toast);
    
    // Добавляем класс show после небольшой задержки
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 5000);
}

// Функция для показа toast-уведомлений с кнопкой действия
function showToastWithAction(message, type, actionText, actionCallback) {
    const toastContainer = document.querySelector('.toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-body">
            ${message}
            <div class="toast-action">
                <button class="btn btn-sm btn-outline-primary" id="toast-action-button">${actionText}</button>
            </div>
        </div>
    `;
    toastContainer.appendChild(toast);
    
    // Добавляем класс show после небольшой задержки
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Добавляем обработчик для кнопки
    document.getElementById('toast-action-button').addEventListener('click', function() {
        actionCallback();
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    });
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 5000);
}

// Функция для показа модального окна с подтверждением
function showConfirmModal(title, message, confirmCallback) {
    const modalHtml = `
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmModalLabel">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" id="confirmButton">Подтвердить</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Удаляем предыдущее модальное окно, если оно существует
    const existingModal = document.getElementById('confirmModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Добавляем новое модальное окно в DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Получаем ссылки на элементы
    const modal = document.getElementById('confirmModal');
    const confirmButton = document.getElementById('confirmButton');
    
    // Добавляем обработчик для кнопки подтверждения
    confirmButton.addEventListener('click', function() {
        confirmCallback();
        bootstrap.Modal.getInstance(modal).hide();
    });
    
    // Показываем модальное окно
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Удаляем модальное окно после закрытия
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
}

function deleteRole(roleId) {
    showConfirmModal(
        'Подтверждение удаления',
        'Вы уверены, что хотите удалить эту роль?',
        function() {
            $.ajax({
                url: '/admin/settings/roles/delete/' + roleId,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showToast('Роль успешно удалена', 'success');
                        location.reload();
                    } else if (response.error === 'role_has_users') {
                        showToast('Невозможно удалить роль, так как она назначена пользователям', 'error');
                    } else {
                        showToast('Ошибка при удалении роли: ' + (response.error || 'Неизвестная ошибка'), 'error');
                    }
                },
                error: function(xhr) {
                    showToast('Ошибка при удалении роли: ' + (xhr.responseJSON?.error || 'Неизвестная ошибка'), 'error');
                }
            });
        }
    );
}
</script>
{% endblock %}

{% endblock %} 