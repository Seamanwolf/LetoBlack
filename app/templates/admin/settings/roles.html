{% extends "admin/settings/base.html" %}

{% block settings_content %}
<!-- Управление ролями -->
<div class="tab-pane fade show active" id="roles">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title">Управление ролями пользователей</h5>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRoleModal">
            <i class="fas fa-plus"></i> Добавить роль
        </button>
    </div>
    
    <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle"></i> Системные роли (Администратор, Руководитель, Оператор) нельзя изменить или удалить. Вы можете создавать собственные роли и настраивать права доступа.
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Панель статуса инициализации -->
    {% if not tables_initialized %}
    <div class="card mb-4">
        <div class="card-body">
            <div class="alert alert-warning">
                <h5><i class="fas fa-exclamation-triangle"></i> Требуется инициализация</h5>
                <p>Для работы с ролями необходимо инициализировать таблицы. После инициализации будут созданы базовые роли и разрешения.</p>
                
                <a href="{{ url_for('admin.initialize_roles_tables') }}" class="btn btn-success">
                    <i class="fas fa-database"></i> Инициализировать таблицы ролей
                </a>
            </div>
        </div>
    </div>
    {% else %}
    
    <div class="row">
        <!-- Список ролей -->
        <div class="col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Список ролей</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Имя</th>
                                    <th>Отображаемое имя</th>
                                    <th>Тип</th>
                                    <th>Описание</th>
                                    <th width="250">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for role in roles %}
                                <tr>
                                    <td>{{ role.id }}</td>
                                    <td>{{ role.name }}</td>
                                    <td>{{ role.display_name }}</td>
                                    <td>
                                        {% if role.is_system %}
                                            <span class="badge bg-primary">Системная</span>
                                        {% elif role.type == 'backoffice' %}
                                            <span class="badge bg-info">Бэк-офис</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Обычная</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ role.description }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-primary edit-role" 
                                                    data-role-id="{{ role.id }}"
                                                    data-role-name="{{ role.name }}"
                                                    data-role-display="{{ role.display_name }}"
                                                    data-role-type="{{ role.type }}"
                                                    data-role-desc="{{ role.description }}"
                                                    data-role-system="{{ role.is_system }}">
                                                <i class="fas fa-edit"></i> Редактировать
                                            </button>
                                            {% if not role.is_system %}
                                            <button type="button" class="btn btn-sm btn-danger delete-role" 
                                                    data-role-id="{{ role.id }}" 
                                                    data-role-name="{{ role.display_name }}">
                                                <i class="fas fa-trash"></i> Удалить
                                            </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-sm btn-info edit-permissions" 
                                                    data-role-id="{{ role.id }}"
                                                    data-role-name="{{ role.display_name }}">
                                                <i class="fas fa-key"></i> Разрешения
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% endif %}
</div>

<!-- Модальное окно для добавления роли -->
<div class="modal fade" id="addRoleModal" tabindex="-1" aria-labelledby="addRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRoleModalLabel">Добавление новой роли</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addRoleForm" action="{{ url_for('roles.add_role') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="roleName" class="form-label">Системное имя</label>
                        <input type="text" class="form-control" id="roleName" name="name" required
                               pattern="[a-z0-9_]+" title="Только латинские буквы, цифры и подчеркивания">
                        <div class="form-text">Используется в системе. Только латинские буквы, цифры и подчеркивания.</div>
                    </div>
                    <div class="mb-3">
                        <label for="roleDisplayName" class="form-label">Отображаемое имя</label>
                        <input type="text" class="form-control" id="roleDisplayName" name="display_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="roleType" class="form-label">Тип роли</label>
                        <select class="form-select" id="roleType" name="role_type">
                            <option value="backoffice">Бэк-офис</option>
                            <option value="custom">Обычная</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="roleDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="roleDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования роли -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-labelledby="editRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRoleModalLabel">Редактирование роли</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editRoleForm" action="{{ url_for('roles.update_role') }}" method="post">
                <input type="hidden" id="editRoleId" name="role_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editRoleName" class="form-label">Системное имя</label>
                        <input type="text" class="form-control" id="editRoleName" name="name" readonly>
                        <div class="form-text">Системное имя нельзя изменить.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editRoleDisplayName" class="form-label">Отображаемое имя</label>
                        <input type="text" class="form-control" id="editRoleDisplayName" name="display_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRoleType" class="form-label">Тип роли</label>
                        <select class="form-select" id="editRoleType" name="role_type">
                            <option value="backoffice">Бэк-офис</option>
                            <option value="custom">Обычная</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editRoleDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="editRoleDescription" name="description" rows="3"></textarea>
                    </div>
                    <div id="systemRoleWarning" class="alert alert-warning d-none">
                        <i class="fas fa-exclamation-triangle"></i> Системную роль нельзя изменить. Вы можете только отредактировать описание.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования разрешений -->
<div class="modal fade" id="editPermissionsModal" tabindex="-1" aria-labelledby="editPermissionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPermissionsModalLabel">Настройка разрешений роли: <span id="permissionRoleName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editPermissionsForm" action="{{ url_for('roles.update_role_permissions') }}" method="post">
                <input type="hidden" id="permissionRoleId" name="role_id">
                <div class="modal-body">
                    <p class="mb-3">Укажите, к каким модулям системы роль будет иметь доступ и какие действия сможет выполнять:</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Модуль</th>
                                    <th class="text-center">Просмотр</th>
                                    <th class="text-center">Создание</th>
                                    <th class="text-center">Редактирование</th>
                                    <th class="text-center">Удаление</th>
                                </tr>
                            </thead>
                            <tbody id="permissionsTableBody">
                                <!-- Здесь будут модули и их разрешения -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить разрешения</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteRoleModal" tabindex="-1" aria-labelledby="deleteRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRoleModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы действительно хотите удалить роль "<span id="deleteRoleName"></span>"?</p>
                <p class="text-danger">Это действие нельзя отменить. Убедитесь, что роль не назначена пользователям.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form id="deleteRoleForm" action="{{ url_for('roles.delete_role') }}" method="post">
                    <input type="hidden" id="deleteRoleId" name="role_id">
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Автоматическое создание системного имени из отображаемого имени
    $('#roleDisplayName').on('input', function() {
        var displayName = $(this).val().toLowerCase();
        var systemName = displayName
            .replace(/[^a-z0-9\s_]/g, '')
            .replace(/\s+/g, '_');
        $('#roleName').val(systemName);
    });
    
    // Обработчик для редактирования роли
    $('.edit-role').click(function() {
        var roleId = $(this).data('role-id');
        var roleName = $(this).data('role-name');
        var roleDisplay = $(this).data('role-display');
        var roleType = $(this).data('role-type');
        var roleDesc = $(this).data('role-desc');
        var isSystem = $(this).data('role-system') === 'True' || $(this).data('role-system') === true;
        
        $('#editRoleId').val(roleId);
        $('#editRoleName').val(roleName);
        $('#editRoleDisplayName').val(roleDisplay);
        $('#editRoleType').val(roleType);
        $('#editRoleDescription').val(roleDesc);
        
        // Для системных ролей отключаем возможность редактирования некоторых полей
        if (isSystem) {
            $('#editRoleDisplayName').prop('readonly', true);
            $('#editRoleType').prop('disabled', true);
            $('#systemRoleWarning').removeClass('d-none');
        } else {
            $('#editRoleDisplayName').prop('readonly', false);
            $('#editRoleType').prop('disabled', false);
            $('#systemRoleWarning').addClass('d-none');
        }
        
        $('#editRoleModal').modal('show');
    });
    
    // Обработчик для удаления роли
    $('.delete-role').click(function() {
        var roleId = $(this).data('role-id');
        var roleName = $(this).data('role-name');
        
        $('#deleteRoleId').val(roleId);
        $('#deleteRoleName').text(roleName);
        
        $('#deleteRoleModal').modal('show');
    });
    
    // Обработчик для редактирования разрешений
    $('.edit-permissions').click(function() {
        var roleId = $(this).data('role-id');
        var roleName = $(this).data('role-name');
        
        $('#permissionRoleId').val(roleId);
        $('#permissionRoleName').text(roleName);
        
        // Загружаем разрешения для роли через AJAX
        $.getJSON('{{ url_for("roles.get_role_permissions", role_id=0) }}'.replace('0', roleId), function(data) {
            // Очищаем таблицу
            $('#permissionsTableBody').empty();
            
            // Загружаем список модулей
            $.getJSON('{{ url_for("roles.get_modules") }}', function(moduleData) {
                const permissions = data.permissions;
                const modules = moduleData.modules;
                
                // Создаем строки таблицы для каждого модуля
                modules.forEach(function(module) {
                    // Ищем разрешения для текущего модуля
                    const modulePermission = permissions.find(p => p.module_name === module.name) || {
                        can_view: false,
                        can_create: false,
                        can_edit: false,
                        can_delete: false
                    };
                    
                    // Формируем строку таблицы
                    var row = `
                    <tr>
                        <td>
                            <strong>${module.display_name}</strong>
                            <div class="text-muted small">${module.description || ''}</div>
                            <input type="hidden" name="module_ids[]" value="${module.id}">
                        </td>
                        <td class="text-center">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input permission-checkbox" type="checkbox" 
                                       name="permissions[${module.id}][view]" value="1"
                                       id="view_${module.id}" ${modulePermission.can_view ? 'checked' : ''}>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input permission-checkbox" type="checkbox" 
                                       name="permissions[${module.id}][create]" value="1"
                                       id="create_${module.id}" ${modulePermission.can_create ? 'checked' : ''}>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input permission-checkbox" type="checkbox" 
                                       name="permissions[${module.id}][edit]" value="1"
                                       id="edit_${module.id}" ${modulePermission.can_edit ? 'checked' : ''}>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input permission-checkbox" type="checkbox" 
                                       name="permissions[${module.id}][delete]" value="1"
                                       id="delete_${module.id}" ${modulePermission.can_delete ? 'checked' : ''}>
                            </div>
                        </td>
                    </tr>
                    `;
                    
                    // Добавляем строку в таблицу
                    $('#permissionsTableBody').append(row);
                });
            });
        });
        
        $('#editPermissionsModal').modal('show');
    });
    
    // Отправка формы разрешений через AJAX
    $('#editPermissionsForm').on('submit', function(e) {
        e.preventDefault();
        var formData = $(this).serialize();
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                $('#editPermissionsModal').modal('hide');
                
                // Показываем уведомление об успехе
                var alert = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    Разрешения успешно обновлены
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                $('#roles').prepend(alert);
            },
            error: function(xhr) {
                var errorMsg = 'Произошла ошибка при обновлении разрешений';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                
                // Показываем уведомление об ошибке
                var alert = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    ${errorMsg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                $('#editPermissionsModal .modal-body').prepend(alert);
            }
        });
    });
});
</script>
{% endblock %} 