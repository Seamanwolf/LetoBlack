{% extends 'admin/settings/base.html' %}

{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personnel_clean.css') }}">
{% endblock %}

{% block settings_content %}
<div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0"><i class="fas fa-database me-2"></i>Базы данных</h5>
        <div class="d-flex gap-2">
            <button id="optimizeBtn" class="btn btn-sm btn-outline-primary"><i class="fas fa-broom"></i> Оптимизировать</button>
            <a href="{{ url_for('admin_database.backup_db') }}" class="btn btn-sm btn-outline-success"><i class="fas fa-download"></i> Скачать бэкап</a>
            <label class="btn btn-sm btn-outline-warning mb-0" for="restoreInput"><i class="fas fa-upload"></i> Восстановить</label>
            <input type="file" id="restoreInput" accept=".sql" style="display:none">
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover table-sm align-middle" id="dbTable">
                <thead class="table-light">
                    <tr>
                        <th>Таблица</th>
                        <th>Строк</th>
                        <th>Размер (MB)</th>
                        <th>Дата обновления</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tbody = document.querySelector('#dbTable tbody');
    function loadTables() {
        fetch("{{ url_for('admin_database.get_tables') }}")
            .then(r => r.json())
            .then(d => {
                if (!d.success) { showToast(d.message, 'error'); return; }
                tbody.innerHTML = '';
                d.tables.forEach(t => {
                    const sizeMB = (t.Data_length + t.Index_length) / (1024*1024);
                    const row = `<tr><td>${t.Name}</td><td>${t.Rows}</td><td>${sizeMB.toFixed(2)}</td><td>${t.Update_time || ''}</td></tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            });
    }
    loadTables();

    document.getElementById('optimizeBtn').addEventListener('click', () => {
        if (!confirm('Оптимизировать все таблицы?')) return;
        fetch("{{ url_for('admin_database.optimize_db') }}", {method:'POST'})
            .then(r=>r.json()).then(d=>{
                showToast(d.message, d.success?'success':'error');
                if (d.success) loadTables();
            });
    });

    const restoreInput = document.getElementById('restoreInput');
    restoreInput.addEventListener('change', () => {
        const file = restoreInput.files[0];
        if (!file) return;
        if(!confirm('Восстановить базу данных из выбранного дампа? Это перезапишет существующие данные.')) { restoreInput.value=''; return; }
        const fd = new FormData();
        fd.append('sql_file', file);
        fetch("{{ url_for('admin_database.restore_db') }}", {method:'POST', body:fd})
            .then(r=>r.json())
            .then(d=>{
                showToast(d.message, d.success?'success':'error');
                if(d.success) loadTables();
                restoreInput.value='';
            });
    });
});
</script>
{% endblock %} 