{% extends "base.html" %}

{% block title %}Настройки системы{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings_clean.css') }}">
{% endblock %}

{% block content %}
<!-- Заголовок страницы -->
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-cog"></i>
        Настройки системы
    </h1>
    <p class="page-subtitle">Управление конфигурацией и внешним видом системы</p>
</div>

<!-- Навигационное меню настроек -->
<div class="settings-nav">
    <a href="{{ url_for('admin.settings') }}" class="active">
        <i class="fas fa-cog"></i>
        Общие настройки
    </a>
    <a href="{{ url_for('admin_organization.index') }}">
        <i class="fas fa-building"></i>
        Организация
    </a>
    <a href="#">
        <i class="fas fa-database"></i>
        База данных
    </a>
    <a href="#">
        <i class="fas fa-shield-alt"></i>
        Безопасность
    </a>
    <a href="{{ url_for('roles.index') }}">
        <i class="fas fa-user-tag"></i>
        Роли пользователей
    </a>
    <a href="#">
        <i class="fas fa-bell"></i>
        Уведомления
    </a>
    <a href="{{ url_for('admin.settings_logs') }}" {% if active_tab == 'logs' %}class="active"{% endif %}>
        <i class="fas fa-file-alt"></i>
        Логи системы
    </a>
</div>

<!-- Сетка настроек -->
<div class="settings-grid">
    <!-- Загрузка логотипа -->
    <div class="settings-card">
        <div class="settings-card-header">
            <h3 class="settings-card-title">
                <i class="fas fa-image"></i>
                Загрузка логотипа
            </h3>
            <p class="settings-card-subtitle">Настройте корпоративный логотип системы</p>
        </div>
        <div class="settings-card-body">
            <form action="{{ url_for('admin.upload_logo') }}" method="post" enctype="multipart/form-data" class="mb-3">
                <div class="form-group">
                    <label class="form-label">Выберите файл логотипа</label>
                    <div class="custom-file-input">
                        <input type="file" class="form-control" id="logo" name="logo" accept=".bmp,.jpg,.jpeg,.png" required>
                        <label for="logo" class="custom-file-label">
                            <i class="fas fa-file-image"></i>
                            Выберите файл
                        </label>
                    </div>
                    <div class="form-text">Поддерживаемые форматы: BMP, JPG, JPEG, PNG (рекомендуется PNG для прозрачности)</div>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-upload"></i>
                    Загрузить
                </button>
            </form>
            
            <div class="current-media">
                <h6>Текущий логотип:</h6>
                <div class="preview-container">
                    {% if logo_url %}
                    <img src="/static/images/logo.png?t={{ now }}" alt="Текущий логотип" onerror="this.onerror=null; this.src='/static/images/logo_backup.png?t={{ now }}'; setTimeout(() => { if (this.naturalWidth === 0) { this.style.display = 'none'; this.parentNode.innerHTML += '<p class=\'text-muted\'>Логотип не загружен или повреждён</p>'; } }, 500);">
                    {% else %}
                    <p class="text-muted">Логотип не загружен</p>
                    {% endif %}
                </div>
                {% if logo_url %}
                <div class="mt-3">
                    <form action="{{ url_for('admin.delete_logo') }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-danger btn-xs">
                            <i class="fas fa-trash"></i>
                            Удалить
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Загрузка фонового изображения -->
    <div class="settings-card">
        <div class="settings-card-header">
            <h3 class="settings-card-title">
                <i class="fas fa-palette"></i>
                Загрузка фонового изображения
            </h3>
            <p class="settings-card-subtitle">Настройте фоновое изображение для системы</p>
        </div>
        <div class="settings-card-body">
            <form action="{{ url_for('admin.upload_background') }}" method="post" enctype="multipart/form-data" class="mb-3">
                <div class="form-group">
                    <label class="form-label">Выберите фоновое изображение</label>
                    <div class="custom-file-input">
                        <input type="file" class="form-control" id="background" name="background" accept=".jpg,.jpeg,.png" required>
                        <label for="background" class="custom-file-label">
                            <i class="fas fa-file-image"></i>
                            Выберите файл
                        </label>
                    </div>
                    <div class="form-text">Поддерживаемые форматы: JPG, JPEG, PNG</div>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-upload"></i>
                    Загрузить
                </button>
            </form>
            
            <div class="current-media">
                <h6>Текущий фон:</h6>
                <div class="background-preview">
                    {% if background_url %}
                    <img src="/static/images/real_estate_bg.jpg" alt="Текущий фон">
                    {% else %}
                    <p class="text-muted">Фоновое изображение не загружено</p>
                    {% endif %}
                </div>
                {% if background_url %}
                <div class="mt-3">
                    <form action="{{ url_for('admin.delete_background') }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-danger btn-xs">
                            <i class="fas fa-trash"></i>
                            Удалить
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обновление текста кнопки выбора файла
    function updateFileLabel(input) {
        const label = input.nextElementSibling;
        if (input.files.length > 0) {
            label.innerHTML = `<i class="fas fa-file-image"></i> ${input.files[0].name}`;
        } else {
            label.innerHTML = `<i class="fas fa-file-image"></i> Выберите файл`;
        }
    }
    
    // Предпросмотр логотипа
    const logoInput = document.getElementById('logo');
    if (logoInput) {
        logoInput.addEventListener('change', function(e) {
            updateFileLabel(this);
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.querySelector('.preview-container img');
                    if (preview) {
                        preview.src = e.target.result;
                    } else {
                        const logoPreview = document.querySelector('.preview-container');
                        logoPreview.innerHTML = `<img src="${e.target.result}" alt="Предпросмотр логотипа">`;
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    }

    // Предпросмотр фона
    const backgroundInput = document.getElementById('background');
    if (backgroundInput) {
        backgroundInput.addEventListener('change', function(e) {
            updateFileLabel(this);
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.querySelector('.background-preview img');
                    if (preview) {
                        preview.src = e.target.result;
                    } else {
                        const bgPreview = document.querySelector('.background-preview');
                        bgPreview.innerHTML = `<img src="${e.target.result}" alt="Предпросмотр фона">`;
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>
{% endblock %} 