{% extends "base.html" %}

{% block title %}Управление персоналом{% endblock %}
{% block page_title %}Управление персоналом{% endblock %}

{% block extra_css %}
<style>
  /* Базовые стили */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7f9;
    color: #333;
  }
  
  /* Иконки должны быть поверх всего на странице */
  .move-up, .move-down {
    cursor: pointer !important;
    color: #6c757d !important;
    transition: all 0.3s ease !important;
    z-index: 1000 !important;
    font-size: 1rem !important;
    display: inline-block !important;
    margin: 0 5px !important;
    padding: 5px !important;
  }
  
  .move-up:hover, .move-down:hover {
    color: #007bff !important;
    transform: scale(1.2) !important;
  }
  
  /* Боковая панель */
  .sidebar {
    position: fixed;
    width: 240px;
    height: 100%;
    top: 0;
    left: 0;
    background-color: white;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
    padding: 20px;
    z-index: 1000;
  }
  
  /* Стили для кнопок в модальных окнах */
  .modal .btn {
    padding: 0.25rem 0.5rem !important;
    font-size: 0.875rem !important;
    height: auto !important;
    min-height: auto !important;
  }
  
  /* Стили для кнопок фильтров и добавления сотрудника */
  .btn-group-sm .btn-sm {
    padding: 0.25rem 0.5rem !important;
    font-size: 0.875rem !important;
    height: auto !important;
    min-height: auto !important;
  }
  
  /* Стили для верхнего меню */
  .nav-menu {
    background-color: white;
    padding: 0 1.2rem;
    border-radius: 12px;
    display: flex;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    margin-bottom: 2rem;
    border-bottom: 2px solid #dee2e6;
    align-items: center;
  }

  .nav-menu a {
    color: #6c757d;
    font-weight: 500;
    padding: 1rem 1.2rem;
    margin-right: 1.2rem;
    display: flex;
    align-items: center;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .nav-menu a:hover {
    color: #3498db;
    background-color: rgba(52, 152, 219, 0.05);
  }

  .nav-menu a.active {
    color: #3498db;
    border-bottom: 3px solid #3498db;
    font-weight: 600;
  }

  .nav-menu a i {
    margin-right: 0.7rem;
    font-size: 1.1rem;
  }
  
  /* Основной контент */
  .main-content {
    width: calc(100% - 240px) !important;
    margin-left: 240px !important;
    padding: 20px !important;
  }
  
  /* Стили для карточек статистики */
  .stat-card {
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    padding: 20px;
    margin-bottom: 20px;
    background: white;
    transition: transform 0.3s;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
  }
  
  .stat-card .stat-title {
    font-size: 1rem;
    color: #7f8c8d;
    margin-bottom: 10px;
  }
  
  .stat-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #2c3e50;
  }
  
  .stat-card .stat-icon {
    float: right;
    font-size: 2.5rem;
    opacity: 0.2;
    color: #3498db;
  }
  
  /* Стили для отделов */
  .department-section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
    overflow: hidden;
  }
  
  .department-header {
    background-color: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    cursor: pointer;
  }
  
  .department-header .badge {
    background-color: #3498db;
    color: white;
    padding: 5px 10px;
    border-radius: 50px;
    font-size: 0.8rem;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 24px !important;
    height: 24px !important;
    line-height: 1 !important;
    vertical-align: middle !important;
  }
  
  .department-header .department-controls {
    display: flex !important;
    gap: 10px !important;
  }
  
  .department-header .department-controls i {
    cursor: pointer !important;
    color: #6c757d !important;
    transition: color 0.3s !important;
    font-size: 1rem !important;
    margin: 0 3px !important;
    z-index: 10 !important;
  }
  
  .department-header .department-controls i:hover {
    color: #3498db !important;
    transform: scale(1.2) !important;
  }
  
  /* Стили для маркера перетаскивания */
  .drag-handle {
    cursor: move !important;
    color: #6c757d !important;
    transition: color 0.3s ease !important;
    font-size: 1.2rem !important;
    margin: 0 5px !important;
    display: inline-block !important;
    z-index: 20 !important;
    /* Убираем всю обводку и фон */
    background: transparent !important;
    padding: 2px !important;
    border-radius: 0 !important;
    border: none !important;
  }
  
  .drag-handle:hover {
    color: #3498db !important;
    transform: scale(1.2) !important;
  }
  
  .drag-handle:active {
    cursor: grabbing !important;
  }
  
  /* Стили для перетаскивания */
  .department-section.dragging {
    opacity: 0.7 !important;
    transform: scale(0.98) !important;
  }
  
  .department-section.drop-target {
    border: 2px dashed #3498db !important;
  }
  
  /* Таблица сотрудников */
  .table th, .table td {
    text-align: center;
    vertical-align: middle;
  }
  
  /* Узкие колонки для ID и Статус */
  .table th:nth-child(1), .table td:nth-child(1) {
    width: 5%;
  }
  
  .table th:nth-child(2), .table td:nth-child(2) {
    width: 5%;
  }
  
  /* Остальные колонки с равной шириной */
  .table th:nth-child(3), .table td:nth-child(3),
  .table th:nth-child(4), .table td:nth-child(4),
  .table th:nth-child(5), .table td:nth-child(5),
  .table th:nth-child(6), .table td:nth-child(6),
  .table th:nth-child(7), .table td:nth-child(7) {
    width: 18%;
  }
  
  .employee-row {
    transition: background-color 0.2s;
  }
  
  .employee-row:hover {
    background-color: #f8f9fa;
  }
  
  .manager-row {
    background-color: rgba(52, 152, 219, 0.1) !important;
  }
  
  .deputy-row {
    background-color: rgba(52, 152, 219, 0.05) !important;
  }
  
  .employee-status {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
  }
  
  .status-online {
    background-color: #2ecc71;
  }
  
  .status-offline {
    background-color: #e74c3c;
  }
  
  .edit-icon, .fire-icon, .delete-icon {
    cursor: pointer;
    margin-right: 10px;
    font-size: 1.1rem;
    transition: color 0.2s;
  }
  
  .edit-icon {
    color: #3498db;
  }
  
  .fire-icon {
    color: #e74c3c;
  }
  
  .delete-icon {
    color: #95a5a6;
  }
  
  .edit-icon:hover {
    color: #2980b9;
  }
  
  .fire-icon:hover {
    color: #c0392b;
  }
  
  .delete-icon:hover {
    color: #7f8c8d;
  }
  
  /* Поиск и фильтры */
  .search-box {
    position: relative;
    margin-bottom: 20px;
  }
  
  .search-box i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #95a5a6;
  }
  
  .search-box input {
    padding-left: 40px;
    border-radius: 50px;
    border: 1px solid #e9ecef;
  }
  
  .filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-btn {
    border: none;
    background-color: white;
    border-radius: 50px;
    padding: 6px 12px;
    font-size: 0.85rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    transition: all 0.3s;
  }
  
  .filter-btn:hover, .filter-btn.active {
    background-color: #3498db;
    color: white;
  }

  /* Select2 кастомные стили */
  .select2-container--bootstrap-5 .select2-selection {
    border-radius: 8px;
    border: 1px solid #ced4da;
    font-size: 0.85rem;
    height: calc(1.5em + 0.5rem + 2px) !important;
  }
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
    background-color: #3498db;
    border-color: #3498db;
    color: #fff;
    font-size: 0.85rem;
    padding: 0.2rem 0.4rem;
    margin: 3px;
    height: calc(1.5em + 0.15rem) !important;
  }
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
    padding: 0 3px;
  }
  .select2-container--bootstrap-5 .select2-dropdown {
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    font-size: 0.85rem;
  }

  /* Стили для поля логина */
  #systemLoginContainer {
    background-color: #f1f8f1; /* Светло-зеленый фон */
    border: 2px solid #66bb6a; /* Светло-зеленая обводка */
    border-radius: 5px;
    padding: 5px;
    margin-bottom: 15px;
  }
  
  #systemLoginContainer label {
    font-weight: bold;
    color: #2e7d32; /* Темно-зеленый цвет для метки */
  }
  
  #systemLoginContainer input {
    background-color: #f1f8f1;
    border: 1px solid #66bb6a;
    font-weight: bold;
  }
  
  #editSystemLogin {
    display: block !important;
    border: 2px solid #66bb6a;
    font-weight: bold;
  }

  /* Стили для модальных окон */
  .modal {
    z-index: 1055 !important;
  }
  
  .modal-content {
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    background-color: #fff !important;
    opacity: 1 !important;
    z-index: 1056 !important;
  }

  .modal-backdrop {
    opacity: 0.5 !important;
    background-color: rgba(0, 0, 0, 0.6) !important;
    z-index: 1054 !important;
  }

  .modal-dialog {
    z-index: 1055 !important;
  }

  .modal-body {
    background-color: #fff !important;
    opacity: 1 !important;
  }

  .modal-header, .modal-footer {
    background-color: #f8f9fa;
    border-color: #dee2e6;
  }
  
  /* Стили для фильтров как на странице уволенных */
  .filter-section {
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .filter-section .filter-title {
    font-weight: 600;
    margin-bottom: 15px;
    color: #2c3e50;
  }
  
  .filter-section .filter-group {
    margin-bottom: 15px;
  }
  
  .filter-section .filter-label {
    font-weight: 500;
    margin-bottom: 5px;
    color: #6c757d;
  }
  
  .filter-section .filter-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 15px;
  }

  /* Стили для контейнера фото */
  .photo-container {
    position: relative;
    display: inline-block;
    margin-top: 10px;
    width: 100%;
    height: 200px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .delete-photo-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: #f44336;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.3s;
    z-index: 10;
  }
  
  .delete-photo-btn:hover {
    background-color: #d32f2f;
    transform: scale(1.1);
  }
  
  .delete-photo-btn i {
    font-size: 12px;
  }
  
  /* Стили для модального окна подтверждения */
  .confirm-delete-modal .modal-content {
    border-radius: 8px;
  }
  
  .confirm-delete-modal .modal-header {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .confirm-delete-modal .modal-body {
    text-align: center;
    padding: 20px;
  }
  
  .confirm-delete-modal .modal-footer {
    border-top: none;
    justify-content: center;
    padding-top: 0;
  }
  
  .confirm-delete-modal .btn {
    min-width: 100px;
    margin: 0 10px;
  }
  
  /* Стили для уведомлений */
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
  }

  .toast {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 16px;
    margin-bottom: 10px;
    min-width: 300px;
    max-width: 400px;
    display: flex;
    align-items: center;
    animation: slideIn 0.3s ease-out;
  }

  .toast.success {
    border-left: 4px solid #28a745;
  }

  .toast.error {
    border-left: 4px solid #dc3545;
  }

  .toast .toast-icon {
    margin-right: 12px;
    font-size: 20px;
  }

  .toast.success .toast-icon {
    color: #28a745;
  }

  .toast.error .toast-icon {
    color: #dc3545;
  }

  .toast .toast-content {
    flex: 1;
  }

  .toast .toast-title {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .toast .toast-message {
    color: #6c757d;
    font-size: 0.9rem;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .toast.hide {
    animation: slideOut 0.3s ease-in forwards;
  }
</style>
{% endblock %}

{% block extra_js %}
<!-- Подключаем jQuery первым -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Проверяем загрузку jQuery
if (typeof jQuery === 'undefined') {
    console.error('jQuery не загружен!');
} else {
    console.log('jQuery успешно загружен, версия:', jQuery.fn.jquery);
}
</script>

<!-- Подключаем Select2 и его зависимости -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<script>
// Проверяем загрузку Select2
function checkSelect2Loaded() {
    if (typeof $.fn.select2 === 'function') {
        console.log('Select2 успешно загружен');
        return true;
    } else {
        console.error('Select2 не загружен');
        return false;
    }
}

// Инициализация Select2
function initializeSelect2() {
    if (checkSelect2Loaded()) {
        $('.filter-select').select2({
            theme: 'bootstrap-5',
            placeholder: 'Выберите значения',
            allowClear: true
        });
    }
}

// Вызываем инициализацию при загрузке документа
$(document).ready(function() {
    console.log('Document ready event fired');
    
    // Инициализируем Select2
    initializeSelect2();
    
    // ... остальной код ...
});
</script>
{% endblock %}

{% block content %}
<div class="toast-container" id="toastContainer"></div>
<div class="container-fluid">
<!-- Навигационное меню -->
<div class="nav-menu">
    <a href="{{ url_for('admin_routes_unique.personnel') }}" class="active">
        <i class="fas fa-users"></i>
        Активные
    </a>
    <a href="{{ url_for('admin_routes_unique.fired_employees') }}">
        <i class="fas fa-user-times"></i>
        Уволенные
    </a>
    <a href="{{ url_for('admin_routes_unique.personnel_dashboard') }}">
        <i class="fas fa-chart-line"></i>
        Дашборд
    </a>
</div>

<!-- Основной контент -->
<div class="main-content">
    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <i class="fas fa-users stat-icon"></i>
                <div class="stat-title">Всего сотрудников</div>
                <div class="stat-value">{{ total_employees }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="fas fa-user-check stat-icon"></i>
                <div class="stat-title">Активные сотрудники</div>
                <div class="stat-value">{{ active_employees }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="fas fa-user-times stat-icon"></i>
                <div class="stat-title">Уволенные сотрудники</div>
                <div class="stat-value">{{ fired_employees }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="fas fa-building stat-icon"></i>
                <div class="stat-title">Отделов</div>
                <div class="stat-value">{{ departments|length }}</div>
            </div>
        </div>
    </div>

    <!-- Поиск и фильтры -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="searchInput" placeholder="Поиск сотрудников...">
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group btn-group-sm">
                <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                    <i class="fas fa-filter"></i> Фильтры
                </button>
                <button class="btn btn-success btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#addEmployeeModal" id="addEmployeeBtn">
                    <i class="fas fa-user-plus"></i> Добавить сотрудника
                </button>
                <button class="btn btn-info btn-sm" type="button" id="toggleAllDepartments">
                    <i class="fas fa-chevron-up"></i> <span>Свернуть все</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Выпадающие фильтры -->
    <div class="collapse mb-4" id="filtersCollapse">
        <div class="card card-body">
            <h5 class="mb-3">Фильтры сотрудников</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Отделы</label>
                        <select class="form-select filter-select" id="departmentSelect" multiple="multiple" style="width: 100%;">
                            <option value="all" selected>Все отделы</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Должности</label>
                        <select class="form-select filter-select" id="positionSelect" multiple="multiple" style="width: 100%;">
                            <option value="all" selected>Все должности</option>
                            {% for position in positions %}
                            <option value="{{ position.name }}">{{ position.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Роли</label>
                        <select class="form-select filter-select" id="roleSelect" multiple="multiple" style="width: 100%;">
                            <option value="all" selected>Все роли</option>
                            <option value="leader">Руководитель</option>
                            <option value="deputy">Заместитель</option>
                            <option value="user">Сотрудник</option>
                            <option value="admin">Администратор</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button class="btn btn-primary btn-sm me-2" id="applyFilters">Применить</button>
                <button class="btn btn-outline-secondary btn-sm" id="resetFilters">Сбросить</button>
            </div>
        </div>
    </div>

    <!-- Список сотрудников по отделам -->
    <div id="departments-container">
        {% for department in departments|sort(attribute='display_order') %}
        <div class="department-section" data-department-id="{{ department.id }}">
            <div class="department-header">
                <span class="department-name">{{ department.name }}</span>
                <div class="department-controls">
                    <span class="badge">{{ employees_by_department[department.name]|default([])|length }}</span>
                    <i class="fas fa-chevron-up toggle-department" title="Свернуть/развернуть"></i>
                    <span class="drag-handle" draggable="true" title="Перетащить для изменения порядка">=</span>
                </div>
            </div>
            <div class="department-content">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Статус</th>
                                <th>ФИО</th>
                                <th>Должность</th>
                                <th>Корп. телефон</th>
                                <th>Корп. почта</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if department.name in employees_by_department %}
                                {% set employees = employees_by_department[department.name] %}
                                {% set managers = employees|selectattr('role', 'equalto', 'leader')|list %}
                                {% set deputies = employees|selectattr('role', 'equalto', 'deputy')|list %}
                                {% set regular_employees = employees|rejectattr('role', 'equalto', 'leader')|rejectattr('role', 'equalto', 'deputy')|list %}
                                
                                {% for employee in managers + deputies + regular_employees %}
                                <tr class="employee-row {% if employee.role == 'leader' %}manager-row{% elif employee.role == 'deputy' %}deputy-row{% endif %}">
                                    <td>{{ employee.id }}</td>
                                    <td>
                                        <span class="employee-status {% if employee.status == 'online' %}status-online{% else %}status-offline{% endif %}"></span>
                                    </td>
                                    <td>{{ employee.full_name }}</td>
                                    <td>{{ employee.position }}</td>
                                    <td>{{ employee.corporate_number }}</td>
                                    <td>{{ employee.corporate_email }}</td>
                                    <td>
                                        <i class="fas fa-edit edit-icon" title="Редактировать" data-bs-toggle="modal" data-bs-target="#editEmployeeModal" data-id="{{ employee.id }}"></i>
                                        <i class="fas fa-user-slash fire-icon" title="Уволить" data-id="{{ employee.id }}"></i>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">Нет сотрудников в этом отделе</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Модальное окно для редактирования сотрудника -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmployeeModalLabel">Редактировать сотрудника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: #fff; z-index: 1060;">
                <form id="editEmployeeForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-12">
                            <h5 class="mt-3 mb-3">Редактирование сотрудника</h5>
                    <input type="hidden" id="editEmployeeId" name="id">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <!-- Основная информация -->
                            <!-- Блок для фото с возможностью загрузки -->
                            <div class="mb-3 text-center">
                                <div id="photoContainer" class="photo-container mb-2">
                                    <img id="employeePhotoPreview" src="" alt="Фото сотрудника" style="max-width: 100%; max-height: 100%; display: none;">
                                    <span id="photoPlaceholder">Нет фото</span>
                                    <button type="button" class="delete-photo-btn" onclick="confirmDeletePhoto()" id="deletePhotoBtn" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <input type="file" class="form-control form-control-sm" id="employeePhoto" name="employee_photo" onchange="handlePhotoUpload(event)">
                                <input type="hidden" id="deletePhotoFlag" name="delete_photo" value="0">
                            </div>
                            
                            <div id="systemLoginContainer" class="mb-2">
                                <label for="editLogin" class="form-label">Логин в системе</label>
                                <input type="text" class="form-control" id="editLogin" name="login">
                            </div>
                            
                            <div class="mb-2">
                                <label for="editFullName" class="form-label">ФИО</label>
                                <input type="text" class="form-control" id="editFullName" name="full_name">
                            </div>
                            <div class="mb-2">
                                <label for="editDepartment" class="form-label">Отдел</label>
                                <select class="form-select" id="editDepartment" name="department_id" required>
                                    {% for department in departments %}
                                    <option value="{{ department.id }}">{{ department.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-2">
                                <label for="editPosition" class="form-label">Должность</label>
                                <select class="form-select" id="editPosition" name="position" required>
                                    {% for position in positions %}
                                    <option value="{{ position.name }}">{{ position.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-2">
                                <label for="editRole" class="form-label">Роль</label>
                                <select class="form-select" id="editRole" name="role" required>
                                    <option value="user">Сотрудник</option>
                                    <option value="deputy">Заместитель</option>
                                    <option value="leader">Руководитель</option>
                                    <option value="admin">Администратор</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Контактная информация -->
                            <div class="mb-2">
                                <label for="editCorporateNumber" class="form-label">Корпоративный номер</label>
                                <div class="input-group">
                                    <span class="input-group-text">+7</span>
                                    <input type="text" class="form-control" id="editCorporateNumber" name="corp_phone" placeholder="Введите номер без +7">
                                </div>
                            </div>
                            <div class="mb-2">
                                <label for="editPersonalPhone" class="form-label">Личный телефон</label>
                                <div class="input-group">
                                    <span class="input-group-text">+7</span>
                                    <input type="text" class="form-control" id="editPersonalPhone" name="phone" placeholder="Введите номер без +7">
                                </div>
                            </div>
                            <div class="mb-2">
                                <label for="editCorporateEmail" class="form-label">Корпоративная почта</label>
                                <input type="email" class="form-control" id="editCorporateEmail" name="corporate_email">
                            </div>
                            <div class="mb-2">
                                <label for="editPersonalEmail" class="form-label">Личная почта</label>
                                <input type="email" class="form-control" id="editPersonalEmail" name="personal_email">
                            </div>
                            <div class="mb-2">
                                <label for="editLoginPC" class="form-label">Логин ПК</label>
                                <input type="text" class="form-control" id="editLoginPC" name="pc_login">
                            </div>
                            <div class="mb-2">
                                <label for="editPasswordPC" class="form-label">Пароль ПК</label>
                                <input type="text" class="form-control" id="editPasswordPC" name="pc_password">
                            </div>
                            <div class="mb-2">
                                <label for="editCRMId" class="form-label">CRM ID</label>
                                <input type="text" class="form-control" id="editCRMId" name="crm_id">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Даты и дополнительная информация -->
                            <div class="mb-2">
                                <label for="editHireDate" class="form-label">Дата приема</label>
                                <input type="date" class="form-control" id="editHireDate" name="hire_date">
                            </div>
                            <div class="mb-2 d-none">
                                <label for="editTerminationDate" class="form-label">Дата увольнения</label>
                                <input type="date" class="form-control" id="editTerminationDate" name="termination_date">
                            </div>
                            <div class="mb-2">
                                <label for="editBirthDate" class="form-label">Дата рождения</label>
                                <input type="date" class="form-control" id="editBirthDate" name="birth_date">
                            </div>
                            <div class="mb-2">
                                <label for="editExperience" class="form-label">Стаж работы</label>
                                <input type="text" class="form-control" id="editExperience" name="experience" readonly>
                            </div>
                            
                            <!-- Чекбоксы -->
                            <div class="mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editDocuments" name="documents">
                                    <label class="form-check-label" for="editDocuments">Документы</label>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editRR" name="rr">
                                    <label class="form-check-label" for="editRR">RR</label>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editSite" name="site">
                                    <label class="form-check-label" for="editSite">Сайт</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Примечания -->
                    <div class="mb-2">
                        <label for="editNotes" class="form-label">Примечания</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                    </div>

                    <!-- История номеров -->
                    <div class="card mt-3">
                        <div class="card-header">
                            История номеров
                        </div>
                        <div class="card-body">
                            <div id="numberHistory" style="max-height: 100px; overflow-y: auto;">
                                <!-- Здесь будет отображаться история номеров -->
                            </div>
                        </div>
                    </div>

                    <!-- История изменений -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center" id="historyHeader" style="cursor: pointer;" onclick="toggleHistoryCollapse()">
                            <h5 class="mb-0 fw-bold" style="font-size: 0.9rem;">История изменений ↓</h5>
                        </div>
                        <div id="historyCollapse" class="collapse">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="historyTable">
                                        <thead>
                                            <tr>
                                                <th>Дата изменения</th>
                                                <th>Поле</th>
                                                <th>Старое значение</th>
                                                <th>Новое значение</th>
                                                <th>Кем изменено</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" tabindex="-1">Отмена</button>
                <button type="button" class="btn btn-warning" id="changePasswordBtn" tabindex="-1">Сменить пароль</button>
                <button type="button" class="btn btn-primary" id="saveEmployeeChanges" tabindex="-1">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления сотрудника -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEmployeeModalLabel">Добавить сотрудника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEmployeeForm">
                    <div class="row">
                        <div class="col-md-4">
                            <!-- Основная информация -->
                            <div class="mb-2">
                                <label for="addFullName" class="form-label">ФИО</label>
                                <input type="text" class="form-control" id="addFullName" name="full_name" required>
                            </div>
                            <div class="mb-2">
                                <label for="addDepartment" class="form-label">Отдел</label>
                                <select class="form-select" id="addDepartment" name="department_id" required>
                                    {% for department in departments %}
                                    <option value="{{ department.id }}">{{ department.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-2">
                                <label for="addPosition" class="form-label">Должность</label>
                                <select class="form-select" id="addPosition" name="position" required>
                                    {% for position in positions %}
                                    <option value="{{ position.name }}">{{ position.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-2">
                                <label for="addRole" class="form-label">Роль</label>
                                <select class="form-select" id="addRole" name="role" required>
                                    <option value="user">Сотрудник</option>
                                    <option value="deputy">Заместитель</option>
                                    <option value="leader">Руководитель</option>
                                    <option value="admin">Администратор</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Контактная информация -->
                            <div class="mb-2">
                                <label for="addCorporateNumber" class="form-label">Корпоративный номер</label>
                                <div class="input-group">
                                    <span class="input-group-text">+7</span>
                                    <input type="text" class="form-control" id="addCorporateNumber" name="corporate_number" placeholder="Введите номер без +7">
                                </div>
                            </div>
                            <div class="mb-2">
                                <label for="addPersonalPhone" class="form-label">Личный телефон</label>
                                <div class="input-group">
                                    <span class="input-group-text">+7</span>
                                    <input type="text" class="form-control" id="addPersonalPhone" name="phone" placeholder="Введите номер без +7">
                                </div>
                            </div>
                            <div class="mb-2">
                                <label for="addCorporateEmail" class="form-label">Корпоративная почта</label>
                                <input type="email" class="form-control" id="addCorporateEmail" name="corporate_email">
                            </div>
                            <div class="mb-2">
                                <label for="addPersonalEmail" class="form-label">Личная почта</label>
                                <input type="email" class="form-control" id="addPersonalEmail" name="personal_email">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Системная информация -->
                            <div class="mb-2">
                                <label for="addLogin" class="form-label">Логин в системе</label>
                                <input type="text" class="form-control" id="addLogin" name="login" required>
                            </div>
                            <div class="mb-2">
                                <label for="addPassword" class="form-label">Пароль</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="addPassword" name="password" required>
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label for="addHireDate" class="form-label">Дата приема</label>
                                <input type="date" class="form-control" id="addHireDate" name="hire_date" required>
                            </div>
                            <div class="mb-2">
                                <label for="addBirthDate" class="form-label">Дата рождения</label>
                                <input type="date" class="form-control" id="addBirthDate" name="birth_date">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" tabindex="-1">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveNewEmployee" tabindex="-1">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для увольнения сотрудника -->
<div class="modal fade" id="fireEmployeeModal" tabindex="-1" aria-labelledby="fireEmployeeModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fireEmployeeModalLabel">Уволить сотрудника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="fireEmployeeId">
                <p>Вы действительно хотите уволить сотрудника <strong id="fireEmployeeName"></strong>?</p>
                    <div class="mb-3">
                        <label for="fireDate" class="form-label">Дата увольнения</label>
                    <input type="date" class="form-control" id="fireDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="fireReason" class="form-label">Причина увольнения</label>
                    <textarea class="form-control" id="fireReason" rows="3"></textarea>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" tabindex="-1">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmFire" tabindex="-1">Уволить</button>
            </div>
        </div>
    </div>
</div>

<!-- Добавляем модальное окно подтверждения удаления фото после основных модальных окон -->
<div class="modal fade confirm-delete-modal" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить фотографию сотрудника?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" onclick="deletePhoto()">Удалить</button>
            </div>
        </div>
    </div>
</div>

<!-- Убираем дублирование скриптов, так как jQuery и Select2 уже подключены в head -->
<script>
// Расчет стажа работы
function calculateExperience(hireDate) {
    if (!hireDate) return '';
    
    const hire = new Date(hireDate);
    const now = new Date();
    
    let years = now.getFullYear() - hire.getFullYear();
    let months = now.getMonth() - hire.getMonth();
    
    if (months < 0) {
        years--;
        months += 12;
    }
    
    if (years > 0 && months > 0) {
    return `${years} г. ${months} мес.`;
    } else if (years > 0) {
        return `${years} г.`;
    } else if (months > 0) {
        return `${months} мес.`;
        } else {
        const diffTime = Math.abs(now - hire);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return `${diffDays} дн.`;
    }
}

// Форматирование даты для input
function formatDateForInput(dateString) {
    if (!dateString) return '';
    return new Date(dateString).toISOString().split('T')[0];
}

// Функция загрузки данных сотрудника для редактирования
async function loadEmployeeDataForEdit(employeeId) {
    try {
        // Загружаем должности для выпадающего списка в модальном окне редактирования
        const positionsResponse = await fetch('/admin/settings/positions');
        const positions = await positionsResponse.json();
        
        const editPositionSelect = document.getElementById('editPosition');
        editPositionSelect.innerHTML = '<option value="">Выберите должность</option>';
        
        positions.forEach(position => {
            const option = document.createElement('option');
            option.value = position.name;
            option.textContent = position.name;
            editPositionSelect.appendChild(option);
        });
        
        // Загружаем роли для выпадающего списка в модальном окне редактирования
        const rolesResponse = await fetch('/admin/settings/roles/get_available_roles');
        const rolesResult = await rolesResponse.json();
        
        const editRoleSelect = document.getElementById('editRole');
        editRoleSelect.innerHTML = '<option value="">Выберите роль</option>';
        
        if (rolesResult.roles && Array.isArray(rolesResult.roles)) {
            rolesResult.roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id || role.name;
                option.textContent = role.name;
                editRoleSelect.appendChild(option);
            });
        }
        
        // Загружаем данные сотрудника
        const employeeResponse = await fetch(`/admin/api/get_employee?id=${employeeId}`);
        const employeeData = await employeeResponse.json();
        console.log('Полные данные сотрудника:', employeeData);
        
        // Выведем полную структуру ответа в виде JSON для отладки
        console.log('Данные API в JSON-формате:', JSON.stringify(employeeData, null, 2));
        
        if (employeeData.success) {
            // Для обратной совместимости
            let employee = employeeData.data || employeeData.employee;
            
            // Обработка фото сотрудника, если есть
            const photoPreview = document.getElementById('employeePhotoPreview');
            const photoPlaceholder = document.getElementById('photoPlaceholder');
            const deletePhotoBtn = document.getElementById('deletePhotoBtn');
            const deletePhotoFlag = document.getElementById('deletePhotoFlag');
            
            // Сбрасываем флаг удаления при загрузке данных
            deletePhotoFlag.value = '0';
            
            if (employee.photo_url) {
                photoPreview.src = employee.photo_url;
                photoPreview.style.display = 'block';
                photoPlaceholder.style.display = 'none';
                deletePhotoBtn.style.display = 'block';
            } else {
                photoPreview.style.display = 'none';
                photoPlaceholder.style.display = 'block';
                deletePhotoBtn.style.display = 'none';
            }
            
            // Остальная загрузка данных
            if (!employee) {
                throw new Error('Не удалось получить данные сотрудника');
            }
            
            console.log('Данные сотрудника для заполнения формы:', employee);
            
            // ВАЖНО: Принудительно делаем поле логина видимым и заметным
            const systemLoginContainer = document.getElementById('systemLoginContainer');
            if (systemLoginContainer) {
                systemLoginContainer.style.display = 'block';
                systemLoginContainer.classList.remove('d-none');
                // Делаем стиль более заметным
                systemLoginContainer.style.backgroundColor = '#e6f7ff'; // Светло-голубой
                systemLoginContainer.style.border = '3px solid #1890ff'; // Синяя обводка
                systemLoginContainer.style.padding = '10px';
                systemLoginContainer.style.borderRadius = '8px';
                systemLoginContainer.style.marginBottom = '20px';
                systemLoginContainer.style.boxShadow = '0 0 10px rgba(24, 144, 255, 0.3)';
            }
            
            // Заполняем форму данными сотрудника
            document.getElementById('editEmployeeId').value = employee.id;
            
            // Явно заполняем поле логина и делаем его более заметным
            const loginField = document.getElementById('editLogin');
            if (loginField) {
                // Проверяем наличие логина в ответе API или запрашиваем отдельно
                if (employee.login) {
                    console.log('Устанавливаем логин из ответа API:', employee.login);
                    setLoginValue(loginField, employee.login);
                } else {
                    console.log('Логин не найден в ответе, запрашиваем отдельно');
                    // Запрашиваем логин напрямую
                    fetch(`/admin/api/get_employee_login?id=${employee.id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.login) {
                                console.log('Получен логин из API:', data.login);
                                setLoginValue(loginField, data.login);
                            } else {
                                console.error('Не удалось получить логин сотрудника через API');
                            }
                        })
                        .catch(error => {
                            console.error('Ошибка при запросе логина:', error);
                        });
                }
            } else {
                console.error('Элемент с ID editLogin не найден!');
            }
            
            document.getElementById('editFullName').value = employee.full_name || '';
            
            // Устанавливаем значения выпадающих списков
            if (employee.department_id) {
                document.getElementById('editDepartment').value = employee.department_id;
            }
            
            if (employee.position) {
                // Ищем опцию с таким значением
                const positionOption = Array.from(editPositionSelect.options).find(option => option.value === employee.position);
                if (positionOption) {
                    positionOption.selected = true;
                } else {
                    // Если опции нет, добавляем её
                    const option = document.createElement('option');
                    option.value = employee.position;
                    option.textContent = employee.position;
                    editPositionSelect.appendChild(option);
                    option.selected = true;
                }
            }
            
            if (employee.role) {
                // Ищем опцию с таким значением
                const roleOption = Array.from(editRoleSelect.options).find(option => option.value === employee.role);
                if (roleOption) {
                    roleOption.selected = true;
                }
            }
            
            // Заполняем остальные поля
            document.getElementById('editCorporateNumber').value = employee.corporate_number || '';
            document.getElementById('editPersonalPhone').value = employee.phone || '';
            document.getElementById('editCorporateEmail').value = employee.corporate_email || '';
            document.getElementById('editPersonalEmail').value = employee.personal_email || '';
            document.getElementById('editLoginPC').value = employee.login_pc || employee.login || '';
            document.getElementById('editPasswordPC').value = employee.pc_password || '';
            document.getElementById('editCRMId').value = employee.crm_id || '';
            
            if (employee.hire_date) {
                document.getElementById('editHireDate').value = formatDateForInput(employee.hire_date);
            }
            
            if (employee.birth_date) {
                document.getElementById('editBirthDate').value = formatDateForInput(employee.birth_date);
            }
            
            document.getElementById('editExperience').value = calculateExperience(employee.hire_date) || '';
            
            // Чекбоксы
            document.getElementById('editDocuments').checked = employee.documents || false;
            document.getElementById('editRR').checked = employee.rr || false;
            document.getElementById('editSite').checked = employee.site || false;
            
            // CRM ID
            document.getElementById('editCRMId').value = employee.crm_id || '';
            
            // Корпоративная почта
            document.getElementById('editCorporateEmail').value = employee.corporate_email || '';
        } else {
            showNotification('Ошибка при загрузке данных сотрудника', 'error');
        }
    } catch (error) {
        console.error('Ошибка при загрузке данных для редактирования:', error);
        showNotification('Ошибка при загрузке данных для редактирования: ' + error.message, 'error');
    }
}

// Функция увольнения сотрудника с данными из формы
async function fireEmployeeWithData(employeeId, fireDate, fireReason) {
    try {
        const response = await fetch('/admin/api/fire_employee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                id: employeeId,
                fire_date: fireDate,
                fire_reason: fireReason
            })
        });

        if (response.ok) {
            const data = await response.json();
                if (data.success) {
            // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('fireEmployeeModal'));
                modal.hide();
                
                showNotification(data.message || 'Сотрудник успешно уволен', 'success');
                
                // Перезагружаем страницу через небольшую задержку
                setTimeout(() => {
                    location.reload();
                }, 1000);
        } else {
                throw new Error(data.message || 'Ошибка при увольнении сотрудника');
            }
        } else {
            throw new Error('Ошибка при увольнении сотрудника: ' + response.status);
        }
    } catch (error) {
        console.error('Ошибка при увольнении сотрудника:', error);
        showNotification('Ошибка при увольнении сотрудника: ' + error.message, 'danger');
    }
}

function updateUIAfterChanges() {
    // Обновляем сортировку сотрудников
    sortEmployeesInDepartments();
    
    // Перезагружаем страницу для отображения обновлений
    location.reload();
}

// Функция для обновления данных сотрудника
function updateEmployee() {
    console.log('Началось обновление данных сотрудника');
    
    const form = document.getElementById('editEmployeeForm');
    const formData = new FormData(form);
    
    // Проверяем, установлен ли флаг удаления фото
    const deletePhotoFlag = document.getElementById('deletePhotoFlag').value;
    if (deletePhotoFlag === '1') {
        formData.set('delete_photo', '1');
    }
    
    // Явно добавляем значение логина в данные
    const systemLoginValue = document.getElementById('editLogin').value;
    console.log('Отправляем логин в системе:', systemLoginValue);
    formData.set('login', systemLoginValue);
    
    // Используем улучшенную функцию для обновления данных
    updateEmployeeData(formData);
}

// Открытие модального окна редактирования сотрудника
document.querySelectorAll('.edit-icon').forEach(icon => {
    icon.addEventListener('click', function() {
        const employeeId = this.getAttribute('data-id');
        
        // Убедимся, что поле логина видимо и заметно
        const systemLoginContainer = document.getElementById('systemLoginContainer');
        if (systemLoginContainer) {
            systemLoginContainer.style.display = 'block';
            systemLoginContainer.style.visibility = 'visible';
            systemLoginContainer.style.opacity = '1';
            // Добавляем заметное оформление
            systemLoginContainer.style.backgroundColor = '#e6f7ff';
            systemLoginContainer.style.border = '3px solid #1890ff';
            systemLoginContainer.style.padding = '10px';
            systemLoginContainer.style.borderRadius = '8px';
            systemLoginContainer.style.boxShadow = '0 0 10px rgba(24, 144, 255, 0.3)';
            
            const systemLoginField = document.getElementById('editLogin');
            if (systemLoginField) {
                systemLoginField.style.display = 'block';
                systemLoginField.style.visibility = 'visible';
            }
        }
        
        // Прямой запрос логина для надежности
        fetch(`/admin/api/get_employee_login?id=${employeeId}`)
        .then(response => response.json())
        .then(data => {
                if (data.success && data.login) {
                    console.log('Получен логин напрямую:', data.login);
                    const loginField = document.getElementById('editLogin');
                    if (loginField) {
                        setLoginValue(loginField, data.login);
                    }
        }
    })
    .catch(error => {
                console.error('Ошибка при запросе логина напрямую:', error);
            });
        
        // Загружаем данные сотрудника
        loadEmployeeDataForEdit(employeeId);
        
        // Загружаем историю изменений
        try {
            console.log('Пытаемся загрузить историю для ID:', employeeId);
            loadEmployeeHistory(employeeId);
        } catch (e) {
            console.error('Ошибка при загрузке истории:', e);
        }
        
        // Дополнительная проверка через небольшую задержку
        setTimeout(() => {
            const loginField = document.getElementById('editLogin');
            if (loginField) {
                console.log('Значение логина через 500мс:', loginField.value);
                if (!loginField.value || loginField.value === '') {
                    // Логин все еще не установлен, делаем еще один запрос
                    console.warn('Логин не установлен, делаем финальный запрос');
                    fetch(`/admin/api/get_employee_login?id=${employeeId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.login) {
                                console.log('Получен логин финальный:', data.login);
                                setLoginValue(loginField, data.login);
                            }
                        });
                }
            }
        }, 500);
    });
});

// Добавляем обработчик для превью загружаемого фото
document.getElementById('employeePhoto').addEventListener('change', function(e) {
    const file = this.files[0];
    if (file) {
        // Проверяем размер файла
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Размер файла превышает 5MB', 'danger');
            this.value = '';
            return;
        }
        
        // Проверяем тип файла
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            showNotification('Недопустимый формат файла. Разрешены: PNG, JPG, JPEG, GIF', 'danger');
            this.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
            document.getElementById('employeePhotoPreview').src = event.target.result;
            document.getElementById('employeePhotoPreview').style.display = 'block';
            document.getElementById('photoPlaceholder').style.display = 'none';
        };
        reader.readAsDataURL(file);
    } else {
        // Если файл не выбран, скрываем превью
        document.getElementById('employeePhotoPreview').style.display = 'none';
        document.getElementById('photoPlaceholder').style.display = 'block';
    }
});

// Функция для установки значения и стилей логина
function setLoginValue(field, value) {
    field.value = value;
    field.defaultValue = value;
    
    // Делаем поле логина более заметным
    field.style.backgroundColor = '#e6f7ff';
    field.style.fontWeight = 'bold';
    field.style.color = '#1890ff';
    field.style.border = '2px solid #1890ff';
    field.style.fontSize = '16px';
    field.style.boxShadow = '0 0 5px rgba(24, 144, 255, 0.5)';
}

// Функция для сортировки сотрудников в отделах
function sortEmployeesInDepartments() {
    const departmentSections = document.querySelectorAll('.department-section');
    
    departmentSections.forEach(section => {
        const tbody = section.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr.employee-row'));
        if (rows.length <= 1) return;
        
        // Сортируем строки: сначала руководители, потом заместители, потом обычные сотрудники
        rows.sort((a, b) => {
            const aIsManager = a.classList.contains('manager-row');
            const bIsManager = b.classList.contains('manager-row');
            
            if (aIsManager && !bIsManager) return -1;
            if (!aIsManager && bIsManager) return 1;
            
            const aIsDeputy = a.classList.contains('deputy-row');
            const bIsDeputy = b.classList.contains('deputy-row');
            
            if (aIsDeputy && !bIsDeputy) return -1;
            if (!aIsDeputy && bIsDeputy) return 1;
            
            // Если оба имеют одинаковую роль, сортируем по имени
            const aName = a.cells[2].textContent;
            const bName = b.cells[2].textContent;
            return aName.localeCompare(bName);
        });
        
        // Очищаем tbody и добавляем отсортированные строки
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    });
}

// Вызываем функцию сортировки при загрузке страницы
$(document).ready(function() {
    console.log('Document ready event fired');
    
    try {
        // Инициализация Select2
        if (typeof $.fn.select2 === 'function') {
            console.log('Initializing Select2 (function exists)');
            $('.filter-select').select2({
                theme: 'bootstrap-5',
                placeholder: 'Выберите значения',
                allowClear: true
            });
        } else {
            console.error('Select2 library is not loaded properly!');
        }
        
        sortEmployeesInDepartments();
        
        // Обработчик для кнопки "Применить фильтры"
        document.getElementById('applyFilters').addEventListener('click', function() {
            const selectedDepartments = $('#departmentSelect').val() || [];
            const selectedPositions = $('#positionSelect').val() || [];
            const selectedRoles = $('#roleSelect').val() || [];
            filterEmployeesByDepartment(selectedDepartments, selectedPositions, selectedRoles);
        });
        
        // Обработчик для кнопки "Сбросить фильтры"
        document.getElementById('resetFilters').addEventListener('click', function() {
            $('#departmentSelect').val(null).trigger('change');
            $('#positionSelect').val(null).trigger('change');
            $('#roleSelect').val(null).trigger('change');
            filterEmployeesByDepartment([], [], []);
        });
        
        // Обработчик для поиска
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            searchEmployees(searchTerm);
        });
        
        // Обработчик для кнопок сворачивания/разворачивания отделов
        document.querySelectorAll('.toggle-department').forEach(button => {
            button.addEventListener('click', function(e) {
                // Предотвращаем всплытие события
                e.stopPropagation();
                
                const content = this.closest('.department-section').querySelector('.department-content');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    this.classList.remove('fa-chevron-down');
                    this.classList.add('fa-chevron-up');
                } else {
                    content.style.display = 'none';
                    this.classList.remove('fa-chevron-up');
                    this.classList.add('fa-chevron-down');
                }
                
                // Сохраняем состояние
                const departmentId = this.closest('.department-section').getAttribute('data-department-id');
                saveDepartmentState(departmentId, content.style.display === 'none');
            });
        });
        
        // Добавляем обработчик для клика на заголовок отдела
        document.querySelectorAll('.department-header').forEach(header => {
            header.addEventListener('click', function(e) {
                // Пропускаем, если клик был на drag-handle или toggle-department
                if (e.target.closest('.drag-handle') || e.target.closest('.toggle-department')) {
                    return;
                }
                
                // Находим кнопку сворачивания и программно кликаем по ней
                const toggleBtn = this.querySelector('.toggle-department');
                if (toggleBtn) {
                    toggleBtn.click();
                }
            });
        });
        
        // Обработчик для кнопки "Сменить пароль"
        document.getElementById('changePasswordBtn').addEventListener('click', function() {
            const employeeId = document.getElementById('editEmployeeId').value;
            if (employeeId) {
                // Здесь можно добавить логику для смены пароля
                alert('Функция смены пароля будет реализована позже');
            }
        });
        
        // Обработчик для кнопки "Сохранить" в модальном окне редактирования
        document.getElementById('saveEmployeeChanges').addEventListener('click', function() {
            updateEmployee();
        });
        
        // Обработчик для кнопок увольнения
        document.querySelectorAll('.fire-icon').forEach(icon => {
            icon.addEventListener('click', function() {
                const employeeId = this.getAttribute('data-id');
                const employeeName = this.closest('tr').querySelector('td:nth-child(3)').textContent;
                
                // Заполняем данные в модальном окне увольнения
                document.getElementById('fireEmployeeId').value = employeeId;
                document.getElementById('fireEmployeeName').textContent = employeeName;
                
                // Устанавливаем текущую дату в поле даты увольнения
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fireDate').value = today;
                
                // Открываем модальное окно увольнения
                const fireModal = new bootstrap.Modal(document.getElementById('fireEmployeeModal'));
                fireModal.show();
            });
        });
        
        // Обработчик для кнопки "Подтвердить" в модальном окне увольнения
        document.getElementById('confirmFire').addEventListener('click', function() {
            const employeeId = document.getElementById('fireEmployeeId').value;
            const fireDate = document.getElementById('fireDate').value;
            const fireReason = document.getElementById('fireReason').value;
            
            if (employeeId && fireDate) {
                fireEmployeeWithData(employeeId, fireDate, fireReason);
            } else {
                showNotification('Пожалуйста, укажите дату увольнения', 'warning');
            }
        });
        
        // Обработчик открытия модального окна добавления сотрудника
        $('#addEmployeeModal').on('shown.bs.modal', function (e) {
            console.log('Модальное окно добавления сотрудника открыто');
            loadPositionsAndRoles();
        });
        
        // Обработчик для кнопки "Добавить сотрудника"
        document.getElementById('addEmployeeBtn').addEventListener('click', function() {
            console.log('Нажата кнопка "Добавить сотрудника"');
            
            // Устанавливаем текущую дату в поле даты приема
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('addHireDate').value = today;
            
            // Генерируем случайный пароль
            const randomPassword = generateRandomPassword();
            document.getElementById('addPassword').value = randomPassword;
            
            // Показываем пароль
            document.getElementById('addPassword').type = 'text';
        });
        
        // Обработчик для кнопки переключения видимости пароля
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordField = document.getElementById('addPassword');
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                this.querySelector('i').classList.remove('fa-eye');
                this.querySelector('i').classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                this.querySelector('i').classList.remove('fa-eye-slash');
                this.querySelector('i').classList.add('fa-eye');
            }
        });
        
        // Обработчик для кнопки "Сохранить" в модальном окне добавления сотрудника
        document.getElementById('saveNewEmployee').addEventListener('click', function() {
            addNewEmployee();
        });
    } catch (e) {
        console.error('Error in document ready handler:', e);
    }
});

// Функция для генерации случайного пароля
function generateRandomPassword() {
    const length = 12;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+";
    let password = "";
    for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * charset.length);
        password += charset[randomIndex];
    }
    return password;
}

// Функция для добавления нового сотрудника
function addNewEmployee() {
    const form = document.getElementById('addEmployeeForm');
    const formData = new FormData(form);
    
    fetch('/admin/api/add_employee', {
        method: 'POST',
        body: formData
    })
            .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Сотрудник успешно добавлен', 'success');
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal'));
            modal.hide();
            // Перезагружаем страницу для отображения нового сотрудника
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            throw new Error(result.message || 'Ошибка при добавлении сотрудника');
        }
    })
    .catch(error => {
        console.error('Ошибка при добавлении сотрудника:', error);
        showNotification('Ошибка при добавлении сотрудника: ' + error.message, 'danger');
    });
}

// Функция для фильтрации сотрудников по отделам, должностям и ролям
function filterEmployeesByDepartment(selectedDepartments, selectedPositions, selectedRoles) {
    const departmentSections = document.querySelectorAll('.department-section');
    
    departmentSections.forEach(section => {
        const departmentId = section.getAttribute('data-department-id');
        const departmentName = section.querySelector('.department-header span').textContent;
        
        // Проверяем, соответствует ли отдел выбранным фильтрам
        const departmentMatch = selectedDepartments.length === 0 || 
                              selectedDepartments.includes('all') || 
                              selectedDepartments.includes(departmentId);
        
        if (departmentMatch) {
            section.style.display = 'block';
            
            // Фильтруем сотрудников внутри отдела
            const rows = section.querySelectorAll('.employee-row');
            rows.forEach(row => {
                const position = row.cells[3].textContent;
                const role = row.classList.contains('manager-row') ? 'leader' : 
                            row.classList.contains('deputy-row') ? 'deputy' : 'user';
                
                const positionMatch = selectedPositions.length === 0 || 
                                     selectedPositions.includes('all') || 
                                     selectedPositions.includes(position);
                
                const roleMatch = selectedRoles.length === 0 || 
                                 selectedRoles.includes('all') || 
                                 selectedRoles.includes(role);
                
                if (positionMatch && roleMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
                } else {
            section.style.display = 'none';
        }
    });
}

// Функция для поиска сотрудников
function searchEmployees(searchTerm) {
    const rows = document.querySelectorAll('.employee-row');
    
    rows.forEach(row => {
        const fullName = row.cells[2].textContent.toLowerCase();
        const position = row.cells[3].textContent.toLowerCase();
        const phone = row.cells[4].textContent.toLowerCase();
        const email = row.cells[5].textContent.toLowerCase();
        
        if (fullName.includes(searchTerm) || position.includes(searchTerm) || 
            phone.includes(searchTerm) || email.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Функция для перемещения отдела вверх или вниз
function moveDepartment(departmentId, direction) {
    fetch('/admin/api/update_department_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            department_id: departmentId,
            direction: direction
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Перезагружаем страницу для отображения обновленного порядка
            location.reload();
        } else {
            showNotification(data.message || 'Ошибка при обновлении порядка отдела', 'danger');
        }
    })
    .catch(error => {
        console.error('Ошибка при обновлении порядка отдела:', error);
        showNotification('Ошибка при обновлении порядка отдела: ' + error.message, 'danger');
    });
}

// Функция для загрузки должностей и ролей при открытии модального окна добавления сотрудника
async function loadPositionsAndRoles() {
    try {
        console.log('Загрузка должностей и ролей для модального окна добавления');
        
        // Загружаем должности для выпадающего списка
        const positionsResponse = await fetch('/admin/settings/positions');
        const positions = await positionsResponse.json();
        
        const addPositionSelect = document.getElementById('addPosition');
        addPositionSelect.innerHTML = '<option value="">Выберите должность</option>';
        
        positions.forEach(position => {
            const option = document.createElement('option');
            option.value = position.name;
            option.textContent = position.name;
            addPositionSelect.appendChild(option);
        });
        
        // Загружаем роли для выпадающего списка
        const rolesResponse = await fetch('/admin/settings/roles/get_available_roles');
        const rolesResult = await rolesResponse.json();
        
        const addRoleSelect = document.getElementById('addRole');
        addRoleSelect.innerHTML = '<option value="">Выберите роль</option>';
        
        if (rolesResult.roles && Array.isArray(rolesResult.roles)) {
            rolesResult.roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id || role.name;
                option.textContent = role.name;
                addRoleSelect.appendChild(option);
            });
        } else {
            // Добавляем стандартные роли, если API не вернул список
            const defaultRoles = [
                { id: 'user', name: 'Сотрудник' },
                { id: 'deputy', name: 'Заместитель' },
                { id: 'leader', name: 'Руководитель' },
                { id: 'admin', name: 'Администратор' }
            ];
            
            defaultRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                addRoleSelect.appendChild(option);
            });
        }
        
        console.log('Должности и роли успешно загружены');
    } catch (error) {
        console.error('Ошибка при загрузке должностей и ролей:', error);
        showNotification('Ошибка при загрузке должностей и ролей: ' + error.message, 'danger');
    }
}

// Модифицируем функцию для обработки номеров телефона
function formatPhoneNumbersForDisplay() {
    // Функция для добавления +7 к номеру при отображении
    function formatPhone(input) {
        const phoneInput = document.getElementById(input);
        if (phoneInput && phoneInput.value) {
            // Если номер не начинается с +7, добавляем его
            if (!phoneInput.value.startsWith('+7')) {
                phoneInput.value = phoneInput.value.trim();
            }
        }
    }
    
    // Применяем форматирование для всех полей телефонов
    document.querySelectorAll('input[name="corporate_number"], input[name="phone"], input[name="previous_number"]').forEach(input => {
        input.addEventListener('blur', function() {
            // Удаляем +7, если пользователь вручную его ввел
            if (this.value.startsWith('+7')) {
                this.value = this.value.substring(2);
            }
            // Удаляем все нецифровые символы
            this.value = this.value.replace(/\D/g, '');
        });
    });
}

// Вызываем функцию при загрузке документа
document.addEventListener('DOMContentLoaded', function() {
    formatPhoneNumbersForDisplay();
});

// Добавляем обработчик для модальных окон
document.getElementById('editEmployeeModal').addEventListener('shown.bs.modal', function() {
    formatPhoneNumbersForDisplay();
});

document.getElementById('addEmployeeModal').addEventListener('shown.bs.modal', function() {
    formatPhoneNumbersForDisplay();
});

// Добавляем в функцию loadEmployeeDataForEdit обработку номеров телефонов
const originalLoadEmployeeDataForEdit = loadEmployeeDataForEdit;
loadEmployeeDataForEdit = async function(employeeId) {
    await originalLoadEmployeeDataForEdit(employeeId);
    
    // Обработка номеров после загрузки данных
    const corporateNumber = document.getElementById('editCorporateNumber');
    const personalPhone = document.getElementById('editPersonalPhone');
    const previousNumber = document.getElementById('editPreviousNumber');
    
    if (corporateNumber && corporateNumber.value && corporateNumber.value.startsWith('+7')) {
        corporateNumber.value = corporateNumber.value.substring(2);
    }
    
    if (personalPhone && personalPhone.value && personalPhone.value.startsWith('+7')) {
        personalPhone.value = personalPhone.value.substring(2);
    }
    
    if (previousNumber && previousNumber.value && previousNumber.value.startsWith('+7')) {
        previousNumber.value = previousNumber.value.substring(2);
    }
};

function showNotification(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icon = document.createElement('i');
    icon.className = `toast-icon ${type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'}`;
    
    const content = document.createElement('div');
    content.className = 'toast-content';
    
    const title = document.createElement('div');
    title.className = 'toast-title';
    title.textContent = type === 'success' ? 'Успешно' : 'Ошибка';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'toast-message';
    messageDiv.textContent = message;
    
    content.appendChild(title);
    content.appendChild(messageDiv);
    
    toast.appendChild(icon);
    toast.appendChild(content);
    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => {
            container.removeChild(toast);
        }, 300);
    }, 3000);
}

// Обновляем обработку ответа в функции updateEmployeeData
function updateEmployeeData(formData) {
    const employeeId = formData.get('id');
    
    // Добавляем индикатор загрузки
    const saveButton = document.getElementById('saveEmployeeChanges');
    const originalText = saveButton.textContent;
    saveButton.textContent = 'Сохранение...';
    saveButton.disabled = true;
    
    fetch('/admin/api/update_employee', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Ошибка сервера');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Показываем уведомление об успехе
            showNotification('Изменения сохранены', 'success');
            
            // Перезагружаем данные сотрудника
            loadEmployeeDataForEdit(employeeId);
            
            // Закрываем модальное окно после успешного сохранения
            $('#editEmployeeModal').modal('hide');
        } else {
            // Показываем уведомление об ошибке
            showNotification(data.message || 'Ошибка сохранения', 'error');
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        // Показываем уведомление об ошибке
        showNotification('Ошибка сохранения', 'error');
    })
    .finally(() => {
        // Восстанавливаем кнопку
        saveButton.textContent = originalText;
        saveButton.disabled = false;
    });
}

// Обновляем обработку ошибок в функции handlePhotoUpload
function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Проверка размера файла (максимум 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Размер файла не должен превышать 5MB', 'error');
        event.target.value = '';
        return;
    }

    // Проверка типа файла
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        showNotification('Допустимые форматы: JPEG, PNG, GIF', 'error');
        event.target.value = '';
        return;
    }

    // Показываем превью
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('photoPreview');
        const placeholder = document.getElementById('photoPlaceholder');
        preview.src = e.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
    };
    reader.readAsDataURL(file);
}

function deletePhoto() {
    const photoInput = document.getElementById('employeePhoto');
    const photoPreview = document.getElementById('photoPreview');
    const photoPlaceholder = document.getElementById('photoPlaceholder');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');
    
    // Очищаем input
    photoInput.value = '';
    
    // Скрываем превью и показываем плейсхолдер
    photoPreview.style.display = 'none';
    photoPlaceholder.style.display = 'block';
    
    // Скрываем кнопку удаления
    deletePhotoBtn.style.display = 'none';
    
    // Добавляем скрытое поле для удаления фото
    const deletePhotoInput = document.createElement('input');
    deletePhotoInput.type = 'hidden';
    deletePhotoInput.name = 'delete_photo';
    deletePhotoInput.value = '1';
    photoInput.parentNode.appendChild(deletePhotoInput);
    
    // Закрываем модальное окно
    $('#confirmDeleteModal').modal('hide');
    
    // Показываем уведомление об успешном удалении
    showNotification('Фотография успешно удалена', 'success');
}

function handlePhotoUpload(event) {
    const file = event.target.files[0];
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');
    
    if (!file) {
        deletePhotoBtn.style.display = 'none';
        return;
    }

    // Проверка размера файла (максимум 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Размер файла не должен превышать 5MB', 'error');
        event.target.value = '';
        deletePhotoBtn.style.display = 'none';
        return;
    }

    // Проверка типа файла
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        showNotification('Допустимые форматы: JPEG, PNG, GIF', 'error');
        event.target.value = '';
        deletePhotoBtn.style.display = 'none';
        return;
    }

    // Показываем превью
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('photoPreview');
        const placeholder = document.getElementById('photoPlaceholder');
        preview.src = e.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        deletePhotoBtn.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

// Обновляем функцию loadEmployeeData для отображения кнопки удаления
function loadEmployeeData(employeeId) {
    // ... existing code ...
    
    // Проверяем наличие фото
    if (data.employee.photo_url) {
        const photoPreview = document.getElementById('photoPreview');
        const photoPlaceholder = document.getElementById('photoPlaceholder');
        const deletePhotoBtn = document.getElementById('deletePhotoBtn');
        
        photoPreview.src = data.employee.photo_url;
        photoPreview.style.display = 'block';
        photoPlaceholder.style.display = 'none';
        deletePhotoBtn.style.display = 'block';
    }
    
    // ... existing code ...
}

function confirmDeletePhoto() {
    $('#confirmDeleteModal').modal('show');
}

function deletePhoto() {
    const photoInput = document.getElementById('employeePhoto');
    const photoPreview = document.getElementById('employeePhotoPreview');
    const photoPlaceholder = document.getElementById('photoPlaceholder');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');
    const deletePhotoFlag = document.getElementById('deletePhotoFlag');
    
    // Очищаем input
    photoInput.value = '';
    
    // Скрываем превью и показываем плейсхолдер
    photoPreview.style.display = 'none';
    photoPlaceholder.style.display = 'block';
    
    // Скрываем кнопку удаления
    deletePhotoBtn.style.display = 'none';
    
    // Добавляем скрытое поле для удаления фото
    const deletePhotoInput = document.createElement('input');
    deletePhotoInput.type = 'hidden';
    deletePhotoInput.name = 'delete_photo';
    deletePhotoInput.value = '1';
    photoInput.parentNode.appendChild(deletePhotoInput);
    
    // Закрываем модальное окно
    $('#confirmDeleteModal').modal('hide');
    
    // Показываем уведомление об успешном удалении
    showNotification('Фотография успешно удалена', 'success');
}

function handlePhotoUpload(event) {
    const file = event.target.files[0];
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');
    
    if (!file) {
        deletePhotoBtn.style.display = 'none';
        return;
    }

    // Проверка размера файла (максимум 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Размер файла не должен превышать 5MB', 'error');
        event.target.value = '';
        deletePhotoBtn.style.display = 'none';
        return;
    }

    // Проверка типа файла
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        showNotification('Допустимые форматы: JPEG, PNG, GIF', 'error');
        event.target.value = '';
        deletePhotoBtn.style.display = 'none';
        return;
    }

    // Показываем превью
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('photoPreview');
        const placeholder = document.getElementById('photoPlaceholder');
        preview.src = e.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        deletePhotoBtn.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

// Обновляем функцию loadEmployeeData для отображения кнопки удаления
function loadEmployeeData(employeeId) {
    // ... existing code ...
    
    // Проверяем наличие фото
    if (data.employee.photo_url) {
        const photoPreview = document.getElementById('photoPreview');
        const photoPlaceholder = document.getElementById('photoPlaceholder');
        const deletePhotoBtn = document.getElementById('deletePhotoBtn');
        
        photoPreview.src = data.employee.photo_url;
        photoPreview.style.display = 'block';
        photoPlaceholder.style.display = 'none';
        deletePhotoBtn.style.display = 'block';
    }
    
    // ... existing code ...
}

// Функция для показа уведомлений
function showNotification(message, type) {
    const container = document.getElementById('toastContainer');
    if (!container) {
        console.error('Контейнер для уведомлений не найден');
        return;
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
    toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => {
            container.removeChild(toast);
        }, 300);
    }, 3000);
}

// Функция для обработки загрузки фото
function handlePhotoUpload(event) {
    const file = event.target.files[0];
    const photoPreview = document.getElementById('employeePhotoPreview');
    const photoPlaceholder = document.getElementById('photoPlaceholder');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');
    const deletePhotoFlag = document.getElementById('deletePhotoFlag');
    
    // Сбрасываем флаг удаления
    deletePhotoFlag.value = '0';
    
    if (!file) {
        photoPreview.style.display = 'none';
        photoPlaceholder.style.display = 'block';
        deletePhotoBtn.style.display = 'none';
        return;
    }
    
    // Проверка размера (максимум 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Размер файла не должен превышать 5MB', 'error');
        event.target.value = '';
        return;
    }
    
    // Проверка формата
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        showNotification('Допустимые форматы: JPEG, PNG, GIF', 'error');
        event.target.value = '';
        return;
    }
    
    // Показываем превью фото
    const reader = new FileReader();
    reader.onload = function(e) {
        photoPreview.src = e.target.result;
        photoPreview.style.display = 'block';
        photoPlaceholder.style.display = 'none';
        deletePhotoBtn.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

// Функция для подтверждения удаления фото
function confirmDeletePhoto() {
    $('#confirmDeleteModal').modal('show');
}

// Функция для удаления фото
function deletePhoto() {
    const photoInput = document.getElementById('employeePhoto');
    const photoPreview = document.getElementById('employeePhotoPreview');
    const photoPlaceholder = document.getElementById('photoPlaceholder');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');
    const deletePhotoFlag = document.getElementById('deletePhotoFlag');
    
    // Очищаем input и устанавливаем флаг удаления
    photoInput.value = '';
    deletePhotoFlag.value = '1';
    
    // Скрываем превью и показываем плейсхолдер
    photoPreview.style.display = 'none';
    photoPlaceholder.style.display = 'block';
    deletePhotoBtn.style.display = 'none';
    
    // Закрываем модальное окно
    $('#confirmDeleteModal').modal('hide');
    
    // Показываем уведомление
    showNotification('Фотография будет удалена после сохранения', 'success');
}

// Функция для переключения видимости истории изменений
function toggleHistoryCollapse() {
    const historyCollapse = $('#historyCollapse');
    historyCollapse.collapse('toggle');
    
    const arrow = $('#historyHeader').find('h5');
    if (historyCollapse.hasClass('show')) {
        arrow.text('История изменений ↑');
    } else {
        arrow.text('История изменений ↓');
    }
}

// Функция для загрузки истории изменений сотрудника
function loadEmployeeHistory(employeeId) {
    console.log('Загрузка истории изменений для сотрудника из HTML:', employeeId);
    
    // Правильный маршрут для получения истории с префиксом /admin
    const apiUrl = `/admin/employee_history/${employeeId}`;
    console.log('URL запроса истории из HTML:', apiUrl);
    
    // Добавляем случайный параметр для предотвращения кэширования
    const timestamp = new Date().getTime();
    const noCacheUrl = apiUrl + '?_=' + timestamp;
    console.log('URL запроса с антикэшем:', noCacheUrl);
    
    $.ajax({
        url: noCacheUrl,
        type: 'GET',
        cache: false,
        success: function(response) {
            console.log('Получен ответ от сервера истории из HTML:', response);
            if (response.success) {
                const tbody = $('#historyTable tbody');
                tbody.empty();
                
                if (response.history && response.history.length > 0) {
                    response.history.forEach(function(record) {
                        const row = $('<tr>');
                        row.append($('<td>').text(record.changed_at));
                        row.append($('<td>').text(record.field_name));
                        row.append($('<td>').text(record.old_value || '-'));
                        row.append($('<td>').text(record.new_value || '-'));
                        row.append($('<td>').text(record.changed_by_name || 'Система'));
                        tbody.append(row);
                    });
                } else {
                    tbody.html('<tr><td colspan="5" class="text-center">История изменений отсутствует</td></tr>');
                }
            } else {
                console.error('Ошибка при загрузке истории:', response.message);
                const tbody = $('#historyTable tbody');
                tbody.html('<tr><td colspan="5" class="text-center text-danger">Ошибка при загрузке истории: ' + response.message + '</td></tr>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Ошибка при загрузке истории из HTML:', error);
            console.error('Статус запроса:', status);
            console.error('XHR:', xhr);
            const tbody = $('#historyTable tbody');
            tbody.html('<tr><td colspan="5" class="text-center text-danger">Ошибка при загрузке истории</td></tr>');
        }
    });
}

// Функция для переключения видимости истории изменений
function toggleHistoryCollapse() {
    const historyCollapse = $('#historyCollapse');
    historyCollapse.collapse('toggle');
    
    const arrow = $('#historyHeader').find('h5');
    if (historyCollapse.hasClass('show')) {
        arrow.text('История изменений ↑');
    } else {
        arrow.text('История изменений ↓');
    }
}

// Открытие модального окна редактирования сотрудника
document.querySelectorAll('.edit-icon').forEach(icon => {
    icon.addEventListener('click', function() {
        const employeeId = this.getAttribute('data-id');
        
        // Убедимся, что поле логина видимо и заметно
        const systemLoginContainer = document.getElementById('systemLoginContainer');
        if (systemLoginContainer) {
            systemLoginContainer.style.display = 'block';
            systemLoginContainer.style.visibility = 'visible';
            systemLoginContainer.style.opacity = '1';
            // Добавляем заметное оформление
            systemLoginContainer.style.backgroundColor = '#e6f7ff';
            systemLoginContainer.style.border = '3px solid #1890ff';
            systemLoginContainer.style.padding = '10px';
            systemLoginContainer.style.borderRadius = '8px';
            systemLoginContainer.style.boxShadow = '0 0 10px rgba(24, 144, 255, 0.3)';
            
            const systemLoginField = document.getElementById('editLogin');
            if (systemLoginField) {
                systemLoginField.style.display = 'block';
                systemLoginField.style.visibility = 'visible';
            }
        }
        
        // Прямой запрос логина для надежности
        fetch(`/admin/api/get_employee_login?id=${employeeId}`)
        .then(response => response.json())
        .then(data => {
                if (data.success && data.login) {
                    console.log('Получен логин напрямую:', data.login);
                    const loginField = document.getElementById('editLogin');
                    if (loginField) {
                        setLoginValue(loginField, data.login);
                    }
        }
    })
    .catch(error => {
                console.error('Ошибка при запросе логина напрямую:', error);
            });
        
        // Загружаем данные сотрудника
        loadEmployeeDataForEdit(employeeId);
        
        // Загружаем историю изменений
        try {
            console.log('Пытаемся загрузить историю для ID:', employeeId);
            loadEmployeeHistory(employeeId);
        } catch (e) {
            console.error('Ошибка при загрузке истории:', e);
        }
        
        // Дополнительная проверка через небольшую задержку
        setTimeout(() => {
            const loginField = document.getElementById('editLogin');
            if (loginField) {
                console.log('Значение логина через 500мс:', loginField.value);
                if (!loginField.value || loginField.value === '') {
                    // Логин все еще не установлен, делаем еще один запрос
                    console.warn('Логин не установлен, делаем финальный запрос');
                    fetch(`/admin/api/get_employee_login?id=${employeeId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.login) {
                                console.log('Получен логин финальный:', data.login);
                                setLoginValue(loginField, data.login);
                            }
                        });
                }
            }
        }, 500);
    });
});

// ... existing code ...

// Функции для реализации Drag and Drop
document.addEventListener('DOMContentLoaded', function() {
    // Находим все элементы для перетаскивания
    const dragHandles = document.querySelectorAll('.drag-handle');
    const departmentSections = document.querySelectorAll('.department-section');
    
    let draggedElement = null;
    
    // Добавляем обработчики событий для каждого маркера перетаскивания
    dragHandles.forEach(handle => {
        handle.addEventListener('dragstart', function(e) {
            // Находим родительский элемент отдела
            draggedElement = this.closest('.department-section');
            draggedElement.classList.add('dragging');
            
            // Устанавливаем данные для перетаскивания
            e.dataTransfer.setData('text/plain', draggedElement.getAttribute('data-department-id'));
            e.dataTransfer.effectAllowed = 'move';
            
            // Устанавливаем прозрачное изображение для перетаскивания
            const dragImage = document.createElement('div');
            dragImage.textContent = draggedElement.querySelector('.department-name').textContent;
            dragImage.style.padding = '10px';
            dragImage.style.background = '#3498db';
            dragImage.style.color = 'white';
            dragImage.style.borderRadius = '5px';
            dragImage.style.position = 'absolute';
            dragImage.style.top = '-1000px';
            document.body.appendChild(dragImage);
            
            e.dataTransfer.setDragImage(dragImage, 0, 0);
            
            // Добавляем обработчик для удаления временного элемента
            setTimeout(() => {
                document.body.removeChild(dragImage);
            }, 0);
        });
        
        handle.addEventListener('dragend', function() {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
            
            // Удаляем все индикаторы drop target
            departmentSections.forEach(section => {
                section.classList.remove('drop-target');
            });
        });
    });
    
    // Добавляем обработчики событий для секций отделов (drop targets)
    departmentSections.forEach(section => {
        section.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Не добавляем класс, если это тот же самый элемент
            if (draggedElement !== this) {
                this.classList.add('drop-target');
            }
        });
        
        section.addEventListener('dragleave', function() {
            this.classList.remove('drop-target');
        });
        
        section.addEventListener('drop', function(e) {
            e.preventDefault();
            
            // Удаляем класс подсветки
            this.classList.remove('drop-target');
            
            // Получаем ID перетаскиваемого отдела
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetId = this.getAttribute('data-department-id');
            
            // Не делаем ничего, если перетаскиваем на тот же самый элемент
            if (draggedId === targetId) {
                return;
            }
            
            // Определяем направление перемещения
            const departments = Array.from(document.querySelectorAll('.department-section'));
            const draggedIndex = departments.findIndex(dept => dept.getAttribute('data-department-id') === draggedId);
            const targetIndex = departments.findIndex(dept => dept.getAttribute('data-department-id') === targetId);
            
            // Вызываем API для обновления порядка
            updateDepartmentPositions(draggedId, targetId, draggedIndex > targetIndex ? 'before' : 'after');
        });
    });
});

// Функция для обновления позиций отделов через API
function updateDepartmentPositions(draggedId, targetId, position) {
    fetch('/admin/api/update_department_positions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            dragged_id: draggedId,
            target_id: targetId,
            position: position
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Перезагружаем страницу для отображения нового порядка
            location.reload();
        } else {
            showNotification(data.message || 'Ошибка при обновлении порядка отделов', 'error');
        }
    })
    .catch(error => {
        console.error('Ошибка при обновлении порядка отделов:', error);
        showNotification('Ошибка при обновлении порядка отделов', 'error');
    });
}

// ... existing code ...

// Функция для сохранения состояния отделов
function saveDepartmentState(departmentId, isCollapsed) {
    const states = JSON.parse(localStorage.getItem('departmentStates') || '{}');
    states[departmentId] = isCollapsed;
    localStorage.setItem('departmentStates', JSON.stringify(states));
}

// Функция для загрузки состояния отделов
function loadDepartmentStates() {
    const states = JSON.parse(localStorage.getItem('departmentStates') || '{}');
    return states;
}

// Функция для сворачивания/разворачивания всех отделов
function toggleAllDepartments() {
    const button = document.getElementById('toggleAllDepartments');
    const icon = button.querySelector('i');
    const text = button.querySelector('span');
    const isCollapsed = icon.classList.contains('fa-chevron-down');
    
    document.querySelectorAll('.department-section').forEach(section => {
        const content = section.querySelector('.department-content');
        const toggleIcon = section.querySelector('.toggle-department');
        const departmentId = section.getAttribute('data-department-id');
        
        if (isCollapsed) {
            content.style.display = 'block';
            toggleIcon.classList.remove('fa-chevron-down');
            toggleIcon.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            toggleIcon.classList.remove('fa-chevron-up');
            toggleIcon.classList.add('fa-chevron-down');
        }
        
        saveDepartmentState(departmentId, !isCollapsed);
    });
    
    // Обновляем состояние кнопки
    if (isCollapsed) {
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        text.textContent = 'Свернуть все';
    } else {
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        text.textContent = 'Развернуть все';
    }
}

// Функция для восстановления состояния отделов при загрузке страницы
function restoreDepartmentStates() {
    const states = loadDepartmentStates();
    let allCollapsed = true;
    let allExpanded = true;
    
    document.querySelectorAll('.department-section').forEach(section => {
        const departmentId = section.getAttribute('data-department-id');
        const content = section.querySelector('.department-content');
        const toggleIcon = section.querySelector('.toggle-department');
        
        if (states[departmentId]) {
            content.style.display = 'none';
            toggleIcon.classList.remove('fa-chevron-up');
            toggleIcon.classList.add('fa-chevron-down');
            allExpanded = false;
        } else {
            content.style.display = 'block';
            toggleIcon.classList.remove('fa-chevron-down');
            toggleIcon.classList.add('fa-chevron-up');
            allCollapsed = false;
        }
    });
    
    // Обновляем состояние кнопки
    const button = document.getElementById('toggleAllDepartments');
    const icon = button.querySelector('i');
    const text = button.querySelector('span');
    
    if (allCollapsed) {
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        text.textContent = 'Развернуть все';
    } else if (allExpanded) {
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        text.textContent = 'Свернуть все';
    } else {
        // Если состояния смешанные, показываем "Свернуть все"
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        text.textContent = 'Свернуть все';
    }
}

// Функции для реализации Drag and Drop с улучшенной поддержкой захвата
document.addEventListener('DOMContentLoaded', function() {
    // Находим все элементы для перетаскивания
    const departmentSections = document.querySelectorAll('.department-section');
    
    // Делаем весь заголовок отдела перетаскиваемым для улучшения UX
    departmentSections.forEach(section => {
        const header = section.querySelector('.department-header');
        const dragHandle = section.querySelector('.drag-handle');
        const departmentId = section.getAttribute('data-department-id');
        
        if (dragHandle && header) {
            // Упрощаем захват, делая маркер более заметным
            dragHandle.innerHTML = '<i class="fas fa-grip-lines"></i>';
            
            // Обработчик для начала перетаскивания
            dragHandle.addEventListener('mousedown', function(e) {
                // Предотвращаем распространение события, чтобы не затронуть другие элементы
                e.stopPropagation();
                
                // Добавляем класс для визуальной индикации
                section.classList.add('dragging');
                
                // Делаем секцию draggable при нажатии на маркер
                section.setAttribute('draggable', 'true');
                
                // Запускаем перетаскивание программно
                section.ondragstart = function(event) {
                    event.dataTransfer.setData('text/plain', departmentId);
                    event.dataTransfer.effectAllowed = 'move';
                };
                
                // После начала перетаскивания убираем атрибут draggable
                section.ondragend = function() {
                    section.removeAttribute('draggable');
                    section.classList.remove('dragging');
                };
            });
            
            // Запрещаем перетаскивание при клике на другие элементы заголовка
            header.addEventListener('mousedown', function(e) {
                if (e.target !== dragHandle && !dragHandle.contains(e.target)) {
                    section.setAttribute('draggable', 'false');
                }
            });
        }
    });
    
    // Обработчики событий для секций отделов (drop targets)
    departmentSections.forEach(section => {
        section.addEventListener('dragover', function(e) {
            e.preventDefault();
            if (section !== document.querySelector('.dragging')) {
                this.classList.add('drop-target');
            }
        });
        
        section.addEventListener('dragleave', function() {
            this.classList.remove('drop-target');
        });
        
        section.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drop-target');
            
            // Получаем ID перетаскиваемого отдела
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetId = this.getAttribute('data-department-id');
            
            // Не делаем ничего, если перетаскиваем на тот же самый элемент
            if (draggedId === targetId) {
                return;
            }
            
            // Определяем направление перемещения
            const departments = Array.from(document.querySelectorAll('.department-section'));
            const draggedIndex = departments.findIndex(dept => dept.getAttribute('data-department-id') === draggedId);
            const targetIndex = departments.findIndex(dept => dept.getAttribute('data-department-id') === targetId);
            
            // Вызываем API для обновления порядка
            updateDepartmentPositions(draggedId, targetId, draggedIndex > targetIndex ? 'before' : 'after');
        });
    });
    
    // Восстанавливаем состояние отделов при загрузке страницы
    restoreDepartmentStates();
    
    // Добавляем обработчик для кнопки сворачивания/разворачивания всех отделов
    document.getElementById('toggleAllDepartments').addEventListener('click', toggleAllDepartments);
    
});
</script>
{% endblock %}