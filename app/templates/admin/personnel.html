{% extends "base.html" %}

{% block title %}Управление персоналом{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personnel_clean.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Навигационное меню -->
    <div class="personnel-nav">
        <a href="{{ url_for('admin_routes_unique.personnel') }}" class="active">
            <i class="fas fa-users"></i>
            Активные
        </a>
        <a href="{{ url_for('admin_routes_unique.fired_employees') }}">
            <i class="fas fa-user-times"></i>
            Уволенные
        </a>
        <a href="{{ url_for('admin_routes_unique.personnel_dashboard') }}">
            <i class="fas fa-chart-line"></i>
            Дашборд
        </a>
        <a href="{{ url_for('admin_routes_unique.phone_numbers') }}">
            <i class="fas fa-phone"></i>
            Номера
        </a>
    </div>

    <!-- Статистические карточки -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Всего сотрудников</div>
                <div class="stat-card-value">{{ total_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Активные</div>
                <div class="stat-card-value">{{ active_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-user-times"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Уволенные</div>
                <div class="stat-card-value">{{ fired_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Отделов</div>
                <div class="stat-card-value">{{ departments|length }}</div>
            </div>
        </div>
    </div>

    <!-- Поиск и фильтры -->
    <div class="search-filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Поиск сотрудников...">
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">
                <i class="fas fa-users"></i>
                Все
            </button>
            <button class="btn btn-secondary" onclick="openModal('filtersModal')">
                <i class="fas fa-filter"></i> Фильтры
            </button>
            <button class="btn btn-primary" id="addEmployeeBtn">
                <i class="fas fa-user-plus"></i>
                Добавить сотрудника
            </button>
        </div>
    </div>

    <!-- Отделы -->
    <div class="departments-container">
        <!-- DEBUG: Всего отделов: {{ departments|length }} -->
        {% for department in departments %}
            <!-- DEBUG: Отдел {{ department.name }}, employees = {{ department.employees|length if department.employees else 'None' }} -->
        <div class="department-card" data-department="{{ department.name }}" 
             draggable="true" data-department-id="{{ department.id }}">
            <div class="department-header">
                <div class="department-name">
            <div class="drag-handle">
                <i class="fas fa-grip-vertical"></i>
            </div>
                    {{ department.name }}
                </div>
                <div class="department-controls">
                    <div class="department-badge">{{ department.employees|length if department.employees else 0 }}</div>
                    <i class="fas fa-chevron-up department-toggle" data-department="{{ department.id }}"></i>
                </div>
            </div>
            <div class="department-content" id="dept-{{ department.id }}">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Роль</th>
                            <th>ФИО</th>
                            <th>Должность</th>
                            <th>Телефон</th>
                            <th>Email</th>
                            <th>RR</th>
                            <th>Сайт</th>
                            <th>Док</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if department.employees %}
                        {% for employee in department.employees %}
                        <tr class="{% if employee.role == 'leader' %}manager-row{% elif employee.role == 'deputy' %}deputy-row{% endif %}" data-employee="{{ employee.full_name|lower }}">
                            <td>{{ loop.index }}</td>
                            <td>
                                {% if employee.role == 'leader' %}
                                    <span class="text-danger">
                                        <i class="fas fa-crown" title="Руководитель"></i>
                                    </span>
                                {% elif employee.role == 'deputy' %}
                                    <span class="text-warning">
                                        <i class="fas fa-medal" title="Заместитель"></i>
                                    </span>
                                {% else %}
                                    <span class="text-muted">
                                        <i class="fas fa-user" title="Сотрудник"></i>
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>{{ employee.full_name }}</strong>
                                    <button class="btn btn-sm btn-outline-primary impersonate-btn" title="Войти как {{ employee.full_name }}" data-employee-id="{{ employee.id }}" data-employee-name="{{ employee.full_name }}">
                                        <i class="fas fa-sign-in-alt"></i>
                                    </button>
                                </div>
                            </td>
                            <td>{{ employee.position }}</td>
                            <td>{{ employee.corporate_phone or '—' }}</td>
                            <td>{{ employee.corporate_email or '—' }}</td>
                            <td class="text-center">
                                {% if employee.rr %}
                                    <i class="fas fa-check text-success"></i>
                                {% else %}
                                    <i class="fas fa-times text-muted"></i>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if employee.site %}
                                    <i class="fas fa-check text-success"></i>
                                {% else %}
                                    <i class="fas fa-times text-muted"></i>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if employee.documents %}
                                    <i class="fas fa-check text-success"></i>
                                {% else %}
                                    <i class="fas fa-times text-muted"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if employee.status == 'online' %}
                                    <span class="text-success">
                                        <i class="fas fa-circle"></i> {{ employee.status_display or 'Онлайн' }}
                                    </span>
                                {% elif employee.status == 'active' %}
                                    <span class="text-primary">
                                        <i class="fas fa-circle"></i> {{ employee.status_display or 'Активен' }}
                                    </span>
                                {% elif employee.status == 'blocked' %}
                                    <span class="text-danger">
                                        <i class="fas fa-ban"></i> {{ employee.status_display or 'Заблокирован' }}
                                    </span>
                                {% elif employee.status == 'fired' %}
                                    <span class="text-dark">
                                        <i class="fas fa-user-times"></i> {{ employee.status_display or 'Уволен' }}
                                    </span>
                                {% elif employee.status == 'inactive' %}
                                    <span class="text-warning">
                                        <i class="fas fa-circle"></i> {{ employee.status_display or 'Неактивен' }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">
                                        <i class="fas fa-circle"></i> {{ employee.status_display or 'Офлайн' }}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-icons">
                                    <i class="fas fa-edit action-icon edit edit-employee-btn" title="Редактировать" data-employee-id="{{ employee.id }}"></i>
                                    {% if employee.status == 'blocked' %}
                                    <i class="fas fa-unlock action-icon success unblock-employee-btn" title="Разблокировать" data-employee-id="{{ employee.id }}" data-employee-name="{{ employee.full_name }}"></i>
                                    {% else %}
                                    <i class="fas fa-ban action-icon delete block-employee-btn" title="Заблокировать" data-employee-id="{{ employee.id }}" data-employee-name="{{ employee.full_name }}"></i>
                                    {% endif %}
                                    <i class="fas fa-user-times action-icon delete fire-employee-btn" title="Уволить" data-employee-id="{{ employee.id }}" data-employee-name="{{ employee.full_name }}"></i>
                                    <i class="fas fa-exchange-alt action-icon move move-employee-btn" title="Переместить" data-employee-id="{{ employee.id }}"></i>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="11" class="text-center text-muted">
                                    Сотрудники не найдены (employees: {{ department.employees|length if department.employees else 'None' }})
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Модальное окно для добавления сотрудника -->
<div class="modal" id="addEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Добавить сотрудника</h3>
            <button class="modal-close" onclick="closeModal('addEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="addEmployeeForm">
                <div class="form-group">
                    <label class="form-label">ФИО</label>
                    <input type="text" class="form-control" name="full_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Должность</label>
                    <input type="text" class="form-control" name="position" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Отдел</label>
                    <select class="form-control" name="department_id" required>
                        <option value="">Выберите отдел</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Телефон</label>
                    <input type="tel" class="form-control" name="phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" name="corporate_email">
                </div>
                <div class="form-group">
                    <label class="form-label">Роль</label>
                    <select class="form-control" name="role">
                        <option value="employee">Сотрудник</option>
                        <option value="deputy">Заместитель</option>
                        <option value="leader">Руководитель</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addEmployeeModal')">Отмена</button>
            <button class="btn btn-primary" onclick="saveEmployee()">Сохранить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования сотрудника -->
<div class="modal" id="editEmployeeModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">Редактировать сотрудника</h3>
            <button class="modal-close" onclick="closeModal('editEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editEmployeeForm">
                <input type="hidden" name="employee_id">
                
                <!-- Фотография и основная информация -->
                <div class="employee-header">
                    <div class="employee-photo-section">
                        <div class="employee-photo-wrapper">
                            <img id="employeePhoto" src="/static/img/default-avatar.svg" alt="Фото сотрудника" class="employee-photo">
                            <div class="photo-overlay">
                                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-sm btn-light" onclick="document.getElementById('photoInput').click()">
                                    <i class="fas fa-camera"></i>
                                    Изменить фото
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="employee-basic-info">
                <div class="form-group">
                            <label class="form-label">ФИО *</label>
                    <input type="text" class="form-control" name="full_name" required>
                </div>
                <div class="form-group">
                            <label class="form-label">Должность *</label>
                    <select class="form-control" name="position" required>
                        <option value="">Выберите должность</option>
                        <!-- Загружается через JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                            <label class="form-label">Отдел *</label>
                    <select class="form-control" name="department_id" required>
                        <option value="">Выберите отдел</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                            <label class="form-label">Роль в системе</label>
                            <select class="form-control" name="role_id">
                                <option value="">Выберите роль</option>
                                <!-- Загружается через JavaScript -->
                            </select>
                </div>
                    </div>
                </div>

                <!-- Контактная информация -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-address-book"></i>
                        Контактная информация
                    </h4>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Корпоративный телефон</label>
                            <select class="form-control" name="corporate_phone" id="corpPhoneSelect">
                                <option value="">Выберите номер</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Личный телефон</label>
                            <input type="tel" class="form-control" name="personal_phone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Корпоративная почта</label>
                    <input type="email" class="form-control" name="corporate_email">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Личная почта</label>
                            <input type="email" class="form-control" name="personal_email">
                        </div>
                    </div>
                </div>

                <!-- Дополнительная информация -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Дополнительная информация
                    </h4>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Дата рождения</label>
                            <input type="date" class="form-control" name="birth_date">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Дата приёма на работу</label>
                            <input type="date" class="form-control" name="hire_date">
                        </div>
                </div>
                <div class="form-group">
                        <label class="form-label">Комментарии</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Дополнительные заметки о сотруднике"></textarea>
                    </div>
                    
                    <!-- Статусы доступа -->
                    <div class="access-toggles">
                        <h5 class="sub-section-title">Доступы и статусы</h5>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <div class="toggle-switch">
                                    <label class="switch">
                                        <input type="checkbox" name="rr_access">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label">RR доступ</span>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <div class="toggle-switch">
                                    <label class="switch">
                                        <input type="checkbox" name="website_access">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label">Доступ к сайту</span>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <div class="toggle-switch">
                                    <label class="switch">
                                        <input type="checkbox" name="documents_access">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label">Документы</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Системная информация -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-cog"></i>
                        Системная информация
                    </h4>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Статус</label>
                            <input type="text" class="form-control" name="status" readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Последняя активность</label>
                            <input type="text" class="form-control" name="last_active" readonly>
                        </div>
                    </div>
                    
                    <!-- Доступы к системам -->
                    <h5 class="sub-section-title">Доступы к системам</h5>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Логин в ПК</label>
                            <input type="text" class="form-control" name="pc_login" placeholder="Логин для входа в компьютер">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Пароль в ПК</label>
                            <input type="text" class="form-control" name="pc_password" placeholder="Пароль для входа в компьютер">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">CRM ID</label>
                            <input type="text" class="form-control" name="crm_id" placeholder="ID пользователя в CRM">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Офис</label>
                            <input type="text" class="form-control" name="office" placeholder="Номер офиса">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Логин в CRM</label>
                            <input type="text" class="form-control" name="crm_login" placeholder="Логин для входа в CRM">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Пароль в CRM</label>
                            <input type="text" class="form-control" name="crm_password" placeholder="Пароль для входа в CRM">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Логин в систему</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="login" placeholder="Логин для входа в систему" onchange="checkLoginChange(this)">
                                {% if current_user.role == 'admin' %}
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="changeEmployeePassword()" title="Сменить пароль">
                                        <i class="fas fa-key"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Дата увольнения</label>
                            <input type="date" class="form-control" name="fire_date">
                        </div>
                    </div>
                </div>
                
                <!-- История действий -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-history"></i>
                        История действий
                        <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="toggleHistory()">
                            <i class="fas fa-chevron-down" id="historyToggleIcon"></i>
                            <span id="historyToggleText">Показать</span>
                        </button>
                    </h4>
                    <div class="history-container" id="historyContainer" style="display: none;">
                        <div class="history-timeline" id="employeeHistory">
                            <!-- Загружается через JavaScript -->
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i>
                                Загрузка истории...
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editEmployeeModal')">Отмена</button>
            <button class="btn btn-danger" onclick="showFireEmployeeFromModal()">
                <i class="fas fa-user-times"></i>
                Уволить
            </button>
            <button class="btn btn-warning" onclick="showBlockEmployeeFromModal()" id="blockUnblockButton">
                <i class="fas fa-ban" id="blockUnblockIcon"></i>
                <span id="blockUnblockText">Заблокировать</span>
            </button>
            <button class="btn btn-primary" onclick="updateEmployee()">
                <i class="fas fa-save"></i>
                Сохранить изменения
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения блокировки -->
<div class="modal" id="blockEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Подтверждение блокировки</h3>
            <button class="modal-close" onclick="closeModal('blockEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы действительно хотите заблокировать сотрудника <strong id="blockEmployeeName"></strong>?</p>
            <div class="form-group">
                <label class="form-label">Причина блокировки</label>
                <textarea class="form-control" id="blockReason" rows="3" placeholder="Укажите причину блокировки сотрудника"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('blockEmployeeModal')">Отмена</button>
            <button class="btn btn-danger" onclick="confirmBlockEmployee()">Заблокировать</button>
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения разблокировки -->
<div class="modal" id="unblockEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Подтверждение разблокировки</h3>
            <button class="modal-close" onclick="closeModal('unblockEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы действительно хотите разблокировать сотрудника <strong id="unblockEmployeeName"></strong>?</p>
            <div class="form-group">
                <label class="form-label">Причина разблокировки</label>
                <textarea class="form-control" id="unblockReason" rows="3" placeholder="Укажите причину разблокировки сотрудника"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('unblockEmployeeModal')">Отмена</button>
            <button class="btn btn-success" onclick="confirmUnblockEmployee()">Разблокировать</button>
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения увольнения -->
<div class="modal" id="fireEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Подтверждение увольнения</h3>
            <button class="modal-close" onclick="closeModal('fireEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы действительно хотите уволить сотрудника <strong id="fireEmployeeName"></strong>?</p>
            <div class="form-group">
                <label class="form-label">Дата увольнения</label>
                <input type="date" class="form-control" id="fireDate" value="{{ current_date }}">
            </div>
            <div class="form-group">
                <label class="form-label">Причина увольнения</label>
                <textarea class="form-control" id="fireReason" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('fireEmployeeModal')">Отмена</button>
            <button class="btn btn-danger" onclick="confirmFireEmployee()">Уволить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для перемещения сотрудника -->
<div class="modal" id="moveEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Переместить сотрудника</h3>
            <button class="modal-close" onclick="closeModal('moveEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Переместить сотрудника <strong id="moveEmployeeName"></strong> в другой отдел?</p>
            <div class="form-group">
                <label class="form-label">Выберите новый отдел</label>
                <select class="form-control" id="moveEmployeeDepartment" required>
                    <option value="">Выберите отдел</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('moveEmployeeModal')">Отмена</button>
            <button class="btn btn-primary" onclick="confirmMoveEmployee()">Переместить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для фильтров -->
<div class="modal" id="filtersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Фильтры</h3>
            <button class="modal-close" onclick="closeModal('filtersModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Фильтр по должности</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="position_filter" value="managers" id="filter_managers"> Руководители
                    </label>
                    <label>
                        <input type="checkbox" name="position_filter" value="deputies" id="filter_deputies"> Заместители
                    </label>
                    <label>
                        <input type="checkbox" name="position_filter" value="employees" id="filter_employees"> Сотрудники
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Фильтр по отделам</label>
                <div class="checkbox-group" id="departmentFilters">
                    {% for department in departments %}
                    <label>
                        <input type="checkbox" name="department_filter" value="{{ department.id }}"> {{ department.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Фильтр по статусу</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="status_filter" value="online" id="filter_online"> Онлайн
                    </label>
                    <label>
                        <input type="checkbox" name="status_filter" value="offline" id="filter_offline"> Офлайн
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>
            <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для предупреждения смены логина -->
<div class="modal" id="loginWarningModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Предупреждение</h3>
            <button class="modal-close" onclick="closeModal('loginWarningModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Внимание!</strong>
            </div>
            <p>Вы уверены, что хотите изменить логин? При смене логина данные могут быть утеряны или отображены неверно.</p>
            <p>Старый логин: <strong id="oldLoginValue"></strong></p>
            <p>Новый логин: <strong id="newLoginValue"></strong></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="cancelLoginChange()">Отмена</button>
            <button class="btn btn-warning" onclick="confirmLoginChange()">Да, изменить</button>
        </div>
    </div>
</div>



<!-- Модальное окно для смены пароля -->
<div class="modal" id="changePasswordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Смена пароля</h3>
            <button class="modal-close" onclick="closeModal('changePasswordModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Логин:</label>
                <p id="changePasswordModalLogin" class="form-control-plaintext"></p>
            </div>
            <div class="form-group">
                <label class="form-label">Новый пароль:</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="newPassword" placeholder="Введите новый пароль">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('newPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Подтвердите пароль:</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="confirmPassword" placeholder="Подтвердите новый пароль">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('confirmPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Внимание:</strong> Смена пароля повлияет на доступ сотрудника к системе.
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('changePasswordModal')">Отмена</button>
            <button class="btn btn-warning" onclick="confirmPasswordChange()">Сменить пароль</button>
        </div>
    </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="toast-container">
</div>

{% endblock %}

{% block extra_js %}
<script>
// Toast уведомления
function showToast(type, title, message) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-triangle',
        warning: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
    };
    
    toast.innerHTML = `
        <div class="toast-icon">
            <i class="${icons[type] || icons.info}"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="hideToast(this)">
            <i class="fas fa-times"></i>
        </button>
        <div class="toast-progress"></div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Показываем toast
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Автоматически скрываем через 4 секунды
    setTimeout(() => {
        hideToast(toast.querySelector('.toast-close'));
    }, 4000);
}

function hideToast(button) {
    const toast = button.closest('.toast');
    toast.classList.remove('show');
    setTimeout(() => {
        toast.remove();
    }, 300);
}

// Функция для переключения истории действий
function toggleHistory() {
    const historyContainer = document.getElementById('historyContainer');
    const historyToggleIcon = document.getElementById('historyToggleIcon');
    const historyToggleText = document.getElementById('historyToggleText');
    
    if (historyContainer.style.display === 'none') {
        historyContainer.style.display = 'block';
        historyToggleIcon.classList.remove('fa-chevron-down');
        historyToggleIcon.classList.add('fa-chevron-up');
        historyToggleText.textContent = 'Скрыть';
        
        // Загружаем историю только при первом показе
        const employeeId = document.getElementById('editEmployeeForm').querySelector('input[name="employee_id"]').value;
        if (employeeId) {
            loadEmployeeHistory(employeeId);
        }
    } else {
        historyContainer.style.display = 'none';
        historyToggleIcon.classList.remove('fa-chevron-up');
        historyToggleIcon.classList.add('fa-chevron-down');
        historyToggleText.textContent = 'Показать';
    }
}

// Глобальные переменные для работы с изменением логина
let originalLoginValue = '';
let currentLoginInput = null;

// Функция для проверки изменения логина
function checkLoginChange(input) {
    const newValue = input.value.trim();
    const oldValue = originalLoginValue;
    
    if (newValue !== oldValue && oldValue !== '') {
        // Показываем предупреждение
        currentLoginInput = input;
        document.getElementById('oldLoginValue').textContent = oldValue;
        document.getElementById('newLoginValue').textContent = newValue;
        openModal('loginWarningModal');
    }
}

// Функция для отмены изменения логина
function cancelLoginChange() {
    if (currentLoginInput) {
        currentLoginInput.value = originalLoginValue;
        currentLoginInput = null;
    }
    closeModal('loginWarningModal');
}

// Функция для подтверждения изменения логина
function confirmLoginChange() {
    if (currentLoginInput) {
        originalLoginValue = currentLoginInput.value.trim();
        currentLoginInput = null;
    }
    closeModal('loginWarningModal');
}



// Функция для смены пароля сотрудника
function changeEmployeePassword() {
    const loginInput = document.querySelector('input[name="login"]');
    const loginValue = loginInput.value.trim();
    
    if (!loginValue) {
        showToast('warning', 'Предупреждение', 'Логин не указан');
        return;
    }
    
    // Заполняем модальное окно
    document.getElementById('changePasswordModalLogin').textContent = loginValue;
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    
    openModal('changePasswordModal');
}

// Функция для переключения видимости пароля
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling.querySelector('button');
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Функция для подтверждения смены пароля
function confirmPasswordChange() {
    const employeeId = document.querySelector('input[name="employee_id"]').value;
    const newPassword = document.getElementById('newPassword').value.trim();
    const confirmPassword = document.getElementById('confirmPassword').value.trim();
    
    if (!newPassword) {
        showToast('warning', 'Предупреждение', 'Введите новый пароль');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showToast('error', 'Ошибка', 'Пароли не совпадают');
        return;
    }
    
    if (newPassword.length < 6) {
        showToast('warning', 'Предупреждение', 'Пароль должен содержать минимум 6 символов');
        return;
    }
    
    // Отправляем запрос на смену пароля
    fetch('/admin/api/change_employee_password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            employee_id: employeeId,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Успешно', 'Пароль успешно изменен');
            closeModal('changePasswordModal');
        } else {
            showToast('error', 'Ошибка', data.message || 'Не удалось изменить пароль');
        }
    })
    .catch(error => {
        showToast('error', 'Ошибка', 'Произошла ошибка при смене пароля');
    });
}

// Поиск сотрудников
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const employees = document.querySelectorAll('[data-employee]');
    
    employees.forEach(employee => {
        const name = employee.getAttribute('data-employee');
        if (name.includes(searchTerm)) {
            employee.style.display = '';
        } else {
            employee.style.display = 'none';
        }
    });
    
    // Скрываем отделы без видимых сотрудников
    document.querySelectorAll('.department-card').forEach(dept => {
        const visibleEmployees = dept.querySelectorAll('[data-employee]:not([style*="display: none"])');
        if (visibleEmployees.length === 0) {
            dept.style.display = 'none';
        } else {
            dept.style.display = '';
        }
    });
    
    // Обновляем счетчики отделов
    updateDepartmentCounts();
});

// Фильтрация
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.dataset.filter) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            const employees = document.querySelectorAll('tbody tr');
            
            employees.forEach(employee => {
                if (filter === 'all') {
                    employee.style.display = '';
                } else if (filter === 'managers' && employee.classList.contains('manager-row')) {
                    employee.style.display = '';
                } else if (filter === 'deputies' && employee.classList.contains('deputy-row')) {
                    employee.style.display = '';
                } else if (filter === 'managers' || filter === 'deputies') {
                    employee.style.display = 'none';
                }
            });
        }
    });
});

// Сворачивание/разворачивание отделов
document.querySelectorAll('.department-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
        const departmentId = this.dataset.department;
        const content = document.getElementById('dept-' + departmentId);
        
        if (content.style.display === 'none') {
            content.style.display = '';
            this.classList.remove('fa-chevron-down');
            this.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            this.classList.remove('fa-chevron-up');
            this.classList.add('fa-chevron-down');
        }
    });
});

// Модальные окна
function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Обработчики кнопок действий
document.getElementById('addEmployeeBtn').addEventListener('click', function() {
    openModal('addEmployeeModal');
});

// Загрузка должностей не требуется, так как используется текстовое поле
function loadPositions() {
    // Должности вводятся как текст, загрузка не требуется
    console.log('Должности вводятся как текст');
}

// Загрузка ролей при инициализации  
async function loadRoles() {
    try {
        const response = await fetch('/admin/api/get_roles');
        const data = await response.json();
        
        if (data.success) {
            const roleSelect = document.querySelector('select[name="role_id"]');
            roleSelect.innerHTML = '<option value="">Выберите роль</option>';
            
            data.roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                roleSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Ошибка при загрузке ролей:', error);
    }
}

// Загрузка должностей при инициализации
async function loadPositions() {
    try {
        const response = await fetch('/admin/api/get_positions');
        const data = await response.json();
        
        if (data.success) {
            const positionSelect = document.querySelector('select[name="position"]');
            if (positionSelect) {
                // Сохраняем текущее значение
                const currentValue = positionSelect.value;
                
                // Очищаем селект и добавляем пустую опцию
                positionSelect.innerHTML = '<option value="">Выберите должность</option>';
                
                // Добавляем должности
                data.positions.forEach(position => {
                    const option = document.createElement('option');
                    option.value = position.name;
                    option.textContent = position.name;
                    positionSelect.appendChild(option);
                });
                
                // Восстанавливаем значение
                positionSelect.value = currentValue;
            }
        }
    } catch (error) {
        console.error('Ошибка при загрузке должностей:', error);
    }
}

// Загрузка истории действий сотрудника
async function loadEmployeeHistory(employeeId) {
    try {
        const response = await fetch(`/admin/api/get_employee_history?id=${employeeId}`);
        const data = await response.json();
        
        const historyContainer = document.getElementById('employeeHistory');
        
        if (data.success && data.history.length > 0) {
            historyContainer.innerHTML = '';
            
            data.history.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const iconClass = getHistoryIconClass(record.action_type);
                
                historyItem.innerHTML = `
                    <div class="history-icon ${iconClass}">
                        <i class="fas ${getHistoryIcon(record.action_type)}"></i>
                    </div>
                    <div class="history-content">
                        <div class="history-action">${record.description}</div>
                        <div class="history-details">Пользователь: ${record.changed_by_name || 'Система'}</div>
                        <div class="history-timestamp">${record.created_at}</div>
                    </div>
                `;
                
                historyContainer.appendChild(historyItem);
            });
        } else {
            historyContainer.innerHTML = '<div class="text-center text-muted py-3">История действий пуста</div>';
        }
    } catch (error) {
        console.error('Ошибка при загрузке истории:', error);
        document.getElementById('employeeHistory').innerHTML = '<div class="text-center text-muted py-3">Ошибка загрузки истории</div>';
    }
}

// Вспомогательные функции для истории
function getHistoryIconClass(actionType) {
    const iconClasses = {
        'created': 'created',
        'updated': 'updated', 
        'moved': 'moved',
        'fired': 'fired',
        'restored': 'restored'
    };
    return iconClasses[actionType] || 'updated';
}

function getHistoryIcon(actionType) {
    const icons = {
        'created': 'fa-plus',
        'updated': 'fa-edit',
        'moved': 'fa-exchange-alt', 
        'fired': 'fa-user-times',
        'restored': 'fa-user-plus'
    };
    return icons[actionType] || 'fa-edit';
}

// Функция для загрузки данных сотрудника
function loadEmployeeDataForEdit(employeeId) {
    fetch(`/admin/api/get_employee?id=${employeeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.employee) {
                const employee = data.employee;
                console.log('Загруженные данные сотрудника:', employee);
                const form = document.getElementById('editEmployeeForm');
                
                // Основные данные
                form.querySelector('input[name="employee_id"]').value = employee.id;
                form.querySelector('input[name="full_name"]').value = employee.full_name || '';
                
                // Должность - проверяем, что селект существует
                const positionSelect = form.querySelector('select[name="position"]');
                if (positionSelect) {
                    positionSelect.value = employee.position || '';
                }
                
                form.querySelector('select[name="department_id"]').value = employee.department_id || '';
                form.querySelector('select[name="role_id"]').value = employee.role || employee.role_id || '';
                
                // Контактная информация
                form.querySelector('input[name="personal_phone"]').value = employee.Phone || '';
                form.querySelector('input[name="corporate_email"]').value = employee.corporate_email || '';
                form.querySelector('input[name="personal_email"]').value = employee.personal_email || '';
                
                // Загружаем доступные номера для отдела
                loadAvailablePhones(employee.department_id, employee.corp_phone, employee.id);
                
                // Обновляем кнопку блокировки/разблокировки
                updateBlockUnblockButton(employee.status);
                
                // Дополнительная информация
                form.querySelector('input[name="birth_date"]').value = employee.birth_date || '';
                form.querySelector('input[name="hire_date"]').value = employee.hire_date || '';
                form.querySelector('textarea[name="notes"]').value = employee.notes || '';
                
                // Тумблеры доступа
                form.querySelector('input[name="rr_access"]').checked = employee.rr == 1 || employee.rr === true;
                form.querySelector('input[name="website_access"]').checked = employee.site == 1 || employee.site === true;
                form.querySelector('input[name="documents_access"]').checked = employee.documents == 1 || employee.documents === true;
                
                // Системная информация
                form.querySelector('input[name="status"]').value = employee.status_display || 'Офлайн';
                form.querySelector('input[name="last_active"]').value = employee.last_active || 'Не зарегистрирован';
                form.querySelector('input[name="pc_login"]').value = employee.pc_login || '';
                form.querySelector('input[name="pc_password"]').value = employee.pc_password || '';
                form.querySelector('input[name="crm_id"]').value = employee.crm_id || '';
                form.querySelector('input[name="office"]').value = employee.office || '';
                form.querySelector('input[name="login"]').value = employee.login || '';
                originalLoginValue = employee.login || '';  // Сохраняем изначальное значение
                form.querySelector('input[name="fire_date"]').value = employee.fire_date || '';
                
                // CRM доступы
                form.querySelector('input[name="crm_login"]').value = employee.crm_login || '';
                form.querySelector('input[name="crm_password"]').value = employee.crm_password || '';
                
                // Фотография
                if (employee.photo_url) {
                    document.getElementById('employeePhoto').src = employee.photo_url;
                } else {
                    document.getElementById('employeePhoto').src = '/static/img/default-avatar.svg';
                }
                
                // Сбрасываем состояние истории
                document.getElementById('historyContainer').style.display = 'none';
                document.getElementById('historyToggleIcon').classList.remove('fa-chevron-up');
                document.getElementById('historyToggleIcon').classList.add('fa-chevron-down');
                document.getElementById('historyToggleText').textContent = 'Показать';
                
                // Загружаем роли и должности для селектов
                loadRoles();
                loadPositions();
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке данных сотрудника:', error);
        });
}

// Обработчик загрузки фотографии
document.getElementById('photoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('employeePhoto').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Функция для загрузки ролей
function loadRoles() {
    fetch('/admin/api/get_roles')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const roleSelect = document.querySelector('select[name="role_id"]');
                if (roleSelect) {
                    // Сохраняем текущее значение
                    const currentValue = roleSelect.value;
                    
                    // Очищаем селект и добавляем пустую опцию
                    roleSelect.innerHTML = '<option value="">Выберите роль</option>';
                    
                    // Добавляем роли
                    data.roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id || role.name;
                        option.textContent = role.name;
                        roleSelect.appendChild(option);
                    });
                    
                    // Восстанавливаем значение
                    roleSelect.value = currentValue;
                }
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке ролей:', error);
        });
}

// Функция для загрузки доступных номеров для отдела
function loadAvailablePhones(departmentId, currentPhone, employeeId) {
    if (!departmentId) return;
    
    // Добавляем employeeId в запрос для определения текущего сотрудника
    const url = `/admin/api/get_available_phones?department_id=${departmentId}` + 
               (employeeId ? `&current_employee_id=${employeeId}` : '');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const phoneSelect = document.querySelector('select[name="corporate_phone"]');
                if (phoneSelect) {
                    // Очищаем селект и добавляем пустую опцию
                    phoneSelect.innerHTML = '<option value="">Выберите номер</option>';
                    
                    // Добавляем доступные номера
                    data.numbers.forEach(number => {
                        const option = document.createElement('option');
                        option.value = number.phone_number;
                        
                        // Формируем текст опции в зависимости от статуса
                        let optionText = number.phone_number;
                        if (number.status === 'current') {
                            optionText += ' (текущий номер)';
                        } else if (number.status === 'occupied') {
                            optionText += ` (занят - ${number.assigned_to})`;
                            // Можно оставить занятые номера доступными для смены
                        } else if (number.status === 'free') {
                            optionText += ' (свободен)';
                        }
                        
                        option.textContent = optionText;
                        
                        // Добавляем CSS класс для стилизации
                        if (number.status === 'current') {
                            option.classList.add('current-phone');
                        } else if (number.status === 'occupied') {
                            option.classList.add('occupied-phone');
                        } else if (number.status === 'free') {
                            option.classList.add('free-phone');
                        }
                        
                        phoneSelect.appendChild(option);
                    });
                    
                    // Если у сотрудника уже есть номер, выбираем его
                    if (currentPhone) {
                        phoneSelect.value = currentPhone;
                    }
                }
            } else {
                console.error('Ошибка при загрузке номеров:', data.message);
            }
        })
        .catch(error => {
            console.error('Ошибка при загрузке номеров:', error);
            // В случае ошибки оставляем поле как текстовое
            const phoneSelect = document.querySelector('select[name="corporate_phone"]');
            if (phoneSelect) {
                phoneSelect.innerHTML = '<option value="">Ошибка загрузки номеров</option>';
            }
        });
}

// Обработчик изменения отдела для обновления списка номеров
document.addEventListener('change', function(e) {
    if (e.target.name === 'department_id') {
        const departmentId = e.target.value;
        const employeeId = document.querySelector('input[name="employee_id"]')?.value;
        const currentPhone = document.querySelector('select[name="corporate_phone"]')?.value;
        loadAvailablePhones(departmentId, currentPhone, employeeId);
    }
});

// Функция для преобразования статуса в русское название
function getStatusDisplayName(status) {
    const statusMap = {
        'active': 'Активен',
        'blocked': 'Заблокирован', 
        'fired': 'Уволен',
        'offline': 'Офлайн'
    };
    return statusMap[status] || status;
}

// Функция для получения английского кода статуса по русскому названию
function getStatusCode(displayName) {
    const statusMap = {
        'Онлайн': 'online',
        'Активен': 'active',
        'Заблокирован': 'blocked',
        'Уволен': 'fired', 
        'Офлайн': 'offline'
    };
    return statusMap[displayName] || displayName;
}

// Функция для обновления кнопки блокировки/разблокировки
function updateBlockUnblockButton(status) {
    const button = document.getElementById('blockUnblockButton');
    const icon = document.getElementById('blockUnblockIcon');
    const text = document.getElementById('blockUnblockText');
    
    if (status === 'blocked') {
        button.className = 'btn btn-success';
        icon.className = 'fas fa-unlock';
        text.textContent = 'Разблокировать';
    } else {
        button.className = 'btn btn-warning';
        icon.className = 'fas fa-ban';
        text.textContent = 'Заблокировать';
    }
}

// Функция для показа модального окна увольнения из модального окна редактирования
function showFireEmployeeFromModal() {
    const employeeId = document.querySelector('input[name="employee_id"]').value;
    const employeeName = document.querySelector('input[name="full_name"]').value;
    
    // Закрываем модальное окно редактирования
    closeModal('editEmployeeModal');
    
    // Заполняем данные для увольнения
    document.getElementById('fireEmployeeModal').dataset.employeeId = employeeId;
    document.getElementById('fireEmployeeName').textContent = employeeName;
    document.getElementById('fireDate').value = new Date().toISOString().substr(0, 10);
    document.getElementById('fireReason').value = '';
    
    // Показываем модальное окно увольнения
        openModal('fireEmployeeModal');
}

// Функция для показа модального окна блокировки из модального окна редактирования
function showBlockEmployeeFromModal() {
    const employeeId = document.querySelector('input[name="employee_id"]').value;
    const employeeName = document.querySelector('input[name="full_name"]').value;
    const employeeStatus = document.querySelector('input[name="status"]').value;
    
    // Закрываем модальное окно редактирования
    closeModal('editEmployeeModal');
    
    // Проверяем статус сотрудника
    const statusCode = getStatusCode(employeeStatus);
    
    if (statusCode === 'blocked') {
        // Показываем модальное окно разблокировки
        document.getElementById('unblockEmployeeModal').dataset.employeeId = employeeId;
        document.getElementById('unblockEmployeeName').textContent = employeeName;
        document.getElementById('unblockReason').value = '';
        
        openModal('unblockEmployeeModal');
    } else {
        // Показываем модальное окно блокировки
        document.getElementById('blockEmployeeModal').dataset.employeeId = employeeId;
        document.getElementById('blockEmployeeName').textContent = employeeName;
        document.getElementById('blockReason').value = '';
        
        openModal('blockEmployeeModal');
    }
}

// Обработчики для редактирования
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('edit-employee-btn')) {
        const employeeId = e.target.dataset.employeeId;
        loadEmployeeDataForEdit(employeeId);
        openModal('editEmployeeModal');
    }
    
    if (e.target.classList.contains('block-employee-btn')) {
        const employeeId = e.target.dataset.employeeId;
        const employeeName = e.target.dataset.employeeName;
        
        document.getElementById('blockEmployeeModal').dataset.employeeId = employeeId;
        document.getElementById('blockEmployeeName').textContent = employeeName;
        document.getElementById('blockReason').value = '';
        
        openModal('blockEmployeeModal');
    }
    
    if (e.target.classList.contains('unblock-employee-btn')) {
        const employeeId = e.target.dataset.employeeId;
        const employeeName = e.target.dataset.employeeName;
        
        // Показываем модальное окно разблокировки
        document.getElementById('unblockEmployeeModal').dataset.employeeId = employeeId;
        document.getElementById('unblockEmployeeName').textContent = employeeName;
        document.getElementById('unblockReason').value = '';
        
        openModal('unblockEmployeeModal');
    }
    
    if (e.target.classList.contains('impersonate-btn') || e.target.closest('.impersonate-btn')) {
        const button = e.target.classList.contains('impersonate-btn') ? e.target : e.target.closest('.impersonate-btn');
        const employeeId = button.dataset.employeeId;
        const employeeName = button.dataset.employeeName;
        
        if (confirm(`Вы действительно хотите войти как ${employeeName}?`)) {
            // Перенаправляем на страницу входа под другим пользователем
            window.location.href = `/admin/impersonate/${employeeId}`;
        }
    }
    
    if (e.target.classList.contains('fire-employee-btn')) {
        const employeeId = e.target.dataset.employeeId;
        const employeeName = e.target.dataset.employeeName;
        
        document.getElementById('fireEmployeeModal').dataset.employeeId = employeeId;
        document.getElementById('fireEmployeeName').textContent = employeeName;
        document.getElementById('fireDate').value = new Date().toISOString().substr(0, 10);
        
        openModal('fireEmployeeModal');
    }
    
    if (e.target.classList.contains('move-employee-btn')) {
        const employeeId = e.target.dataset.employeeId;
        const employeeName = e.target.closest('tr').querySelector('td:nth-child(3)').textContent.trim();
        
        document.getElementById('moveEmployeeModal').dataset.employeeId = employeeId;
        document.getElementById('moveEmployeeName').textContent = employeeName;
        
        openModal('moveEmployeeModal');
    }
});

// Функции для работы с данными
function saveEmployee() {
    const form = document.getElementById('addEmployeeForm');
    const formData = new FormData(form);
    
    // Преобразуем FormData в объект
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    fetch('/admin/api/add_employee', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeModal('addEmployeeModal');
            showToast('success', 'Сотрудник добавлен', 'Новый сотрудник успешно добавлен');
            location.reload();
        } else {
            showToast('error', 'Ошибка добавления', result.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showToast('error', 'Ошибка сети', 'Произошла ошибка при добавлении сотрудника');
    });
}

function updateEmployee() {
    const form = document.getElementById('editEmployeeForm');
    const formData = new FormData(form);
    
    // Проверяем, есть ли файл фотографии
    const photoFile = document.getElementById('photoInput').files[0];
    
    // Правильно обрабатываем чекбоксы доступа
    const rr_checkbox = form.querySelector('input[name="rr_access"]');
    const website_checkbox = form.querySelector('input[name="website_access"]');
    const documents_checkbox = form.querySelector('input[name="documents_access"]');
    
    // Удаляем старые названия чекбоксов и добавляем правильные
    formData.delete('rr_access');
    formData.delete('website_access');
    formData.delete('documents_access');
    
    formData.set('rr', rr_checkbox ? rr_checkbox.checked : false);
    formData.set('site', website_checkbox ? website_checkbox.checked : false);
    formData.set('documents', documents_checkbox ? documents_checkbox.checked : false);
    
    // Сопоставляем поля HTML с полями БД
    if (formData.get('personal_phone')) {
        formData.set('Phone', formData.get('personal_phone'));
        formData.delete('personal_phone');
    }
    if (formData.get('corporate_phone')) {
        formData.set('corp_phone', formData.get('corporate_phone'));
        formData.delete('corporate_phone');
    }
    
    // Добавляем фото, если выбрано
    if (photoFile) {
        formData.set('employee_photo', photoFile);
    }
    
    console.log('Отправляемые данные (FormData):', Array.from(formData.entries()));
    
    fetch('/admin/api/update_employee', {
        method: 'POST',
        body: formData  // Отправляем FormData, не JSON
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeModal('editEmployeeModal');
            showToast('success', 'Сотрудник сохранен', 'Данные сотрудника успешно обновлены');
            location.reload();
        } else {
            showToast('error', 'Ошибка сохранения', result.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showToast('error', 'Ошибка сети', 'Произошла ошибка при обновлении данных сотрудника');
    });
}

function confirmBlockEmployee() {
    const employeeId = document.getElementById('blockEmployeeModal').dataset.employeeId;
    const blockReason = document.getElementById('blockReason').value;
    
    const data = {
        id: employeeId,
        block_reason: blockReason
    };
    
    fetch('/admin/api/block_employee', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('blockEmployeeModal');
            showToast('warning', 'Сотрудник заблокирован', 'Сотрудник успешно заблокирован');
            location.reload();
        } else {
            showToast('error', 'Ошибка блокировки', data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showToast('error', 'Ошибка сети', 'Произошла ошибка при блокировке сотрудника');
    });
}

function confirmUnblockEmployee() {
    const employeeId = document.getElementById('unblockEmployeeModal').dataset.employeeId;
    const unblockReason = document.getElementById('unblockReason').value;
    
    const data = {
        id: employeeId,
        unblock_reason: unblockReason
    };
    
    fetch('/admin/api/unblock_employee', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('unblockEmployeeModal');
            showToast('success', 'Сотрудник разблокирован', 'Сотрудник успешно разблокирован');
            location.reload();
        } else {
            showToast('error', 'Ошибка разблокировки', data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showToast('error', 'Ошибка сети', 'Произошла ошибка при разблокировке сотрудника');
    });
}

function confirmFireEmployee() {
    const employeeId = document.getElementById('fireEmployeeModal').dataset.employeeId;
    const fireDate = document.getElementById('fireDate').value;
    const fireReason = document.getElementById('fireReason').value;
    
    if (!fireDate) {
        showToast('warning', 'Предупреждение', 'Пожалуйста, выберите дату увольнения');
        return;
    }
    
    const data = {
        id: employeeId,
        fire_date: fireDate,
        fire_reason: fireReason
    };
    
    fetch('/admin/api/fire_employee', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('fireEmployeeModal');
            showToast('warning', 'Сотрудник уволен', 'Сотрудник успешно уволен');
            location.reload();
        } else {
            showToast('error', 'Ошибка увольнения', data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showToast('error', 'Ошибка сети', 'Произошла ошибка при увольнении сотрудника');
    });
}

function confirmMoveEmployee() {
    const employeeId = document.getElementById('moveEmployeeModal').dataset.employeeId;
    const newDepartmentId = document.getElementById('moveEmployeeDepartment').value;
    
    if (!newDepartmentId) {
        alert('Пожалуйста, выберите отдел');
        return;
    }
    
    const data = {
        employee_id: employeeId,
        new_department_id: newDepartmentId
    };
    
    fetch('/admin/api/move_employee', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('moveEmployeeModal');
            showToast('info', 'Сотрудник перемещен', 'Сотрудник успешно перемещен в другой отдел');
            location.reload();
        } else {
            showToast('error', 'Ошибка перемещения', data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        showToast('error', 'Ошибка сети', 'Произошла ошибка при перемещении сотрудника');
    });
}

// Drag and Drop функционал для отделов
let draggedElement = null;
let draggedOverElement = null;

document.querySelectorAll('.department-card').forEach(card => {
    card.addEventListener('dragstart', function(e) {
        console.log('Drag start triggered for department:', this.dataset.departmentId);
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    });
    
    card.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        draggedElement = null;
        
        // Убираем все классы drag-over
        document.querySelectorAll('.department-card').forEach(c => {
            c.classList.remove('drag-over', 'drag-over-bottom');
        });
    });
    
    card.addEventListener('dragover', function(e) {
        if (draggedElement && draggedElement !== this) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Определяем позицию курсора относительно элемента
            const rect = this.getBoundingClientRect();
            const midPoint = rect.top + rect.height / 2;
            
            // Убираем все классы drag-over
            document.querySelectorAll('.department-card').forEach(c => {
                c.classList.remove('drag-over', 'drag-over-bottom');
            });
            
            this.classList.add('drag-over');
            if (e.clientY > midPoint) {
                this.classList.add('drag-over-bottom');
            }
            
            draggedOverElement = this;
        }
    });
    
    card.addEventListener('drop', function(e) {
        if (draggedElement && draggedElement !== this) {
            e.preventDefault();
            
            const draggedId = draggedElement.dataset.departmentId;
            const targetId = this.dataset.departmentId;
            
            // Определяем позицию (до или после)
            const rect = this.getBoundingClientRect();
            const midPoint = rect.top + rect.height / 2;
            const position = e.clientY > midPoint ? 'after' : 'before';
            
            // Отправляем запрос на сервер
            console.log('Отправляем запрос на перемещение:', {draggedId, targetId, position});
            fetch('/admin/api/update_department_positions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dragged_id: draggedId,
                    target_id: targetId,
                    position: position
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка при перемещении: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при перемещении отдела');
            });
        }
        
        // Убираем все классы drag-over
        document.querySelectorAll('.department-card').forEach(c => {
            c.classList.remove('drag-over', 'drag-over-bottom');
        });
    });
});

// Функция для отправки heartbeat и обновления статуса
function sendHeartbeat() {
    fetch('/admin/api/heartbeat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Heartbeat sent successfully');
        }
    })
    .catch(error => {
        console.error('Error sending heartbeat:', error);
    });
}

// Отправляем heartbeat каждые 2 минуты
setInterval(sendHeartbeat, 120000);

// Отправляем heartbeat при загрузке страницы
sendHeartbeat();

// Функции для продвинутых фильтров
function applyFilters() {
    // Получаем выбранные фильтры
    const positionFilters = Array.from(document.querySelectorAll('input[name="position_filter"]:checked')).map(cb => cb.value);
    const departmentFilters = Array.from(document.querySelectorAll('input[name="department_filter"]:checked')).map(cb => cb.value);
    const statusFilters = Array.from(document.querySelectorAll('input[name="status_filter"]:checked')).map(cb => cb.value);
    
    // Получаем все отделы
    const departmentCards = document.querySelectorAll('.department-card');
    
    departmentCards.forEach(departmentCard => {
        const departmentId = departmentCard.dataset.departmentId;
        const employees = departmentCard.querySelectorAll('tbody tr');
        let visibleEmployeesInDepartment = 0;
        
        employees.forEach(employee => {
            let shouldShow = true;
            
            // Пропускаем строки с сообщением "Сотрудники не найдены"
            if (employee.textContent.includes('Сотрудники не найдены')) {
                return;
            }
            
            // Фильтр по должности
            if (positionFilters.length > 0) {
                const isManager = employee.classList.contains('manager-row');
                const isDeputy = employee.classList.contains('deputy-row');
                
                const matchesPosition = positionFilters.some(filter => {
                    if (filter === 'managers' && isManager) return true;
                    if (filter === 'deputies' && isDeputy) return true;
                    if (filter === 'employees' && !isManager && !isDeputy) return true;
                    return false;
                });
                
                if (!matchesPosition) shouldShow = false;
            }
            
            // Фильтр по отделам
            if (departmentFilters.length > 0) {
                if (!departmentId || !departmentFilters.includes(departmentId)) {
                    shouldShow = false;
                }
            }
            
            // Фильтр по статусу
            if (statusFilters.length > 0) {
                const statusCell = employee.querySelector('td:nth-child(5)');
                const isOnline = statusCell && statusCell.textContent.includes('Онлайн');
                
                const matchesStatus = statusFilters.some(filter => {
                    if (filter === 'online' && isOnline) return true;
                    if (filter === 'offline' && !isOnline) return true;
                    return false;
                });
                
                if (!matchesStatus) shouldShow = false;
            }
            
            employee.style.display = shouldShow ? '' : 'none';
            
            if (shouldShow) {
                visibleEmployeesInDepartment++;
            }
        });
        
        // Скрываем отдел, если в нем нет видимых сотрудников
        if (visibleEmployeesInDepartment === 0) {
            departmentCard.style.display = 'none';
        } else {
            departmentCard.style.display = '';
        }
    });
    
    // Обновляем счетчики отделов
    updateDepartmentCounts();
    
    closeModal('filtersModal');
}

function resetFilters() {
    // Сбрасываем все чекбоксы
    document.querySelectorAll('#filtersModal input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Показываем все отделы
    const departmentCards = document.querySelectorAll('.department-card');
    departmentCards.forEach(departmentCard => {
        departmentCard.style.display = '';
        
        // Показываем все строки сотрудников в отделе
        const employees = departmentCard.querySelectorAll('tbody tr');
        employees.forEach(employee => {
            employee.style.display = '';
        });
    });
    
    // Обновляем счетчики отделов
    updateDepartmentCounts();
    
    closeModal('filtersModal');
}

function updateDepartmentCounts() {
    const departmentCards = document.querySelectorAll('.department-card');
    
    departmentCards.forEach(card => {
        // Пропускаем скрытые отделы
        if (card.style.display === 'none') {
            return;
        }
        
        const visibleRows = card.querySelectorAll('tbody tr:not([style*="display: none"])');
        const badge = card.querySelector('.department-badge');
        
        // Считаем только реальные строки сотрудников (не строки с сообщением "не найдены")
        let actualCount = 0;
        visibleRows.forEach(row => {
            if (!row.textContent.includes('Сотрудники не найдены')) {
                actualCount++;
            }
        });
        
        badge.textContent = actualCount;
    });
}

// Система контроля доступа
const ACCESS_LEVELS = {
    FULL: 'full',        // Полный доступ - все можно редактировать
    WRITE: 'write',      // Запись - все можно делать кроме редактирования роли и логина, нельзя удалять сотрудников
    READ: 'read',        // Просмотр - можно все смотреть, редактировать ничего нельзя
    NONE: 'none'         // Нет доступа - доступа нет
};

// Получение уровня доступа текущего пользователя к модулю персонала
function getPersonnelAccessLevel() {
    // Здесь должна быть логика определения уровня доступа из backend
    // Пока возвращаем полный доступ для демонстрации
    return ACCESS_LEVELS.FULL;
}

// Проверка разрешений
function hasPermission(action) {
    const level = getPersonnelAccessLevel();
    
    switch (action) {
        case 'view':
            return level !== ACCESS_LEVELS.NONE;
        case 'edit':
            return level === ACCESS_LEVELS.FULL || level === ACCESS_LEVELS.WRITE;
        case 'edit_role':
            return level === ACCESS_LEVELS.FULL;
        case 'edit_login':
            return level === ACCESS_LEVELS.FULL;
        case 'delete':
            return level === ACCESS_LEVELS.FULL;
        case 'create':
            return level === ACCESS_LEVELS.FULL || level === ACCESS_LEVELS.WRITE;
        default:
            return false;
    }
}

// Применение ограничений доступа к элементам интерфейса
function applyAccessRestrictions() {
    const level = getPersonnelAccessLevel();
    
    // Если нет доступа - скрываем всю страницу
    if (level === ACCESS_LEVELS.NONE) {
        document.body.innerHTML = '<div class="text-center p-5"><h3>У вас нет доступа к этому модулю</h3></div>';
        return;
    }
    
    // Если только просмотр - отключаем все кнопки редактирования
    if (level === ACCESS_LEVELS.READ) {
        document.querySelectorAll('.edit-employee-btn, .fire-employee-btn, .move-employee-btn').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.title = 'У вас нет прав для редактирования';
        });
        
        // Отключаем модальные окна редактирования
        document.querySelectorAll('form input, form select, form textarea').forEach(input => {
            input.disabled = true;
        });
        
        // Скрываем кнопки сохранения
        document.querySelectorAll('.btn-primary').forEach(btn => {
            if (btn.textContent.includes('Сохранить') || btn.textContent.includes('Добавить')) {
                btn.style.display = 'none';
            }
        });
    }
    
    // Если уровень записи - скрываем специфичные поля
    if (level === ACCESS_LEVELS.WRITE) {
        // Отключаем поля роли и логина в системе
        document.querySelectorAll('select[name="role_id"], input[name="login"]').forEach(input => {
            input.disabled = true;
            input.style.opacity = '0.5';
        });
        
        // Скрываем кнопки полного удаления сотрудников
        document.querySelectorAll('.delete-employee-btn').forEach(btn => {
            btn.style.display = 'none';
        });
        
        // Добавляем подсказки
        document.querySelectorAll('select[name="role_id"]').forEach(select => {
            select.parentElement.innerHTML += '<small class="text-muted">Недостаточно прав для изменения роли</small>';
        });
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadPositions();
    loadRoles();
    applyAccessRestrictions();
});

</script>
{% endblock %} 