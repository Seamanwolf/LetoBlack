{% extends "base.html" %}

{% block title %}Уволенные сотрудники{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personnel_clean.css') }}">
<style>
/* Стили для истории изменений */
.history-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    background-color: #f9f9f9;
}

.history-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px;
    margin-bottom: 10px;
    background-color: white;
    border-radius: 6px;
    border-left: 4px solid #007bff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.history-item:last-child {
    margin-bottom: 0;
}

.history-date {
    font-size: 12px;
    color: #666;
    font-weight: 500;
    min-width: 120px;
}

.history-description {
    flex: 1;
    margin: 0 15px;
    font-size: 14px;
    color: #333;
    line-height: 1.4;
}

.history-user {
    font-size: 12px;
    color: #888;
    font-style: italic;
    min-width: 100px;
    text-align: right;
}

.history-loading {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 20px;
}

.history-empty {
    text-align: center;
    color: #999;
    font-style: italic;
    padding: 20px;
}

/* Счетчик сотрудников */
.employees-counter {
    margin-top: 2rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: var(--border-radius);
    text-align: center;
    border: 1px solid #e9ecef;
}

.counter-info {
    font-size: 1.1rem;
    color: #495057;
    font-weight: 500;
}

.counter-info span {
    font-weight: 600;
    color: var(--primary-color);
}

#filteredCount {
    color: #6c757d;
    font-size: 0.9rem;
    margin-left: 0.5rem;
}

/* Адаптивность для истории */
@media (max-width: 768px) {
    .history-item {
        flex-direction: column;
        gap: 5px;
    }
    
    .history-date,
    .history-user {
        min-width: auto;
        text-align: left;
    }
    
    .employees-counter {
        margin-top: 1rem;
        padding: 0.75rem;
    }
    
    .counter-info {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Навигационное меню -->
    <div class="personnel-nav">
        <a href="{{ url_for('admin_routes_unique.personnel') }}">
            <i class="fas fa-users"></i>
            Активные
        </a>
        <a href="{{ url_for('admin_routes_unique.fired_employees') }}" class="active">
            <i class="fas fa-user-times"></i>
            Уволенные
        </a>
        <a href="{{ url_for('admin_routes_unique.personnel_dashboard') }}">
            <i class="fas fa-chart-line"></i>
            Дашборд
        </a>
        <a href="{{ url_for('admin_routes_unique.phone_numbers') }}">
            <i class="fas fa-phone"></i>
            Номера
        </a>
    </div>

    <!-- Статистические карточки -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Всего сотрудников</div>
                <div class="stat-card-value">{{ total_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Активные</div>
                <div class="stat-card-value">{{ active_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-user-times"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Уволенные</div>
                <div class="stat-card-value">{{ fired_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Отделов</div>
                <div class="stat-card-value">{{ departments|length }}</div>
            </div>
        </div>
    </div>

    <!-- Поиск и фильтры -->
    <div class="search-filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Поиск уволенных сотрудников...">
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">
                <i class="fas fa-users"></i>
                Все
            </button>
            <button class="btn btn-secondary" onclick="openModal('filtersModal')">
                <i class="fas fa-filter"></i> Фильтры
            </button>
            <button class="btn btn-primary" id="toggleAllBtn">
                <i class="fas fa-expand-arrows-alt"></i>
                Развернуть все
            </button>
        </div>
    </div>

    <!-- Отделы с уволенными сотрудниками -->
    <div class="departments-container">
        {% set employees_by_department = {} %}
        {% for employee in employees %}
            {% if employee.department_name not in employees_by_department %}
                {% set _ = employees_by_department.update({employee.department_name: []}) %}
            {% endif %}
            {% set _ = employees_by_department[employee.department_name].append(employee) %}
        {% endfor %}

        {% for department in departments|sort(attribute='display_order') %}
            {% if department.name in employees_by_department %}
                {% set department_employees = employees_by_department[department.name] %}
                <div class="department-card" data-department="{{ department.name }}" 
                     draggable="true" data-department-id="{{ department.id }}">
                    <div class="department-header">
                        <div class="department-name">
                    <div class="drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                            {{ department.name }}
                        </div>
                        <div class="department-controls">
                            <div class="department-badge">{{ department_employees|length }}</div>
                            <i class="fas fa-chevron-up department-toggle" data-department="{{ department.id }}"></i>
                        </div>
                    </div>
                    <div class="department-content" id="dept-{{ department.id }}">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ФИО</th>
                                    <th>Телефон</th>
                                    <th>Email</th>
                                    <th>Дата приема</th>
                                    <th>Дата увольнения</th>
                                    <th>Отработано дней</th>
                                    <th>Последний корп. номер</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in department_employees %}
                                <tr class="{% if employee.role == 'leader' or employee.role == '2' or employee.role_id == 2 %}manager-row{% elif employee.role == 'deputy' %}deputy-row{% endif %}" 
                                    data-employee="{{ employee.full_name|lower }}"
                                    data-fire-date="{{ employee.fire_date_formatted }}"
                                    data-days-worked="{{ employee.days_worked or 0 }}">
                                    <td>
                                        <strong>{{ employee.full_name }}</strong>
                                        {% if employee.role == 'leader' or employee.role == '2' or employee.role_id == 2 %}
                                            <span class="text-danger">
                                                <i class="fas fa-crown" title="Руководитель"></i>
                                            </span>
                                        {% elif employee.role == 'deputy' %}
                                            <span class="text-warning">
                                                <i class="fas fa-medal" title="Заместитель"></i>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ employee.Phone or '—' }}</td>
                                    <td>{{ employee.personal_email or '—' }}</td>
                                    <td>{{ employee.hire_date_formatted or '—' }}</td>
                                    <td>{{ employee.fire_date_formatted }}</td>
                                    <td>{{ employee.days_worked or '—' }}</td>
                                    <td>{{ employee.last_corp_number or '—' }}</td>
                                    <td>
                                        <div class="action-icons">
                                            <i class="fas fa-eye action-icon view" title="Просмотр" data-employee-id="{{ employee.id }}"></i>
                                            <i class="fas fa-user-plus action-icon restore" title="Восстановить" data-employee-id="{{ employee.id }}"></i>
                                            <i class="fas fa-trash-alt action-icon delete" title="Удалить" data-employee-id="{{ employee.id }}"></i>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    
    <!-- Счетчик сотрудников -->
    <div class="employees-counter">
        <div class="counter-info">
            <span id="employeesCount">{{ employees|length }}</span> уволенных сотрудников
            <span id="filteredCount" style="display: none;"></span>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра информации о уволенном сотруднике -->
<div class="modal" id="viewEmployeeModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">Информация о уволенном сотруднике</h3>
            <button class="modal-close" onclick="closeModal('viewEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="viewEmployeeForm">
                <input type="hidden" name="employee_id">
                
                <!-- Фотография и основная информация -->
                <div class="employee-header">
                    <div class="employee-photo-section">
                        <div class="employee-photo-wrapper">
                            <img id="viewEmployeePhoto" src="/static/img/default-avatar.svg" alt="Фото сотрудника" class="employee-photo">
                        </div>
                    </div>
                    <div class="employee-basic-info">
                    <div class="form-group">
                            <label class="form-label">ФИО</label>
                            <input type="text" class="form-control" name="full_name" readonly>
                    </div>
                    <div class="form-group">
                            <label class="form-label">Должность</label>
                            <input type="text" class="form-control" name="position" readonly>
                    </div>
                    <div class="form-group">
                            <label class="form-label">Отдел</label>
                            <input type="text" class="form-control" name="department_name" readonly>
                    </div>
                    <div class="form-group">
                            <label class="form-label">Роль в системе</label>
                            <input type="text" class="form-control" name="role_display" readonly>
                    </div>
                </div>
                    </div>

                <!-- Контактная информация -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-address-book"></i>
                        Контактная информация
                    </h4>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Личный телефон</label>
                            <input type="tel" class="form-control" name="personal_phone" readonly>
                    </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Корпоративный телефон</label>
                            <input type="tel" class="form-control" name="corporate_phone" readonly>
                    </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Личная почта</label>
                            <input type="email" class="form-control" name="personal_email" readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Корпоративная почта</label>
                            <input type="email" class="form-control" name="corporate_email" readonly>
                        </div>
                    </div>
                </div>

                <!-- Даты работы -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-calendar"></i>
                        Даты работы
                    </h4>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Дата приема на работу</label>
                            <input type="text" class="form-control" name="hire_date_display" readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Дата увольнения</label>
                            <input type="text" class="form-control" name="fire_date_display" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Отработано дней</label>
                            <input type="text" class="form-control" name="days_worked" readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Последний корпоративный номер</label>
                            <input type="text" class="form-control" name="last_corp_number" readonly>
                        </div>
                    </div>
                </div>

                <!-- Дополнительная информация -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Дополнительная информация
                    </h4>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Дата рождения</label>
                            <input type="text" class="form-control" name="birth_date_display" readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Офис</label>
                            <input type="text" class="form-control" name="office" readonly>
                </div>
            </div>
            <div class="form-group">
                        <label class="form-label">Комментарии</label>
                        <textarea class="form-control" name="notes" rows="3" readonly></textarea>
            </div>
                    
                    <!-- Статусы доступа -->
                    <div class="access-toggles">
                        <h5 class="sub-section-title">Доступы и статусы</h5>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <div class="toggle-switch">
                                    <label class="switch">
                                        <input type="checkbox" name="rr_access" disabled>
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label">RR доступ</span>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <div class="toggle-switch">
                                    <label class="switch">
                                        <input type="checkbox" name="website_access" disabled>
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label">Доступ к сайту</span>
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <div class="toggle-switch">
                                    <label class="switch">
                                        <input type="checkbox" name="documents_access" disabled>
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label">Документы</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Системная информация -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-cog"></i>
                        Системная информация
                    </h4>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Логин в систему</label>
                            <input type="text" class="form-control" name="login" readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">Логин в ПК</label>
                            <input type="text" class="form-control" name="pc_login" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">CRM ID</label>
                            <input type="text" class="form-control" name="crm_id" readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="form-label">CRM логин</label>
                            <input type="text" class="form-control" name="crm_login" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- История изменений -->
                <div class="info-section">
                    <h4 class="section-title">
                        <i class="fas fa-history"></i>
                        История изменений
                        <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="toggleHistory()">
                            <i class="fas fa-chevron-down" id="historyToggleIcon"></i>
                            <span id="historyToggleText">Показать</span>
                        </button>
                    </h4>
                    <div class="history-container" id="historyContainer" style="display: none;">
                        <div class="history-timeline" id="employeeHistory">
                            <!-- Загружается через JavaScript -->
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i>
                                Загрузка истории...
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('viewEmployeeModal')">Закрыть</button>
            <button class="btn btn-success" onclick="rehireEmployee()">
                <i class="fas fa-user-plus"></i>
                Восстановить сотрудника
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения восстановления -->
<div class="modal" id="restoreEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Восстановление сотрудника</h3>
            <button class="modal-close" onclick="closeModal('restoreEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы действительно хотите восстановить сотрудника <strong id="restoreEmployeeName"></strong>?</p>
            <div class="form-group">
                <label class="form-label">Отдел для восстановления</label>
                <select class="form-control" id="restoreDepartment" required>
                    <option value="">Выберите отдел</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Дата восстановления</label>
                <input type="date" class="form-control" id="restoreDate" value="{{ current_date }}">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('restoreEmployeeModal')">Отмена</button>
            <button class="btn btn-success" onclick="confirmRestoreEmployee()">Восстановить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения удаления -->
<div class="modal" id="deleteEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Подтверждение удаления</h3>
            <button class="modal-close" onclick="closeModal('deleteEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы действительно хотите <strong class="text-danger">удалить</strong> сотрудника <strong id="deleteEmployeeName"></strong>?</p>
            <p class="text-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Это действие необратимо. Все данные сотрудника будут удалены навсегда.
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('deleteEmployeeModal')">Отмена</button>
            <button class="btn btn-danger" onclick="confirmDeleteEmployee()">Удалить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для фильтров -->
<div class="modal" id="filtersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Фильтры</h3>
            <button class="modal-close" onclick="closeModal('filtersModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Фильтр по должности</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="position_filter" value="managers" id="filter_managers"> Руководители
                    </label>
                    <label>
                        <input type="checkbox" name="position_filter" value="deputies" id="filter_deputies"> Заместители
                    </label>
                    <label>
                        <input type="checkbox" name="position_filter" value="employees" id="filter_employees"> Сотрудники
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Фильтр по отделам</label>
                <div class="checkbox-group" id="departmentFilters">
                    {% for department in departments %}
                    <label>
                        <input type="checkbox" name="department_filter" value="{{ department.id }}"> {{ department.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Период работы</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="period_filter" value="short" id="filter_short"> До 3 месяцев
                    </label>
                    <label>
                        <input type="checkbox" name="period_filter" value="medium" id="filter_medium"> 3-12 месяцев
                    </label>
                    <label>
                        <input type="checkbox" name="period_filter" value="long" id="filter_long"> Более года
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>
            <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Поиск сотрудников
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const employees = document.querySelectorAll('[data-employee]');
    
    employees.forEach(employee => {
        const name = employee.getAttribute('data-employee');
        if (name.includes(searchTerm)) {
            employee.style.display = '';
        } else {
            employee.style.display = 'none';
        }
    });
    
    // Скрыть отделы без видимых сотрудников
    document.querySelectorAll('.department-card').forEach(dept => {
        const visibleEmployees = dept.querySelectorAll('[data-employee]:not([style*="display: none"])');
        if (visibleEmployees.length === 0) {
            dept.style.display = 'none';
        } else {
            dept.style.display = '';
        }
    });
    
    // Обновляем счетчик
    updateDepartmentVisibility();
});

// Фильтрация
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.dataset.filter) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            const employees = document.querySelectorAll('tbody tr');
            
            employees.forEach(employee => {
                const daysWorked = parseInt(employee.getAttribute('data-days-worked')) || 0;
                
                if (filter === 'all') {
                    employee.style.display = '';
                } else if (filter === 'recent' && daysWorked <= 90) {
                    employee.style.display = '';
                } else if (filter === 'long-term' && daysWorked > 90) {
                    employee.style.display = '';
                } else {
                    employee.style.display = 'none';
                }
            });
            
            // Скрыть пустые отделы и обновить счетчик
            updateDepartmentVisibility();
        }
    });
});

// Сворачивание/разворачивание отделов
document.querySelectorAll('.department-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
        const departmentId = this.dataset.department;
        const content = document.getElementById('dept-' + departmentId);
        
        if (content.style.display === 'none') {
            content.style.display = '';
            this.classList.remove('fa-chevron-down');
            this.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            this.classList.remove('fa-chevron-up');
            this.classList.add('fa-chevron-down');
        }
    });
});

// Развернуть/свернуть все отделы
document.getElementById('toggleAllBtn').addEventListener('click', function() {
    const allExpanded = document.querySelectorAll('.department-toggle.fa-chevron-up').length > 0;
    
    document.querySelectorAll('.department-toggle').forEach(toggle => {
        const departmentId = toggle.dataset.department;
        const content = document.getElementById('dept-' + departmentId);
        
        if (allExpanded) {
            content.style.display = 'none';
            toggle.classList.remove('fa-chevron-up');
            toggle.classList.add('fa-chevron-down');
        } else {
            content.style.display = '';
            toggle.classList.remove('fa-chevron-down');
            toggle.classList.add('fa-chevron-up');
        }
    });
    
    this.innerHTML = allExpanded ? 
        '<i class="fas fa-expand-arrows-alt"></i> Развернуть все' : 
        '<i class="fas fa-compress-arrows-alt"></i> Свернуть все';
});

// Модальные окна
function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Обработчики действий
document.querySelectorAll('.action-icon.view').forEach(icon => {
    icon.addEventListener('click', function() {
        const employeeId = this.dataset.employeeId;
        // Здесь загружаем данные сотрудника
        loadEmployeeData(employeeId);
        openModal('viewEmployeeModal');
    });
});

document.querySelectorAll('.action-icon.restore').forEach(icon => {
    icon.addEventListener('click', function() {
        const employeeId = this.dataset.employeeId;
        const row = this.closest('tr');
        const employeeName = row.querySelector('strong').textContent;
        
        document.getElementById('restoreEmployeeName').textContent = employeeName;
        document.getElementById('restoreEmployeeModal').dataset.employeeId = employeeId;
        openModal('restoreEmployeeModal');
    });
});

document.querySelectorAll('.action-icon.delete').forEach(icon => {
    icon.addEventListener('click', function() {
        const employeeId = this.dataset.employeeId;
        const row = this.closest('tr');
        const employeeName = row.querySelector('strong').textContent;
        
        document.getElementById('deleteEmployeeName').textContent = employeeName;
        document.getElementById('deleteEmployeeModal').dataset.employeeId = employeeId;
        openModal('deleteEmployeeModal');
    });
});

// API функции
function loadEmployeeData(employeeId) {
    fetch(`/admin/api/get_fired_employee?id=${employeeId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const employee = data.employee;
            const form = document.getElementById('viewEmployeeForm');
            
            // Заполняем форму данными
            form.querySelector('input[name="employee_id"]').value = employee.id;
            form.querySelector('input[name="full_name"]').value = employee.full_name || '';
            form.querySelector('input[name="position"]').value = employee.position || '';
            form.querySelector('input[name="department_name"]').value = employee.department_name || '';
            
            // Определяем роль для отображения
            let roleDisplay = 'Сотрудник';
            if (employee.role === 'leader' || employee.role === '2' || employee.role_id === 2) {
                roleDisplay = 'Руководитель';
            } else if (employee.role === 'deputy') {
                roleDisplay = 'Заместитель';
            }
            form.querySelector('input[name="role_display"]').value = roleDisplay;
            
            // Контактная информация
            form.querySelector('input[name="personal_phone"]').value = employee.Phone || '';
            form.querySelector('input[name="corporate_phone"]').value = employee.corp_phone || '';
            form.querySelector('input[name="personal_email"]').value = employee.personal_email || '';
            form.querySelector('input[name="corporate_email"]').value = employee.corporate_email || '';
            
            // Даты работы
            form.querySelector('input[name="hire_date_display"]').value = employee.hire_date_formatted || '';
            form.querySelector('input[name="fire_date_display"]').value = employee.fire_date_formatted || '';
            form.querySelector('input[name="days_worked"]').value = employee.days_worked || '';
            form.querySelector('input[name="last_corp_number"]').value = employee.last_corp_number || '';
            
            // Дополнительная информация
            form.querySelector('input[name="birth_date_display"]').value = employee.birth_date_formatted || '';
            form.querySelector('input[name="office"]').value = employee.office || '';
            form.querySelector('textarea[name="notes"]').value = employee.notes || '';
            
            // Статусы доступа
            form.querySelector('input[name="rr_access"]').checked = employee.rr == 1;
            form.querySelector('input[name="website_access"]').checked = employee.site == 1;
            form.querySelector('input[name="documents_access"]').checked = employee.documents == 1;
            
            // Системная информация
            form.querySelector('input[name="login"]').value = employee.login || '';
            form.querySelector('input[name="pc_login"]').value = employee.pc_login || '';
            form.querySelector('input[name="crm_id"]').value = employee.crm_id || '';
            form.querySelector('input[name="crm_login"]').value = employee.crm_login || '';
            
            // Фото сотрудника
            if (employee.photo_url) {
                document.getElementById('viewEmployeePhoto').src = employee.photo_url;
            } else {
                document.getElementById('viewEmployeePhoto').src = '/static/img/default-avatar.svg';
            }
            
            // Загружаем историю изменений
            loadEmployeeHistory(employeeId);
        }
    })
    .catch(error => {
        console.error('Ошибка загрузки данных сотрудника:', error);
        alert('Ошибка загрузки данных сотрудника');
    });
}

function toggleHistory() {
    const historyContainer = document.getElementById('historyContainer');
    const historyToggleIcon = document.getElementById('historyToggleIcon');
    const historyToggleText = document.getElementById('historyToggleText');
    
    if (historyContainer.style.display === 'none') {
        historyContainer.style.display = 'block';
        historyToggleIcon.classList.remove('fa-chevron-down');
        historyToggleIcon.classList.add('fa-chevron-up');
        historyToggleText.textContent = 'Скрыть';
        
        // Загружаем историю при первом открытии
        const employeeId = document.getElementById('viewEmployeeForm').querySelector('input[name="employee_id"]').value;
        if (employeeId) {
            loadEmployeeHistory(employeeId);
        }
    } else {
        historyContainer.style.display = 'none';
        historyToggleIcon.classList.remove('fa-chevron-up');
        historyToggleIcon.classList.add('fa-chevron-down');
        historyToggleText.textContent = 'Показать';
    }
}

async function loadEmployeeHistory(employeeId) {
    try {
        const response = await fetch(`/admin/api/get_employee_history?id=${employeeId}`);
        const data = await response.json();
        
        const historyContainer = document.getElementById('employeeHistory');
        
        if (data.success && data.history.length > 0) {
            historyContainer.innerHTML = '';
            
            data.history.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const iconClass = getHistoryIconClass(record.action_type);
                
                historyItem.innerHTML = `
                    <div class="history-icon ${iconClass}">
                        <i class="fas ${getHistoryIcon(record.action_type)}"></i>
                    </div>
                    <div class="history-content">
                        <div class="history-action">${record.description}</div>
                        <div class="history-details">Пользователь: ${record.changed_by_name || 'Система'}</div>
                        <div class="history-timestamp">${record.created_at}</div>
                    </div>
                `;
                
                historyContainer.appendChild(historyItem);
            });
        } else {
            historyContainer.innerHTML = '<div class="text-center text-muted py-3">История действий пуста</div>';
        }
    } catch (error) {
        console.error('Ошибка загрузки истории:', error);
        document.getElementById('employeeHistory').innerHTML = '<div class="text-center text-muted py-3">Ошибка загрузки истории</div>';
    }
}

function getHistoryIconClass(actionType) {
    switch (actionType) {
        case 'created': return 'created';
        case 'updated': return 'updated';
        case 'moved': return 'moved';
        case 'fired': return 'fired';
        case 'restored': return 'restored';
        default: return 'updated';
    }
}

function getHistoryIcon(actionType) {
    switch (actionType) {
        case 'created': return 'fa-user-plus';
        case 'updated': return 'fa-edit';
        case 'moved': return 'fa-exchange-alt';
        case 'fired': return 'fa-user-times';
        case 'restored': return 'fa-user-check';
        default: return 'fa-edit';
    }
}

function rehireEmployee() {
    const employeeId = document.getElementById('viewEmployeeForm').querySelector('input[name="employee_id"]').value;
    
    if (!employeeId) {
        alert('ID сотрудника не найден');
        return;
    }
    
    if (confirm('Вы действительно хотите восстановить этого сотрудника?')) {
        fetch('/admin/rehire_employee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: employeeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Сотрудник успешно восстановлен!');
                closeModal('viewEmployeeModal');
                location.reload(); // Перезагружаем страницу
            } else {
                alert('Ошибка восстановления: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Ошибка восстановления сотрудника:', error);
            alert('Ошибка восстановления сотрудника');
        });
    }
}

function confirmRestoreEmployee() {
    const employeeId = document.getElementById('restoreEmployeeModal').dataset.employeeId;
    const departmentId = document.getElementById('restoreDepartment').value;
    const restoreDate = document.getElementById('restoreDate').value;
    
    if (!departmentId) {
        alert('Выберите отдел для восстановления');
        return;
    }
    
    const data = {
        employee_id: employeeId,
        department_id: departmentId,
        restore_date: restoreDate
    };
    
    fetch('/api/restore_employee', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    });
}

function confirmDeleteEmployee() {
    const employeeId = document.getElementById('deleteEmployeeModal').dataset.employeeId;
    
    fetch('/admin/api/delete_fired_employee_permanently', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ employee_id: employeeId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('deleteEmployeeModal');
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка удаления:', error);
        alert('Произошла ошибка при удалении сотрудника');
    });
}

// Drag and Drop функционал для отделов
let draggedElement = null;
let draggedOverElement = null;

document.querySelectorAll('.department-card').forEach(card => {
    card.addEventListener('dragstart', function(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    });
    
    card.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        draggedElement = null;
        
        // Убираем все классы drag-over
        document.querySelectorAll('.department-card').forEach(c => {
            c.classList.remove('drag-over', 'drag-over-bottom');
        });
    });
    
    card.addEventListener('dragover', function(e) {
        if (draggedElement && draggedElement !== this) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Определяем позицию курсора относительно элемента
            const rect = this.getBoundingClientRect();
            const midPoint = rect.top + rect.height / 2;
            
            // Убираем все классы drag-over
            document.querySelectorAll('.department-card').forEach(c => {
                c.classList.remove('drag-over', 'drag-over-bottom');
            });
            
            this.classList.add('drag-over');
            if (e.clientY > midPoint) {
                this.classList.add('drag-over-bottom');
            }
            
            draggedOverElement = this;
        }
    });
    
    card.addEventListener('drop', function(e) {
        if (draggedElement && draggedElement !== this) {
            e.preventDefault();
            
            const draggedId = draggedElement.dataset.departmentId;
            const targetId = this.dataset.departmentId;
            
            // Определяем позицию (до или после)
            const rect = this.getBoundingClientRect();
            const midPoint = rect.top + rect.height / 2;
            const position = e.clientY > midPoint ? 'after' : 'before';
            
            // Отправляем запрос на сервер
            fetch('/api/update_department_positions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dragged_id: draggedId,
                    target_id: targetId,
                    position: position
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка при перемещении: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при перемещении отдела');
            });
        }
        
        // Убираем все классы drag-over
        document.querySelectorAll('.department-card').forEach(c => {
            c.classList.remove('drag-over', 'drag-over-bottom');
        });
    });
});

// Функции для продвинутых фильтров
function applyFilters() {
    const positionFilters = Array.from(document.querySelectorAll('input[name="position_filter"]:checked')).map(cb => cb.value);
    const departmentFilters = Array.from(document.querySelectorAll('input[name="department_filter"]:checked')).map(cb => cb.value);
    const periodFilters = Array.from(document.querySelectorAll('input[name="period_filter"]:checked')).map(cb => cb.value);
    
    const employees = document.querySelectorAll('tbody tr');
    
    employees.forEach(employee => {
        let shouldShow = true;
        
        // Фильтр по должности
        if (positionFilters.length > 0) {
            const isManager = employee.classList.contains('manager-row');
            const isDeputy = employee.classList.contains('deputy-row');
            
            const matchesPosition = positionFilters.some(filter => {
                if (filter === 'managers' && isManager) return true;
                if (filter === 'deputies' && isDeputy) return true;
                if (filter === 'employees' && !isManager && !isDeputy) return true;
                return false;
            });
            
            if (!matchesPosition) shouldShow = false;
        }
        
        // Фильтр по отделам
        if (departmentFilters.length > 0) {
            const departmentCard = employee.closest('.department-card');
            const departmentId = departmentCard ? departmentCard.dataset.departmentId : null;
            
            if (!departmentId || !departmentFilters.includes(departmentId)) {
                shouldShow = false;
            }
        }
        
        // Фильтр по периоду работы
        if (periodFilters.length > 0) {
            const daysWorked = parseInt(employee.getAttribute('data-days-worked')) || 0;
            
            const matchesPeriod = periodFilters.some(filter => {
                if (filter === 'short' && daysWorked <= 90) return true;
                if (filter === 'medium' && daysWorked > 90 && daysWorked <= 365) return true;
                if (filter === 'long' && daysWorked > 365) return true;
                return false;
            });
            
            if (!matchesPeriod) shouldShow = false;
        }
        
        employee.style.display = shouldShow ? '' : 'none';
    });
    
    // Скрыть пустые отделы
    updateDepartmentVisibility();
    
    closeModal('filtersModal');
}

function resetFilters() {
    document.querySelectorAll('#filtersModal input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    const employees = document.querySelectorAll('tbody tr');
    employees.forEach(employee => {
        employee.style.display = '';
    });
    
    // Показать все отделы
    document.querySelectorAll('.department-card').forEach(dept => {
        dept.style.display = '';
    });
    
    closeModal('filtersModal');
}

function updateDepartmentVisibility() {
    let totalVisible = 0;
    
    document.querySelectorAll('.department-card').forEach(dept => {
        const visibleEmployees = dept.querySelectorAll('tbody tr:not([style*="display: none"])');
        const badge = dept.querySelector('.department-badge');
        
        if (visibleEmployees.length === 0) {
            dept.style.display = 'none';
        } else {
            dept.style.display = '';
            badge.textContent = visibleEmployees.length;
            totalVisible += visibleEmployees.length;
        }
    });
    
    // Обновляем счетчик
    updateEmployeesCounter(totalVisible);
}

function updateEmployeesCounter(visibleCount) {
    const totalCount = parseInt('{{ employees|length }}');
    const countElement = document.getElementById('employeesCount');
    const filteredElement = document.getElementById('filteredCount');
    
    if (visibleCount === totalCount) {
        countElement.textContent = totalCount;
        filteredElement.style.display = 'none';
    } else {
        countElement.textContent = visibleCount;
        filteredElement.textContent = `из ${totalCount}`;
        filteredElement.style.display = 'inline';
    }
}

// Инициализация счетчика при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    updateDepartmentVisibility();
});
</script>
{% endblock %}
