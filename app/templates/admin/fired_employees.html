{% extends "base.html" %}

{% block title %}Уволенные сотрудники{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personnel_clean.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Навигационное меню -->
    <div class="personnel-nav">
        <a href="{{ url_for('admin_routes_unique.personnel') }}">
            <i class="fas fa-users"></i>
            Активные
        </a>
        <a href="{{ url_for('admin_routes_unique.fired_employees') }}" class="active">
            <i class="fas fa-user-times"></i>
            Уволенные
        </a>
        <a href="{{ url_for('admin_routes_unique.personnel_dashboard') }}">
            <i class="fas fa-chart-line"></i>
            Дашборд
        </a>
        <a href="{{ url_for('admin_routes_unique.phone_numbers') }}">
            <i class="fas fa-phone"></i>
            Номера
        </a>
    </div>

    <!-- Статистические карточки -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Всего сотрудников</div>
                <div class="stat-card-value">{{ total_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Активные</div>
                <div class="stat-card-value">{{ active_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-user-times"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Уволенные</div>
                <div class="stat-card-value">{{ fired_employees }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Отделов</div>
                <div class="stat-card-value">{{ departments|length }}</div>
            </div>
        </div>
    </div>

    <!-- Поиск и фильтры -->
    <div class="search-filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Поиск уволенных сотрудников...">
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">
                <i class="fas fa-users"></i>
                Все
            </button>
            <button class="btn btn-secondary" onclick="openModal('filtersModal')">
                <i class="fas fa-filter"></i> Фильтры
            </button>
            <button class="btn btn-primary" id="toggleAllBtn">
                <i class="fas fa-expand-arrows-alt"></i>
                Развернуть все
            </button>
        </div>
    </div>

    <!-- Отделы с уволенными сотрудниками -->
    <div class="departments-container">
        {% set employees_by_department = {} %}
        {% for employee in employees %}
            {% if employee.department_name not in employees_by_department %}
                {% set _ = employees_by_department.update({employee.department_name: []}) %}
            {% endif %}
            {% set _ = employees_by_department[employee.department_name].append(employee) %}
        {% endfor %}

        {% for department in departments|sort(attribute='display_order') %}
            {% if department.name in employees_by_department %}
                {% set department_employees = employees_by_department[department.name] %}
                <div class="department-card" data-department="{{ department.name }}" 
                     draggable="true" data-department-id="{{ department.id }}">
                    <div class="department-header">
                        <div class="department-name">
                    <div class="drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                            {{ department.name }}
                        </div>
                        <div class="department-controls">
                            <div class="department-badge">{{ department_employees|length }}</div>
                            <i class="fas fa-chevron-up department-toggle" data-department="{{ department.id }}"></i>
                        </div>
                    </div>
                    <div class="department-content" id="dept-{{ department.id }}">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ФИО</th>
                                    <th>Должность</th>
                                    <th>Телефон</th>
                                    <th>Email</th>
                                    <th>Дата увольнения</th>
                                    <th>Отработано дней</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in department_employees %}
                                <tr class="{% if employee.role == 'leader' %}manager-row{% elif employee.role == 'deputy' %}deputy-row{% endif %}" 
                                    data-employee="{{ employee.full_name|lower }}"
                                    data-fire-date="{{ employee.fire_date_formatted }}"
                                    data-days-worked="{{ employee.days_worked or 0 }}">
                                    <td>
                                        <strong>{{ employee.full_name }}</strong>
                                        {% if employee.role == 'leader' %}
                                            <span class="text-danger">
                                                <i class="fas fa-crown" title="Руководитель"></i>
                                            </span>
                                        {% elif employee.role == 'deputy' %}
                                            <span class="text-warning">
                                                <i class="fas fa-medal" title="Заместитель"></i>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ employee.position }}</td>
                                    <td>{{ employee.phone or '—' }}</td>
                                    <td>{{ employee.corporate_email or '—' }}</td>
                                    <td>{{ employee.fire_date_formatted }}</td>
                                    <td>{{ employee.days_worked or 'Н/Д' }}</td>
                                    <td>
                                        <div class="action-icons">
                                            <i class="fas fa-eye action-icon view" title="Просмотр" data-employee-id="{{ employee.id }}"></i>
                                            <i class="fas fa-user-plus action-icon restore" title="Восстановить" data-employee-id="{{ employee.id }}"></i>
                                            <i class="fas fa-trash-alt action-icon delete" title="Удалить" data-employee-id="{{ employee.id }}"></i>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Модальное окно для просмотра информации о сотруднике -->
<div class="modal" id="viewEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Информация о сотруднике</h3>
            <button class="modal-close" onclick="closeModal('viewEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <strong>ФИО:</strong> <span id="viewFullName"></span>
                    </div>
                    <div class="form-group">
                        <strong>Должность:</strong> <span id="viewPosition"></span>
                    </div>
                    <div class="form-group">
                        <strong>Отдел:</strong> <span id="viewDepartment"></span>
                    </div>
                    <div class="form-group">
                        <strong>Телефон:</strong> <span id="viewPhone"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <strong>Email:</strong> <span id="viewEmail"></span>
                    </div>
                    <div class="form-group">
                        <strong>Дата найма:</strong> <span id="viewHireDate"></span>
                    </div>
                    <div class="form-group">
                        <strong>Дата увольнения:</strong> <span id="viewFireDate"></span>
                    </div>
                    <div class="form-group">
                        <strong>Отработано дней:</strong> <span id="viewDaysWorked"></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <strong>Причина увольнения:</strong> <span id="viewFireReason"></span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('viewEmployeeModal')">Закрыть</button>
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения восстановления -->
<div class="modal" id="restoreEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Восстановление сотрудника</h3>
            <button class="modal-close" onclick="closeModal('restoreEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы действительно хотите восстановить сотрудника <strong id="restoreEmployeeName"></strong>?</p>
            <div class="form-group">
                <label class="form-label">Отдел для восстановления</label>
                <select class="form-control" id="restoreDepartment" required>
                    <option value="">Выберите отдел</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Дата восстановления</label>
                <input type="date" class="form-control" id="restoreDate" value="{{ current_date }}">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('restoreEmployeeModal')">Отмена</button>
            <button class="btn btn-success" onclick="confirmRestoreEmployee()">Восстановить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для подтверждения удаления -->
<div class="modal" id="deleteEmployeeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Подтверждение удаления</h3>
            <button class="modal-close" onclick="closeModal('deleteEmployeeModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Вы действительно хотите <strong class="text-danger">удалить</strong> сотрудника <strong id="deleteEmployeeName"></strong>?</p>
            <p class="text-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Это действие необратимо. Все данные сотрудника будут удалены навсегда.
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('deleteEmployeeModal')">Отмена</button>
            <button class="btn btn-danger" onclick="confirmDeleteEmployee()">Удалить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для фильтров -->
<div class="modal" id="filtersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Фильтры</h3>
            <button class="modal-close" onclick="closeModal('filtersModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Фильтр по должности</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="position_filter" value="managers" id="filter_managers"> Руководители
                    </label>
                    <label>
                        <input type="checkbox" name="position_filter" value="deputies" id="filter_deputies"> Заместители
                    </label>
                    <label>
                        <input type="checkbox" name="position_filter" value="employees" id="filter_employees"> Сотрудники
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Фильтр по отделам</label>
                <div class="checkbox-group" id="departmentFilters">
                    {% for department in departments %}
                    <label>
                        <input type="checkbox" name="department_filter" value="{{ department.id }}"> {{ department.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Период работы</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="period_filter" value="short" id="filter_short"> До 3 месяцев
                    </label>
                    <label>
                        <input type="checkbox" name="period_filter" value="medium" id="filter_medium"> 3-12 месяцев
                    </label>
                    <label>
                        <input type="checkbox" name="period_filter" value="long" id="filter_long"> Более года
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>
            <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Поиск сотрудников
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const employees = document.querySelectorAll('[data-employee]');
    
    employees.forEach(employee => {
        const name = employee.getAttribute('data-employee');
        if (name.includes(searchTerm)) {
            employee.style.display = '';
        } else {
            employee.style.display = 'none';
        }
    });
    
    // Скрыть отделы без видимых сотрудников
    document.querySelectorAll('.department-card').forEach(dept => {
        const visibleEmployees = dept.querySelectorAll('[data-employee]:not([style*="display: none"])');
        if (visibleEmployees.length === 0) {
            dept.style.display = 'none';
        } else {
            dept.style.display = '';
        }
    });
});

// Фильтрация
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.dataset.filter) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            const employees = document.querySelectorAll('tbody tr');
            
            employees.forEach(employee => {
                const daysWorked = parseInt(employee.getAttribute('data-days-worked')) || 0;
                
                if (filter === 'all') {
                    employee.style.display = '';
                } else if (filter === 'recent' && daysWorked <= 90) {
                    employee.style.display = '';
                } else if (filter === 'long-term' && daysWorked > 90) {
                    employee.style.display = '';
                } else {
                    employee.style.display = 'none';
                }
            });
            
            // Скрыть пустые отделы
            document.querySelectorAll('.department-card').forEach(dept => {
                const visibleEmployees = dept.querySelectorAll('tbody tr:not([style*="display: none"])');
                if (visibleEmployees.length === 0) {
                    dept.style.display = 'none';
                } else {
                    dept.style.display = '';
                }
            });
        }
    });
});

// Сворачивание/разворачивание отделов
document.querySelectorAll('.department-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
        const departmentId = this.dataset.department;
        const content = document.getElementById('dept-' + departmentId);
        
        if (content.style.display === 'none') {
            content.style.display = '';
            this.classList.remove('fa-chevron-down');
            this.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            this.classList.remove('fa-chevron-up');
            this.classList.add('fa-chevron-down');
        }
    });
});

// Развернуть/свернуть все отделы
document.getElementById('toggleAllBtn').addEventListener('click', function() {
    const allExpanded = document.querySelectorAll('.department-toggle.fa-chevron-up').length > 0;
    
    document.querySelectorAll('.department-toggle').forEach(toggle => {
        const departmentId = toggle.dataset.department;
        const content = document.getElementById('dept-' + departmentId);
        
        if (allExpanded) {
            content.style.display = 'none';
            toggle.classList.remove('fa-chevron-up');
            toggle.classList.add('fa-chevron-down');
        } else {
            content.style.display = '';
            toggle.classList.remove('fa-chevron-down');
            toggle.classList.add('fa-chevron-up');
        }
    });
    
    this.innerHTML = allExpanded ? 
        '<i class="fas fa-expand-arrows-alt"></i> Развернуть все' : 
        '<i class="fas fa-compress-arrows-alt"></i> Свернуть все';
});

// Модальные окна
function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Обработчики действий
document.querySelectorAll('.action-icon.view').forEach(icon => {
    icon.addEventListener('click', function() {
        const employeeId = this.dataset.employeeId;
        // Здесь загружаем данные сотрудника
        loadEmployeeData(employeeId);
        openModal('viewEmployeeModal');
    });
});

document.querySelectorAll('.action-icon.restore').forEach(icon => {
    icon.addEventListener('click', function() {
        const employeeId = this.dataset.employeeId;
        const row = this.closest('tr');
        const employeeName = row.querySelector('strong').textContent;
        
        document.getElementById('restoreEmployeeName').textContent = employeeName;
        document.getElementById('restoreEmployeeModal').dataset.employeeId = employeeId;
        openModal('restoreEmployeeModal');
    });
});

document.querySelectorAll('.action-icon.delete').forEach(icon => {
    icon.addEventListener('click', function() {
        const employeeId = this.dataset.employeeId;
        const row = this.closest('tr');
        const employeeName = row.querySelector('strong').textContent;
        
        document.getElementById('deleteEmployeeName').textContent = employeeName;
        document.getElementById('deleteEmployeeModal').dataset.employeeId = employeeId;
        openModal('deleteEmployeeModal');
    });
});

// API функции
function loadEmployeeData(employeeId) {
    fetch(`/api/employee/${employeeId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const employee = data.employee;
            document.getElementById('viewFullName').textContent = employee.full_name;
            document.getElementById('viewPosition').textContent = employee.position;
            document.getElementById('viewDepartment').textContent = employee.department_name;
            document.getElementById('viewPhone').textContent = employee.phone || '—';
            document.getElementById('viewEmail').textContent = employee.corporate_email || '—';
            document.getElementById('viewHireDate').textContent = employee.hire_date_formatted;
            document.getElementById('viewFireDate').textContent = employee.fire_date_formatted;
            document.getElementById('viewDaysWorked').textContent = employee.days_worked || 'Н/Д';
            document.getElementById('viewFireReason').textContent = employee.fire_reason || '—';
        }
    });
}

function confirmRestoreEmployee() {
    const employeeId = document.getElementById('restoreEmployeeModal').dataset.employeeId;
    const departmentId = document.getElementById('restoreDepartment').value;
    const restoreDate = document.getElementById('restoreDate').value;
    
    if (!departmentId) {
        alert('Выберите отдел для восстановления');
        return;
    }
    
    const data = {
        employee_id: employeeId,
        department_id: departmentId,
        restore_date: restoreDate
    };
    
    fetch('/api/restore_employee', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    });
}

function confirmDeleteEmployee() {
    const employeeId = document.getElementById('deleteEmployeeModal').dataset.employeeId;
    
    fetch('/api/delete_employee_permanently', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ employee_id: employeeId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    });
}

// Drag and Drop функционал для отделов
let draggedElement = null;
let draggedOverElement = null;

document.querySelectorAll('.department-card').forEach(card => {
    card.addEventListener('dragstart', function(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    });
    
    card.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        draggedElement = null;
        
        // Убираем все классы drag-over
        document.querySelectorAll('.department-card').forEach(c => {
            c.classList.remove('drag-over', 'drag-over-bottom');
        });
    });
    
    card.addEventListener('dragover', function(e) {
        if (draggedElement && draggedElement !== this) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Определяем позицию курсора относительно элемента
            const rect = this.getBoundingClientRect();
            const midPoint = rect.top + rect.height / 2;
            
            // Убираем все классы drag-over
            document.querySelectorAll('.department-card').forEach(c => {
                c.classList.remove('drag-over', 'drag-over-bottom');
            });
            
            this.classList.add('drag-over');
            if (e.clientY > midPoint) {
                this.classList.add('drag-over-bottom');
            }
            
            draggedOverElement = this;
        }
    });
    
    card.addEventListener('drop', function(e) {
        if (draggedElement && draggedElement !== this) {
            e.preventDefault();
            
            const draggedId = draggedElement.dataset.departmentId;
            const targetId = this.dataset.departmentId;
            
            // Определяем позицию (до или после)
            const rect = this.getBoundingClientRect();
            const midPoint = rect.top + rect.height / 2;
            const position = e.clientY > midPoint ? 'after' : 'before';
            
            // Отправляем запрос на сервер
            fetch('/api/update_department_positions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dragged_id: draggedId,
                    target_id: targetId,
                    position: position
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка при перемещении: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при перемещении отдела');
            });
        }
        
        // Убираем все классы drag-over
        document.querySelectorAll('.department-card').forEach(c => {
            c.classList.remove('drag-over', 'drag-over-bottom');
        });
    });
});

// Функции для продвинутых фильтров
function applyFilters() {
    const positionFilters = Array.from(document.querySelectorAll('input[name="position_filter"]:checked')).map(cb => cb.value);
    const departmentFilters = Array.from(document.querySelectorAll('input[name="department_filter"]:checked')).map(cb => cb.value);
    const periodFilters = Array.from(document.querySelectorAll('input[name="period_filter"]:checked')).map(cb => cb.value);
    
    const employees = document.querySelectorAll('tbody tr');
    
    employees.forEach(employee => {
        let shouldShow = true;
        
        // Фильтр по должности
        if (positionFilters.length > 0) {
            const isManager = employee.classList.contains('manager-row');
            const isDeputy = employee.classList.contains('deputy-row');
            
            const matchesPosition = positionFilters.some(filter => {
                if (filter === 'managers' && isManager) return true;
                if (filter === 'deputies' && isDeputy) return true;
                if (filter === 'employees' && !isManager && !isDeputy) return true;
                return false;
            });
            
            if (!matchesPosition) shouldShow = false;
        }
        
        // Фильтр по отделам
        if (departmentFilters.length > 0) {
            const departmentCard = employee.closest('.department-card');
            const departmentId = departmentCard ? departmentCard.dataset.departmentId : null;
            
            if (!departmentId || !departmentFilters.includes(departmentId)) {
                shouldShow = false;
            }
        }
        
        // Фильтр по периоду работы
        if (periodFilters.length > 0) {
            const daysWorked = parseInt(employee.getAttribute('data-days-worked')) || 0;
            
            const matchesPeriod = periodFilters.some(filter => {
                if (filter === 'short' && daysWorked <= 90) return true;
                if (filter === 'medium' && daysWorked > 90 && daysWorked <= 365) return true;
                if (filter === 'long' && daysWorked > 365) return true;
                return false;
            });
            
            if (!matchesPeriod) shouldShow = false;
        }
        
        employee.style.display = shouldShow ? '' : 'none';
    });
    
    // Скрыть пустые отделы
    updateDepartmentVisibility();
    
    closeModal('filtersModal');
}

function resetFilters() {
    document.querySelectorAll('#filtersModal input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    const employees = document.querySelectorAll('tbody tr');
    employees.forEach(employee => {
        employee.style.display = '';
    });
    
    // Показать все отделы
    document.querySelectorAll('.department-card').forEach(dept => {
        dept.style.display = '';
    });
    
    closeModal('filtersModal');
}

function updateDepartmentVisibility() {
    document.querySelectorAll('.department-card').forEach(dept => {
        const visibleEmployees = dept.querySelectorAll('tbody tr:not([style*="display: none"])');
        const badge = dept.querySelector('.department-badge');
        
        if (visibleEmployees.length === 0) {
            dept.style.display = 'none';
        } else {
            dept.style.display = '';
            badge.textContent = visibleEmployees.length;
        }
    });
}
</script>
{% endblock %}
