{% extends 'base.html' %}

{% block title %}Панель руководителя{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Панель руководителя</h1>
    
    <!-- Статистические карточки -->
    <div class="row">
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Сотрудники</h5>
                    <h2 class="card-text">{{ stats.employees_count }}</h2>
                    <p class="text-muted">Активных: {{ stats.active_employees }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Задачи</h5>
                    <h2 class="card-text">{{ stats.tasks_count }}</h2>
                    <p class="text-muted">Выполнено: {{ stats.completed_tasks }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Средняя активность</h5>
                    <h2 class="card-text">{{ stats.avg_activity }}%</h2>
                    <p class="text-muted">За последние 30 дней</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Новости</h5>
                    <h2 class="card-text">{{ stats.news_count }}</h2>
                    <p class="text-muted">Непрочитанных: {{ stats.unread_news }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Главная таблица -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Сводная таблица отдела</h5>
            <div class="btn-group" role="group">
        <button class="btn btn-outline-primary period-btn" data-period="week">Неделя</button>
                <button class="btn btn-outline-primary period-btn active" data-period="month">Месяц</button>
        <button class="btn btn-outline-primary period-btn" data-period="year">Год</button>
        <button class="btn btn-outline-secondary" id="customRangeBtn">Произвольный период</button>
    </div>
</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <!-- Заголовок будет создан динамически -->
                    </thead>
                    <tbody>
                        <!-- Строки будут созданы динамически -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Последние новости -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Последние новости</h5>
        </div>
        <div class="card-body">
            {% if news %}
                <div class="list-group">
                    {% for item in news %}
                    <a href="{{ url_for('leader.news_detail', news_id=item.id) }}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ item.title }}</h5>
                            <small>{{ item.date_created.strftime('%d.%m.%Y') if item.date_created else '' }}</small>
                        </div>
                        <p class="mb-1">{{ item.content[:100] }}{% if item.content|length > 100 %}...{% endif %}</p>
                        <small>Автор: {{ item.author_name or 'Неизвестно' }}</small>
                    </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Нет новостей для отображения.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для выбора произвольного периода -->
<div class="modal fade" id="customRangeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Выбор произвольного периода</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                    <div class="mb-3">
                    <label for="startDate" class="form-label">Начало периода</label>
                    <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="mb-3">
                    <label for="endDate" class="form-label">Конец периода</label>
                    <input type="date" class="form-control" id="endDate">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="applyCustomRange">Применить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчики периодов
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const period = this.dataset.period;
            
            // Обновляем активную кнопку
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Загружаем новые данные
            loadDashboardData(period);
        });
    });
    
    // Обработчик для кнопки произвольного периода
    document.getElementById('customRangeBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('customRangeModal'));
        modal.show();
    });
    
    document.getElementById('applyCustomRange').addEventListener('click', function() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            alert('Пожалуйста, выберите начальную и конечную дату');
            return;
        }
        
        // Закрываем модальное окно
        bootstrap.Modal.getInstance(document.getElementById('customRangeModal')).hide();
        
        // Загружаем данные за выбранный период
        loadDashboardData('custom', startDate, endDate);
    });
    
    // Функция загрузки данных дашборда
    function loadDashboardData(period, startDate = null, endDate = null) {
        let url = `/leader/api/dashboard_data?period=${period}`;
        
        if (startDate && endDate) {
            url += `&start_date=${startDate}&end_date=${endDate}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDashboard(data);
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки данных:', error);
            });
    }
    
    // Функция обновления данных на дашборде
    function updateDashboard(data) {
        // Обновляем статистические карточки
        document.querySelector('.col-md-3:nth-child(1) h2').textContent = data.stats.employees_count;
        document.querySelector('.col-md-3:nth-child(1) p').textContent = `Активных: ${data.stats.active_employees}`;
        
        document.querySelector('.col-md-3:nth-child(2) h2').textContent = data.stats.tasks_count;
        document.querySelector('.col-md-3:nth-child(2) p').textContent = `Выполнено: ${data.stats.completed_tasks}`;
        
        document.querySelector('.col-md-3:nth-child(3) h2').textContent = `${data.stats.avg_activity}%`;
        document.querySelector('.col-md-3:nth-child(3) p').textContent = 'За выбранный период';
        
        document.querySelector('.col-md-3:nth-child(4) h2').textContent = data.stats.news_count;
        document.querySelector('.col-md-3:nth-child(4) p').textContent = `Непрочитанных: ${data.stats.unread_news}`;
        
        const table = document.querySelector('.table');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        // Создаем заголовок таблицы
        let headerRow = '<tr><th>Сотрудник</th>';
        data.all_fields.forEach(field => {
            if (!data.hidden_fields[field]) {
                headerRow += `<th>${data.field_names[field] || field}</th>`;
            }
        });
        headerRow += '<th>Действия</th></tr>';
        thead.innerHTML = headerRow;

        // Создаем строки таблицы
        data.employees.forEach(employee => {
            let rowHtml = `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-2">
                                <div class="avatar-initial rounded-circle bg-primary">
                                    ${employee.full_name[0]}
                                </div>
                            </div>
                            <div>
                                <a href="/leader/employee_statistics/${employee.id}">
                                    ${employee.full_name}
                                </a>
                            </div>
                        </div>
                    </td>`;
            
            data.all_fields.forEach(field => {
                if (!data.hidden_fields[field]) {
                    if (field === 'activity') {
                         rowHtml += `
                            <td>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" style="width: ${employee[field] || 0}%"></div>
                                </div>
                                ${employee[field] || 0}%
                            </td>`;
                    } else {
                        rowHtml += `<td>${employee[field] || 0}</td>`;
                    }
                }
            });

            rowHtml += `
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-icon" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="/leader/employee_statistics/${employee.id}">
                                        <i class="fas fa-chart-line me-2"></i>Статистика
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/leader/employee_statistics/${employee.id}">
                                        <i class="fas fa-tasks me-2"></i>Задачи
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/leader/impersonate_employee/${employee.id}">
                                        <i class="fas fa-user-secret me-2"></i>Действовать от имени
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>`;
            tbody.innerHTML += rowHtml;
        });
    }
});
</script>
{% endblock %}
