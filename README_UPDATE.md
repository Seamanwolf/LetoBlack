# Обновление структуры базы данных системы Brokers

## Описание обновления

Данное обновление вносит изменения в структуру базы данных системы Brokers, разделяя монолитную таблицу `users` на несколько специализированных таблиц:

1. **Roles** - таблица ролей пользователей
2. **Departments** - таблица отделов компании
3. **User** - основная таблица пользователей
4. **UserActivity** - таблица для отслеживания статусов активности пользователей
5. **CallCenterSettings** - таблица с настройками операторов колл-центра
6. **Notifications** - таблица уведомлений
7. **Scores** - таблица статистики пользователей (без изменений)

Также создано представление **UserFullView**, которое объединяет данные из всех таблиц для удобного доступа.

## Преимущества новой структуры

1. **Улучшенная организация данных**
   - Каждая таблица содержит связанные данные, что облегчает поддержку и развитие
   - Устранено дублирование данных

2. **Повышение производительности**
   - Уменьшение размера основной таблицы пользователей
   - Оптимизированные запросы благодаря разделению данных

3. **Улучшение масштабируемости**
   - Новая структура легче расширяется при добавлении новых атрибутов
   - Изменения в одной таблице не влияют на другие таблицы

4. **Улучшенная целостность данных**
   - Использование внешних ключей для обеспечения ссылочной целостности
   - Валидация данных на уровне базы данных

## Файлы обновления

Обновление включает следующие файлы:

1. `app/db/new_database_schema.sql` - SQL-скрипт для создания новой структуры базы данных
2. `app/migration_script.py` - Скрипт Python для миграции данных из старой БД в новую
3. `app/db/MIGRATION_GUIDE.md` - Руководство по миграции
4. `app/auth/auth_updated.py` - Обновленный модуль аутентификации
5. `app/utils_updated.py` - Обновленные утилиты для работы с базой данных
6. `app/models_updated.py` - Обновленные модели данных
7. `app/db/user_dao_updated.py` - Обновленный класс доступа к данным пользователей
8. `README_UPDATE.md` - Этот файл с описанием изменений

## Процесс обновления

### 1. Подготовка

1. Создайте резервную копию базы данных:

```bash
mysqldump -u [username] -p Brokers > brokers_backup.sql
```

2. Установите необходимые зависимости:

```bash
pip install pymysql python-dotenv werkzeug
```

### 2. Миграция базы данных

Подробные инструкции по миграции базы данных находятся в файле `app/db/MIGRATION_GUIDE.md`.

1. Создайте файл `config.env` с параметрами подключения
2. Создайте новую базу данных и запустите скрипт создания таблиц
3. Запустите скрипт миграции данных

### 3. Обновление кода приложения

После успешной миграции базы данных, замените старые файлы новыми:

1. Замените `app/auth/auth.py` файлом `app/auth/auth_updated.py`
2. Замените `app/utils.py` файлом `app/utils_updated.py`
3. Замените `app/models.py` файлом `app/models_updated.py`
4. Замените `app/db/user_dao.py` файлом `app/db/user_dao_updated.py`

### 4. Тестирование

1. Запустите приложение в тестовом режиме
2. Проверьте работу авторизации и всех основных функций
3. Проверьте работу колл-центра и статусы активности пользователей

### 5. Обновление конфигурации

Обновите файл конфигурации приложения, чтобы использовать новую базу данных:

```ini
[database]
host = 127.0.0.1
port = 3306
user = root
password = password
database = Brokers_New
```

## Возможные проблемы и их решения

### Ошибки миграции данных

Проверьте лог файл `migration.log` для получения подробностей об ошибках.

### Проблемы с аутентификацией

Если возникают проблемы с авторизацией пользователей, проверьте:
- Правильность миграции хэшей паролей
- Соответствие ролей в старой и новой базе данных

### Отсутствие данных о статусах активности

Статусы активности создаются для всех пользователей со значением по умолчанию `offline`. При первом входе пользователя статус изменится на `online`.

## Контакты поддержки

В случае возникновения проблем при обновлении обращайтесь:

- Email: support@example.com
- Телефон: +7 (XXX) XXX-XX-XX 