# Система управления ролями и разрешениями

## Описание

Система управления ролями и разрешениями позволяет гибко настраивать права доступа пользователей к различным модулям приложения. Основные возможности:

- Создание системных (неизменяемых) и пользовательских ролей
- Назначение пользователям нескольких ролей
- Настройка детальных разрешений для каждой роли (просмотр, создание, редактирование, удаление)
- Разграничение доступа к модулям системы на основе ролей и разрешений

## Основные компоненты

### Модели:

1. **Role** - модель роли пользователя
   - Поддерживает системные и пользовательские роли
   - Связана с пользователями и разрешениями

2. **Permission** - модель разрешения на действия в модуле
   - Содержит флаги can_view, can_create, can_edit, can_delete
   - Связана с модулем системы по имени

3. **SystemModule** - модель модуля системы
   - Представляет функциональный модуль, для которого можно настраивать разрешения
   - Содержит информацию для отображения в интерфейсе (название, иконка)

4. **User** - расширенная модель пользователя
   - Поддерживает множественные роли
   - Проверяет разрешения через роли

### Декораторы:

1. **admin_required** - проверяет, имеет ли пользователь роль администратора
2. **role_required** - проверяет наличие конкретной роли у пользователя
3. **permission_required** - проверяет наличие разрешения на действие в модуле

### Функции в шаблонах:

1. **has_permission** - проверяет наличие разрешения у пользователя
2. **has_role** - проверяет наличие роли у пользователя
3. **get_user_roles** - возвращает список ролей пользователя

## Инициализация

Для начальной настройки ролей, модулей и разрешений используйте команду:

```
flask init-roles
```

Эта команда создаст:
- Системные модули (dashboard, users, roles, settings, logs)
- Системные роли (admin, leader, operator, user)
- Пользовательскую роль backoffice
- Разрешения для каждой роли
- Пользователя admin с полными правами

## Использование в коде

### Проверка ролей и разрешений в маршрутах:

```python
from app.decorators import admin_required, role_required, permission_required

@app.route('/admin/panel')
@login_required
@admin_required
def admin_panel():
    return render_template('admin/panel.html')

@app.route('/manager/dashboard')
@login_required
@role_required('manager')
def manager_dashboard():
    return render_template('manager/dashboard.html')

@app.route('/users')
@login_required
@permission_required('users', 'view')
def list_users():
    return render_template('users/list.html')
```

### Проверка в шаблонах:

```html
{% if has_permission('users', 'edit') %}
    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-primary">
        <i class="fas fa-edit"></i> Редактировать
    </a>
{% endif %}

{% if has_role('admin') %}
    <a href="{{ url_for('admin.settings') }}" class="nav-link">
        <i class="fas fa-cogs"></i> Настройки
    </a>
{% endif %}
```

## Управление ролями через интерфейс

Управление ролями доступно в административном интерфейсе по пути `/admin/settings` на вкладке "Роли". Здесь можно:

1. Просматривать список существующих ролей
2. Создавать новые роли
3. Редактировать существующие пользовательские роли
4. Настраивать разрешения для ролей
5. Удалять ненужные роли

## Типы ролей

1. **Системные роли** (is_system=True)
   - admin - полный доступ ко всем функциям
   - leader - доступ к управлению и мониторингу
   - operator - базовые операции в системе
   - user - базовый пользователь с минимальными правами

2. **Бэк-офисные роли** (type='backoffice')
   - Роли для сотрудников с административными функциями
   - Настраиваемые права доступа к модулям

3. **Пользовательские роли** (type='custom')
   - Произвольные роли, созданные администратором
   - Полностью настраиваемые права 